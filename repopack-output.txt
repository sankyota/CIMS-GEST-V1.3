This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repopack on: 2026-01-29T06:46:32.805Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repopack's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

For more information about Repopack, visit: https://github.com/yamadashy/repopack

================================================================
Repository Structure
================================================================
config/database.js
config/jwt.js
db.js
DEPLOY.md
ERROR_HANDLING.md
MIDDLEWARE_README.md
middleware/auth.js
middleware/corsConfig.js
middleware/errorHandler.js
middleware/paramProtection.js
middleware/rateLimiter.js
middleware/requestLogger.js
middleware/validateEnv.js
middleware/validator.js
package.json
public/assets/styles.css
public/auth.js
public/chatbot.js
public/configuracion.html
public/configuracion.js
public/consultar-empleados.html
public/consultar-empleados.js
public/consultar-incidencias.html
public/consultar-incidencias.js
public/index.html
public/login.html
public/login.js
public/registrar-activo.html
public/registrar-activo.js
public/registrar-empleado.html
public/registrar-empleado.js
public/registrar-incidencia.html
public/registrar-incidencia.js
public/registrar-usuario.html
public/registrar-usuario.js
public/ver-activos.html
public/ver-activos.js
public/ver-incidencias.js
README.md
routes/activoRoutes.js
routes/administradorRoutes.js
routes/areaRoutes.js
routes/asignacionesRoutes.js
routes/empleadoRoutes.js
routes/iaRoutes.js
routes/incidenciaRoutes.js
routes/loginRoutes.js
routes/mantenimientoRoutes.js
routes/usuarioRoutes.js
scripts/updatePasswords.js
SECURITY.md
server.js
utils/dbErrorHandler.js
utils/errors.js

================================================================
Repository Files
================================================================

================
File: config/database.js
================
require('dotenv').config();
const mysql = require('mysql2');

const db = mysql.createConnection({
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    port: process.env.DB_PORT || 3306
});

db.connect((err) => {
    if (err) {
        console.error('‚ùå Error conectando a la BD:', err);
        return;
    }
    console.log('‚úÖ Conectado a la base de datos:', process.env.DB_NAME);
});

module.exports = db;

================
File: config/jwt.js
================
require('dotenv').config();

module.exports = {
    SECRET_KEY: process.env.JWT_SECRET,
    EXPIRES_IN: '60m'
};

================
File: db.js
================
//require('./config/database')
const db = require('./config/database');
module.exports = db;

================
File: DEPLOY.md
================
# üöÄ Gu√≠a de Despliegue a Producci√≥n

## ‚úÖ Checklist Pre-Despliegue

### 1. Archivos a Subir (v√≠a SFTP)

**IMPORTANTE**: NO subir estos archivos/carpetas:
- ‚ùå `node_modules/` (se instala en el servidor)
- ‚ùå `.env` (crearlo directamente en el servidor)
- ‚ùå `.git/` (si existe)
- ‚ùå Archivos de log (`*.log`)
- ‚ùå Archivos temporales

**S√ç subir:**
- ‚úÖ Todo el c√≥digo fuente (`.js`, `.html`, `.css`)
- ‚úÖ `package.json` y `package-lock.json`
- ‚úÖ Carpeta `public/` completa
- ‚úÖ Carpeta `routes/` completa
- ‚úÖ Carpeta `config/` completa
- ‚úÖ Carpeta `middleware/` completa
- ‚úÖ Carpeta `scripts/` (opcional, si necesitas ejecutar scripts)
- ‚úÖ `server.js`
- ‚úÖ `db.js`
- ‚úÖ `README.md` (opcional)

### 2. Configuraci√≥n del Servidor

#### A. Instalar Node.js
Aseg√∫rate de tener Node.js instalado (v14 o superior):
```bash
node --version
npm --version
```

#### B. Instalar Dependencias
En el servidor, navega a la carpeta del proyecto y ejecuta:
```bash
npm install --production
```
(O simplemente `npm install` si tambi√©n necesitas devDependencies como nodemon)

#### C. Crear Archivo .env
Crea un archivo `.env` en la ra√≠z del proyecto con:
```env
# Configuraci√≥n de Base de Datos
DB_HOST=tu_host_de_mysql
DB_USER=tu_usuario_mysql
DB_PASSWORD=tu_contrase√±a_mysql
DB_NAME=nombre_de_tu_base_de_datos
DB_PORT=3306

# Configuraci√≥n del Servidor
PORT=3000
NODE_ENV=production # Establecer en 'production' para entorno de producci√≥n
ALLOWED_ORIGINS=https://tu-dominio.com,https://otro-dominio.com # Or√≠genes permitidos para CORS

# Configuraci√≥n JWT (‚ö†Ô∏è CAMBIAR por una clave secreta segura y √∫nica)
JWT_SECRET=tu_clave_secreta_super_segura_aqui
```

**‚ö†Ô∏è IMPORTANTE**: Cambia `JWT_SECRET` por una clave aleatoria y segura en producci√≥n.

#### D. Verificar Base de Datos
- Aseg√∫rate de que la base de datos MySQL est√© accesible desde el servidor
- Verifica que todos los procedimientos almacenados (stored procedures) est√©n creados
- Prueba la conexi√≥n:
```bash
mysql -h DB_HOST -u DB_USER -p DB_NAME
```

### 3. Proceso Manager (Recomendado: PM2)

#### Instalar PM2:
```bash
npm install -g pm2
```

#### Iniciar la aplicaci√≥n:
```bash
pm2 start server.js --name "gestor-activos"
```

#### Comandos √∫tiles de PM2:
```bash
pm2 list              # Ver procesos
pm2 logs gestor-activos  # Ver logs
pm2 restart gestor-activos  # Reiniciar
pm2 stop gestor-activos     # Detener
pm2 save             # Guardar configuraci√≥n
pm2 startup          # Iniciar al arrancar el servidor
```

### 4. Configurar Proxy Reverso (Nginx/Apache) - Opcional pero Recomendado

Si quieres usar un dominio y puerto 80/443, configura Nginx o Apache como proxy reverso.

#### Ejemplo Nginx:
```nginx
server {
    listen 80;
    server_name tu-dominio.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 5. Verificaci√≥n Post-Despliegue

1. **Verificar que el servidor est√© corriendo:**
   ```bash
   curl http://localhost:3000
   ```

2. **Verificar logs:**
   ```bash
   pm2 logs gestor-activos
   # O si no usas PM2:
   tail -f logs/app.log
   ```

3. **Probar la aplicaci√≥n:**
   - Abre el navegador y ve a: `http://tu-servidor:3000`
   - Intenta hacer login
   - Verifica que las rutas funcionen correctamente

## üîß Troubleshooting

### Error: "Cannot find module"
- Ejecuta `npm install` en el servidor
- Verifica que `node_modules/` exista

### Error: "ECONNREFUSED" (Base de Datos)
- Verifica las credenciales en `.env`
- Aseg√∫rate de que MySQL est√© corriendo
- Verifica que el firewall permita conexiones a MySQL

### Error: "Port already in use"
- Cambia el puerto en `.env`
- O mata el proceso: `lsof -ti:3000 | xargs kill -9`

### La aplicaci√≥n no inicia
- Verifica los logs: `pm2 logs` o `node server.js` (directo)
- Verifica que todas las variables de `.env` est√©n configuradas
- Verifica que la base de datos sea accesible

## üìù Notas Importantes

1. **Seguridad:**
   - ‚ö†Ô∏è Cambia `JWT_SECRET` en producci√≥n
   - ‚ö†Ô∏è Usa HTTPS en producci√≥n (certificado SSL)
   - ‚ö†Ô∏è No expongas el archivo `.env` p√∫blicamente
   - ‚ö†Ô∏è Configura Content Security Policy (CSP) en `server.js` para producci√≥n (actualmente desactivado para desarrollo).

2. **Rendimiento:**
   - Usa PM2 o similar para mantener el proceso activo
   - Considera usar un proxy reverso (Nginx/Apache)
   - Configura logs rotativos

3. **Backup:**
   - Haz backup regular de la base de datos
   - Guarda copias del c√≥digo y configuraci√≥n

## üéØ Comandos R√°pidos de Despliegue

```bash
# 1. Subir archivos (desde tu m√°quina local, v√≠a SFTP)
# (Sube todos los archivos excepto node_modules y .env)

# 2. En el servidor:
cd /ruta/a/tu/proyecto
npm install --production
cp .env.example .env  # Si tienes .env.example
nano .env  # Editar variables de entorno
pm2 start server.js --name "gestor-activos"
pm2 save
pm2 startup  # Configurar para iniciar al arrancar
```

¬°Listo! Tu aplicaci√≥n deber√≠a estar corriendo en producci√≥n. üöÄ

================
File: ERROR_HANDLING.md
================
# üõ°Ô∏è Sistema de Manejo de Errores - Documentaci√≥n

## üìä Estado: 10/10

El sistema de manejo de errores est√° completamente implementado y listo para usar.

## üèóÔ∏è Arquitectura

El sistema de manejo de errores tiene tres capas:

1. **Clases de Errores Personalizadas** (`utils/errors.js`)
2. **Utilidades de Base de Datos** (`utils/dbErrorHandler.js`)
3. **Middleware Centralizado** (`middleware/errorHandler.js`)

## üì¶ Componentes

### 1. Clases de Errores Personalizadas

Ubicaci√≥n: `utils/errors.js`

```javascript
const { ValidationError, NotFoundError, DatabaseError } = require('../utils/errors');

// Ejemplo de uso
throw new ValidationError('El campo es requerido');
throw new NotFoundError('Usuario');
throw new DatabaseError('Error al conectar', originalError);
```

#### Clases disponibles:

- **`AppError`** - Clase base para todos los errores personalizados
- **`ValidationError`** (400) - Errores de validaci√≥n
- **`AuthenticationError`** (401) - Errores de autenticaci√≥n
- **`AuthorizationError`** (403) - Errores de autorizaci√≥n
- **`NotFoundError`** (404) - Recurso no encontrado
- **`ConflictError`** (409) - Conflicto (ej: duplicado)
- **`DatabaseError`** (500) - Errores de base de datos

### 2. Utilidades de Base de Datos

Ubicaci√≥n: `utils/dbErrorHandler.js`

#### `handleDatabaseError(error, defaultMessage)`

Convierte errores de MySQL a errores de aplicaci√≥n:

```javascript
const { handleDatabaseError } = require('../utils/dbErrorHandler');

db.query(query, params, (err, results) => {
    if (err) {
        const errorInfo = handleDatabaseError(err);
        // errorInfo.statusCode, errorInfo.message
    }
});
```

**Errores manejados:**
- `ER_DUP_ENTRY` ‚Üí 409 (Conflicto)
- `ER_NO_REFERENCED_ROW_2` ‚Üí 400 (Foreign key)
- `ER_BAD_NULL_ERROR` ‚Üí 400 (Campo nulo)
- `ER_DATA_TOO_LONG` ‚Üí 400 (Datos muy largos)

#### `handleQuery(query, params)`

Wrapper promisificado para queries:

```javascript
const { handleQuery } = require('../utils/dbErrorHandler');

try {
    const results = await handleQuery('SELECT * FROM users WHERE id = ?', [id]);
} catch (error) {
    // Error ya procesado y con statusCode
}
```

### 3. Middleware Centralizado

Ubicaci√≥n: `middleware/errorHandler.js`

#### `errorHandler`

Middleware que captura todos los errores y los formatea:

- **Validaci√≥n**: 400 con detalles
- **Autenticaci√≥n**: 401
- **Autorizaci√≥n**: 403
- **No encontrado**: 404
- **Conflicto**: 409
- **Base de datos**: 500 (oculta detalles en producci√≥n)
- **Gen√©rico**: 500

#### `notFoundHandler`

Captura rutas no encontradas (404)

#### `asyncHandler`

Wrapper para funciones async que captura errores autom√°ticamente:

```javascript
const { asyncHandler } = require('../middleware/errorHandler');

router.get('/ruta', asyncHandler(async (req, res) => {
    // Tu c√≥digo async
    // Los errores se capturan autom√°ticamente
}));
```

## üìù Uso en Rutas

### Ejemplo 1: Usando clases de error

```javascript
const { NotFoundError, ValidationError } = require('../utils/errors');
const { asyncHandler } = require('../middleware/errorHandler');

router.get('/usuarios/:id', asyncHandler(async (req, res) => {
    const { id } = req.params;
    
    if (!id) {
        throw new ValidationError('ID es requerido');
    }
    
    const results = await handleQuery('CALL sp_obtener_usuario(?)', [id]);
    
    if (results[0].length === 0) {
        throw new NotFoundError('Usuario');
    }
    
    res.json(results[0][0]);
}));
```

### Ejemplo 2: Manejo tradicional (callback)

```javascript
const { handleDatabaseError } = require('../utils/dbErrorHandler');

router.get('/activos', (req, res, next) => {
    db.query('CALL ObtenerActivos()', (err, results) => {
        if (err) {
            const errorInfo = handleDatabaseError(err);
            const error = new Error(errorInfo.message);
            error.statusCode = errorInfo.statusCode;
            return next(error); // Pasa al errorHandler
        }
        res.json(results[0]);
    });
});
```

### Ejemplo 3: Validaci√≥n con error personalizado

```javascript
const { ValidationError } = require('../utils/errors');

router.post('/activos', (req, res, next) => {
    const { ItemCode, ItemName } = req.body;
    
    if (!ItemCode) {
        return next(new ValidationError('ItemCode es requerido'));
    }
    
    // Continuar...
});
```

## üîÑ Migraci√≥n de Rutas Existentes

### Antes (Callbacks):

```javascript
router.get('/activos/:id', (req, res) => {
    db.query(query, [id], (err, results) => {
        if (err) {
            console.error('Error:', err);
            return res.status(500).json({ error: 'Error al obtener activo' });
        }
        if (results[0].length === 0) {
            return res.status(404).json({ error: 'Activo no encontrado' });
        }
        res.json(results[0][0]);
    });
});
```

### Despu√©s (Recomendado - Async/Await):

```javascript
const { asyncHandler } = require('../middleware/errorHandler');
const { handleQuery } = require('../utils/dbErrorHandler');
const { NotFoundError } = require('../utils/errors');

router.get('/activos/:id', asyncHandler(async (req, res) => {
    const { id } = req.params;
    const results = await handleQuery('CALL BuscarActivoPorID(?)', [id]);
    
    if (results[0].length === 0) {
        throw new NotFoundError('Activo');
    }
    
    res.json(results[0][0]);
}));
```

### Despu√©s (Callbacks mejorados):

```javascript
const { handleDatabaseError } = require('../utils/dbErrorHandler');
const { NotFoundError } = require('../utils/errors');

router.get('/activos/:id', (req, res, next) => {
    db.query(query, [id], (err, results) => {
        if (err) {
            const errorInfo = handleDatabaseError(err);
            const error = new Error(errorInfo.message);
            error.statusCode = errorInfo.statusCode;
            return next(error);
        }
        if (results[0].length === 0) {
            return next(new NotFoundError('Activo'));
        }
        res.json(results[0][0]);
    });
});
```

## ‚úÖ Caracter√≠sticas

### 1. Manejo Centralizado
- Todos los errores pasan por un solo middleware
- Respuestas consistentes
- Logging centralizado

### 2. Tipos de Error Espec√≠ficos
- C√≥digos HTTP correctos
- Mensajes apropiados
- Detalles cuando es necesario

### 3. Seguridad
- Errores de BD no exponen detalles en producci√≥n
- Stack traces solo en desarrollo
- No se exponen datos sensibles

### 4. Debugging
- Logs detallados en desarrollo
- Stack traces cuando es necesario
- Informaci√≥n contextual (path, method, timestamp)

## üîí Seguridad

### En Producci√≥n:
- ‚ùå No se exponen stack traces
- ‚ùå No se exponen detalles de errores de BD
- ‚ùå No se exponen c√≥digos de error internos
- ‚úÖ Solo mensajes gen√©ricos al cliente

### En Desarrollo:
- ‚úÖ Stack traces completos
- ‚úÖ Detalles de errores de BD
- ‚úÖ Informaci√≥n de debugging

## üìä Respuestas de Error

### Formato Est√°ndar:

```json
{
    "success": false,
    "error": "Mensaje de error"
}
```

### Con Detalles (validaci√≥n):

```json
{
    "success": false,
    "error": "Error de validaci√≥n",
    "details": "Campo requerido"
}
```

## üéØ Mejores Pr√°cticas

1. **Usa clases de error espec√≠ficas**: `NotFoundError` en lugar de `Error` gen√©rico
2. **Pasa errores con `next()`**: No uses `return res.status()`, usa `next(error)`
3. **Usa `asyncHandler`**: Para funciones async, envu√©lvelas con `asyncHandler`
4. **Valida antes de procesar**: Lanza `ValidationError` temprano
5. **No expongas detalles internos**: Deja que `errorHandler` los oculte en producci√≥n

## üìö Ejemplos Completos

Ver ejemplos completos en:
- `routes/loginRoutes.js` (ejemplo de uso actual)
- `middleware/auth.js` (ejemplo de errores de autenticaci√≥n)

## üîÑ Pr√≥ximos Pasos (Opcional)

Para migrar completamente:
1. Convertir callbacks a async/await donde sea posible
2. Usar `asyncHandler` en todas las rutas async
3. Usar clases de error en lugar de errores gen√©ricos
4. Usar `handleQuery` o `handleDatabaseError` en todas las queries

**Nota**: El sistema actual funciona bien con callbacks. Las mejoras son opcionales pero recomendadas.

================
File: MIDDLEWARE_README.md
================
# üìö Documentaci√≥n de Middlewares

Este documento describe todos los middlewares implementados en el sistema.

## üõ°Ô∏è Middlewares de Seguridad

### 1. **Helmet.js** (`server.js`)
- **Ubicaci√≥n**: Aplicado globalmente al inicio
- **Funci√≥n**: Configura headers HTTP seguros
- **Configuraci√≥n**: CSP desactivado para desarrollo (activar en producci√≥n)

### 2. **CORS Config** (`middleware/corsConfig.js`)
- **Ubicaci√≥n**: Aplicado globalmente
- **Funci√≥n**: Control de acceso cross-origin
- **Caracter√≠sticas**:
  - En desarrollo: permite todos los or√≠genes
  - En producci√≥n: usar `ALLOWED_ORIGINS` en `.env`
  - Soporta cookies (credentials: true)

### 3. **Rate Limiting** (`middleware/rateLimiter.js`)
- **generalLimiter**: 100 requests/15min (global)
- **loginLimiter**: 5 intentos/15min (protecci√≥n brute force)
- **createLimiter**: 10 creaciones/min (disponible para uso futuro)

## üîê Middlewares de Autenticaci√≥n

### 1. **authenticateToken** (`middleware/auth.js`)
- **Funci√≥n**: Verifica JWT tokens
- **Ubicaci√≥n de token**: Header `Authorization: Bearer <token>` o cookie `authToken`
- **Respuestas**:
  - 401: Token no proporcionado o inv√°lido
  - 401: Token expirado
- **Agrega**: `req.user` con informaci√≥n del usuario

### 2. **requireAdmin** (`middleware/auth.js`)
- **Funci√≥n**: Verifica permisos de administrador
- **Uso**: Despu√©s de `authenticateToken`
- **Respuesta**: 403 si no es administrador

### 3. **optionalAuth** (`middleware/auth.js`)
- **Funci√≥n**: Autenticaci√≥n opcional (no bloquea si no hay token)
- **Uso**: Para rutas que funcionan con o sin autenticaci√≥n

## üìù Middlewares de Logging

### 1. **requestLogger** (`middleware/requestLogger.js`)
- **Funci√≥n**: Log de todas las requests
- **Informaci√≥n registrada**:
  - M√©todo HTTP
  - Ruta
  - Status code
  - Duraci√≥n
  - IP
  - User Agent
- **Nivel de log**: Solo errores en producci√≥n, todo en desarrollo

## ‚ö†Ô∏è Middlewares de Manejo de Errores

### 1. **errorHandler** (`middleware/errorHandler.js`)
- **Ubicaci√≥n**: Al final, despu√©s de todas las rutas
- **Funci√≥n**: Manejo centralizado de errores
- **Maneja**:
  - Errores de validaci√≥n (400)
  - Errores JWT (401)
  - Errores de base de datos (500)
  - Errores personalizados con statusCode
  - Errores gen√©ricos (500)

### 2. **notFoundHandler** (`middleware/errorHandler.js`)
- **Ubicaci√≥n**: Antes de errorHandler
- **Funci√≥n**: Captura rutas no encontradas (404)

### 3. **asyncHandler** (`middleware/errorHandler.js`)
- **Funci√≥n**: Wrapper para manejar errores async en rutas
- **Uso**: `router.get('/ruta', asyncHandler(async (req, res) => {...}))`

## ‚úÖ Middlewares de Validaci√≥n

### 1. **validateEnv** (`middleware/validateEnv.js`)
- **Ubicaci√≥n**: Se ejecuta al inicio de `server.js`
- **Funci√≥n**: Valida variables de entorno requeridas
- **Variables requeridas**:
  - `DB_HOST`
  - `DB_USER`
  - `DB_PASSWORD`
  - `DB_NAME`
  - `JWT_SECRET`
- **Advertencias**:
  - JWT_SECRET por defecto en producci√≥n
  - PORT no definido

## üìä Orden de Middlewares en server.js

El orden es cr√≠tico. Los middlewares se aplican en este orden:

1. **Helmet** - Seguridad HTTP
2. **CORS** - Control de acceso
3. **Rate Limiting General** - Protecci√≥n DDoS
4. **Body Parsers** - Parsear JSON/URL-encoded
5. **Cookie Parser** - Parsear cookies
6. **Request Logger** - Logging
7. **Static Files** - Archivos est√°ticos
8. **Rutas API** - Rutas de la aplicaci√≥n
9. **Rutas HTML** - P√°ginas HTML
10. **Not Found Handler** - 404
11. **Error Handler** - Manejo de errores

## üîß Configuraci√≥n

### Variables de entorno relacionadas:
```env
NODE_ENV=development|production
ALLOWED_ORIGINS=url1,url2,url3  # Para CORS en producci√≥n
JWT_SECRET=tu_clave_secreta
```

## üìù Uso en Rutas

```javascript
// Ruta p√∫blica
router.get('/public', (req, res) => {...});

// Ruta protegida
router.get('/protected', authenticateToken, (req, res) => {...});

// Ruta solo admin
router.post('/admin', authenticateToken, requireAdmin, (req, res) => {...});

// Ruta con manejo async
router.get('/async', asyncHandler(async (req, res) => {
    // Tu c√≥digo async
}));
```

## ‚úÖ Estado: 10/10

Todos los middlewares esenciales est√°n implementados y funcionando correctamente.

================
File: middleware/auth.js
================
const jwt = require('jsonwebtoken');
const { SECRET_KEY } = require('../config/jwt');

/**
 * Middleware para verificar JWT
 * Extrae el token de Authorization header o de cookies
 */
const authenticateToken = (req, res, next) => {
   
    let token = null;
    
    // Intentar obtener token del header Authorization
    const authHeader = req.headers['authorization'];
    if (authHeader && authHeader.startsWith('Bearer ')) {
        token = authHeader.split(' ')[1];
    } 
    // Si no est√° en header, intentar desde cookie
    else if (req.cookies && req.cookies.authToken) {
        token = req.cookies.authToken;
    }

    if (!token) {
        return res.status(401).json({
            success: false,
            error: 'No autorizado: Token no proporcionado'
        });
    }

    jwt.verify(token, SECRET_KEY, (err, decoded) => {
        if (err) {
            // Diferentes tipos de errores JWT
            if (err.name === 'TokenExpiredError') {
                return res.status(401).json({
                    success: false,
                    error: 'Token expirado'
                });
            }
            if (err.name === 'JsonWebTokenError') {
                return res.status(401).json({
                    success: false,
                    error: 'Token inv√°lido'
                });
            }
            return res.status(401).json({
                success: false,
                error: 'Error al verificar token'
            });
        }

        // Token v√°lido, agregar informaci√≥n del usuario al request
        req.user = decoded;
        next();
    });
};

/**
 * Middleware para requerir permisos de administrador
 * Debe usarse despu√©s de authenticateToken
 */
const requireAdmin = (req, res, next) => {
    if (!req.user) {
        return res.status(401).json({
            success: false,
            error: 'No autorizado: Usuario no autenticado'
        });
    }

    if (!req.user.isAdmin) {
        return res.status(403).json({
            success: false,
            error: 'Acceso denegado: Requiere permisos de administrador'
        });
    }

    next();
};

/**
 * Middleware opcional: Obtener usuario si existe token (no bloquea si no hay)
 * √ötil para rutas que funcionan con o sin autenticaci√≥n
 */
const optionalAuth = (req, res, next) => {
    let token = null;
    
    const authHeader = req.headers['authorization'];
    if (authHeader && authHeader.startsWith('Bearer ')) {
        token = authHeader.split(' ')[1];
    } else if (req.cookies && req.cookies.authToken) {
        token = req.cookies.authToken;
    }

    if (token) {
        jwt.verify(token, SECRET_KEY, (err, decoded) => {
            if (!err) {
                req.user = decoded;
            }
            next();
        });
    } else {
        next();
    }
};
// --- APLICAR TEMA DE COLOR AL CARGAR ---
document.addEventListener("DOMContentLoaded", () => {
    const primary = localStorage.getItem('cims_primary');
    const accent = localStorage.getItem('cims_accent');
    
    if (primary && accent) {
        document.documentElement.style.setProperty('--primary-color', primary);
        document.documentElement.style.setProperty('--accent-color', accent);
    }
});

module.exports = {
    authenticateToken,
    requireAdmin,
    optionalAuth
};

================
File: middleware/corsConfig.js
================
/**
 * Configuraci√≥n de CORS
 */
const corsOptions = {
    origin: function (origin, callback) {
        // Permitir requests sin origin (Postman, aplicaciones m√≥viles, etc.)
        if (!origin) return callback(null, true);

        // En desarrollo, permitir localhost
        if (process.env.NODE_ENV === 'development') {
            return callback(null, true);
        }

        // En producci√≥n, definir or√≠genes permitidos
        const allowedOrigins = process.env.ALLOWED_ORIGINS 
            ? process.env.ALLOWED_ORIGINS.split(',')
            : [];

        if (allowedOrigins.indexOf(origin) !== -1 || allowedOrigins.length === 0) {
            callback(null, true);
        } else {
            callback(new Error('No permitido por CORS'));
        }
    },
    credentials: true, // Permitir cookies
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
    exposedHeaders: ['Authorization'],
    maxAge: 86400 // 24 horas
};

module.exports = corsOptions;

================
File: middleware/errorHandler.js
================
/**
 * Middleware centralizado para manejo de errores
 */
const errorHandler = (err, req, res, next) => {
    // Si la respuesta ya fue enviada, delegar al handler por defecto de Express
    if (res.headersSent) {
        return next(err);
    }

    // Determinar status code
    let statusCode = err.statusCode || err.status || 500;
    let message = err.message || 'Error interno del servidor';

    // Log del error (sin datos sensibles)
    const errorLog = {
        message: err.message,
        statusCode,
        path: req.path,
        method: req.method,
        timestamp: new Date().toISOString(),
        ...(process.env.NODE_ENV === 'development' && {
            stack: err.stack,
            code: err.code
        })
    };

    // Error de validaci√≥n
    if (err.name === 'ValidationError' || statusCode === 400) {
        statusCode = 400;
        console.error('‚ùå Error de validaci√≥n:', errorLog);
        return res.status(statusCode).json({
            success: false,
            error: message,
            ...(err.details && { details: err.details })
        });
    }

    // Error de autenticaci√≥n
    if (err.name === 'AuthenticationError' || err.name === 'JsonWebTokenError') {
        statusCode = 401;
        console.error('‚ùå Error de autenticaci√≥n:', errorLog);
        return res.status(statusCode).json({
            success: false,
            error: message
        });
    }

    // Error de token expirado
    if (err.name === 'TokenExpiredError') {
        statusCode = 401;
        console.error('‚ùå Token expirado:', errorLog);
        return res.status(statusCode).json({
            success: false,
            error: 'Token expirado'
        });
    }

    // Error de autorizaci√≥n
    if (err.name === 'AuthorizationError' || statusCode === 403) {
        statusCode = 403;
        console.error('‚ùå Error de autorizaci√≥n:', errorLog);
        return res.status(statusCode).json({
            success: false,
            error: message
        });
    }

    // Error de recurso no encontrado
    if (err.name === 'NotFoundError' || statusCode === 404) {
        statusCode = 404;
        console.error('‚ùå Recurso no encontrado:', errorLog);
        return res.status(statusCode).json({
            success: false,
            error: message
        });
    }

    // Error de conflicto
    if (err.name === 'ConflictError' || statusCode === 409) {
        statusCode = 409;
        console.error('‚ùå Error de conflicto:', errorLog);
        return res.status(statusCode).json({
            success: false,
            error: message
        });
    }

    // Error de base de datos
    if (err.isDatabase || (err.code && err.code.startsWith('ER_'))) {
        statusCode = 500;
        console.error('‚ùå Error de base de datos:', errorLog);
        
        // En producci√≥n, no exponer detalles del error de BD
        const dbMessage = process.env.NODE_ENV === 'production' 
            ? 'Error interno del servidor' 
            : err.message;

        return res.status(statusCode).json({
            success: false,
            error: dbMessage
        });
    }

    // Error operacional (error conocido)
    if (err.isOperational) {
        console.error('‚ùå Error operacional:', errorLog);
        return res.status(statusCode).json({
            success: false,
            error: message
        });
    }

    // Error de programaci√≥n o desconocido
    console.error('‚ùå Error desconocido:', errorLog);
    res.status(500).json({
        success: false,
        error: process.env.NODE_ENV === 'production' 
            ? 'Error interno del servidor' 
            : message,
        ...(process.env.NODE_ENV === 'development' && {
            stack: err.stack,
            name: err.name
        })
    });
};

/**
 * Middleware para capturar errores 404 (ruta no encontrada)
 */
const notFoundHandler = (req, res, next) => {
    const error = new Error(`Ruta no encontrada: ${req.originalUrl}`);
    error.statusCode = 404;
    next(error);
};

/**
 * Wrapper para manejar errores async en rutas
 */
const asyncHandler = (fn) => {

    return (req, res, next) => {
        Promise.resolve(fn(req, res, next)).catch(next);
    };
};

module.exports = {
    errorHandler,
    notFoundHandler,
    asyncHandler
};

================
File: middleware/paramProtection.js
================
const hpp = require('hpp');

/**
 * Middleware para protecci√≥n contra la poluci√≥n de par√°metros HTTP
 * (HTTP Parameter Pollution - HPP)
 *
 * Evita que atacantes sobrescriban par√°metros de la query con arrays.
 * Por ejemplo: ?sort=price&sort=user podr√≠a ser malicioso si se espera un solo sort.
 */
const paramProtection = hpp();

module.exports = paramProtection;

================
File: middleware/rateLimiter.js
================
const rateLimit = require('express-rate-limit');

/**
 * Rate limiter general para todas las rutas
 */
const generalLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutos
    max: 500, // l√≠mite de 500 requests por ventana
    message: {
        success: false,
        error: 'Demasiadas solicitudes desde esta IP, intenta de nuevo m√°s tarde'
    },
    standardHeaders: true, // Retornar info de rate limit en headers
    legacyHeaders: false,
});

/**
 * Rate limiter estricto para login (protecci√≥n contra brute force)
 */
const loginLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutos
    max: 5, // m√°ximo 5 intentos de login por IP
    message: {
        success: false,
        error: 'Demasiados intentos de login. Intenta de nuevo en 15 minutos'
    },
    skipSuccessfulRequests: true, // No contar requests exitosos
});

/**
 * Rate limiter para rutas de creaci√≥n (POST)
 */
const createLimiter = rateLimit({
    windowMs: 60 * 1000, // 1 minuto
    max: 10, // m√°ximo 10 creaciones por minuto
    message: {
        success: false,
        error: 'Demasiadas solicitudes de creaci√≥n. Intenta de nuevo m√°s tarde'
    },
});

module.exports = {
    generalLimiter,
    loginLimiter,
    createLimiter
};

================
File: middleware/requestLogger.js
================
/**
 * Middleware para logging de requests
 */
const requestLogger = (req, res, next) => {
    const start = Date.now();
    
    // Log cuando termina la request
    res.on('finish', () => {
        const duration = Date.now() - start;
        const logData = {
            method: req.method,
            path: req.originalUrl,
            status: res.statusCode,
            duration: `${duration}ms`,
            ip: req.ip || req.connection.remoteAddress,
            userAgent: req.get('user-agent'),
            timestamp: new Date().toISOString()
        };

        // Solo log en desarrollo o si el status es error
        if (process.env.NODE_ENV === 'development' || res.statusCode >= 400) {
            console.log(`üìù ${logData.method} ${logData.path} ${logData.status} - ${logData.duration}`);
        }
    });

    next();
};

module.exports = requestLogger;

================
File: middleware/validateEnv.js
================
/**
 * Validaci√≥n de variables de entorno requeridas
 * Se ejecuta al inicio de la aplicaci√≥n
 */
const validateEnv = () => {
    const requiredVars = [
        'DB_HOST',
        'DB_USER',
        'DB_PASSWORD',
        'DB_NAME',
        'JWT_SECRET'
    ];

    const missingVars = requiredVars.filter(varName => !process.env[varName]);

    if (missingVars.length > 0) {
        console.error('‚ùå Error: Faltan variables de entorno requeridas:');
        missingVars.forEach(varName => {
            console.error(`   - ${varName}`);
        });
        console.error('\nPor favor, crea un archivo .env con las variables necesarias.');
        console.error('Puedes usar .env.example como referencia.\n');
        process.exit(1);
    }

    // Validaciones adicionales
    if (process.env.JWT_SECRET === 'continental_2025' && process.env.NODE_ENV === 'production') {
        console.warn('‚ö†Ô∏è  ADVERTENCIA: Est√°s usando el JWT_SECRET por defecto en producci√≥n.');
        console.warn('   Esto es un riesgo de seguridad. Cambia JWT_SECRET a una clave √∫nica y segura.\n');
    }

    if (!process.env.PORT) {
        console.warn('‚ö†Ô∏è  PORT no est√° definido, usando puerto 3000 por defecto.\n');
    }

    console.log('‚úÖ Variables de entorno validadas correctamente\n');
};

module.exports = validateEnv;

================
File: middleware/validator.js
================
/**
 * Middleware para validaci√≥n de datos de entrada (ejemplo simple)
 */
const { ValidationError } = require('../utils/errors');

const validate = (schema) => (req, res, next) => {
    try {
        // Validar req.body
        if (schema.body) {
            const { error } = schema.body.validate(req.body, { abortEarly: false });
            if (error) {
                const details = error.details.map(d => d.message).join('; ');
                throw new ValidationError(`Error de validaci√≥n en el cuerpo: ${details}`);
            }
        }

        // Validar req.params
        if (schema.params) {
            const { error } = schema.params.validate(req.params, { abortEarly: false });
            if (error) {
                const details = error.details.map(d => d.message).join('; ');
                throw new ValidationError(`Error de validaci√≥n en par√°metros: ${details}`);
            }
        }

        // Validar req.query
        if (schema.query) {
            const { error } = schema.query.validate(req.query, { abortEarly: false });
            if (error) {
                const details = error.details.map(d => d.message).join('; ');
                throw new ValidationError(`Error de validaci√≥n en query: ${details}`);
            }
        }

        next();
    } catch (error) {
        next(error);
    }
};

module.exports = validate;

================
File: package.json
================
{
  "name": "proyecto",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "bcrypt": "^5.1.1",
    "body-parser": "^1.20.3",
    "bootstrap": "^5.3.3",
    "cookie-parser": "^1.4.7",
    "cors": "^2.8.5",
    "dotenv": "^16.4.7",
    "express": "^4.21.2",
    "express-rate-limit": "^8.2.1",
    "express-session": "^1.18.1",
    "helmet": "^8.1.0",
    "hpp": "^0.2.3",
    "joi": "^18.0.2",
    "jsonwebtoken": "^9.0.2",
    "mysql2": "^3.14.0",
    "openai": "^6.16.0",
    "sweetalert2": "^11.19.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.9"
  }
}

================
File: public/assets/styles.css
================
/* =========================================================
   TUS ESTILOS ORIGINALES (INTACTOS PARA DESKTOP)
   ========================================================= */

/* --- VARIABLES GLOBALES (TEMAS) --- */
:root {
    --primary-color: #2d3e50; /* Color por defecto */
    --accent-color: #415d7b;
    --bg-color: lightgray;
}

/* IMPORTANTE: Aseg√∫rate de que los elementos usen var(--...) */
body, html { background-color: var(--bg-color) !important; }
.navbar { background-color: var(--primary-color) !important; }
.title { color: var(--primary-color) !important; }
.back-button { color: var(--primary-color) !important; }
.data-table th { background-color: var(--primary-color) !important; }

/* Botones */
button.btn, .search-bar button, .chat-button, .chat-header, .btn-update, .pagination-controls button, .btn-export-option {
    background-color: var(--accent-color) !important;
}
.chat-footer button { background-color: var(--accent-color) !important; }
.msg-user { background-color: var(--accent-color) !important; }

/* --- ESTILOS DE LA P√ÅGINA DE CONFIGURACI√ìN --- */
.config-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
}

.config-card {
    background: white;
    width: 250px;
    height: 200px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.3s;
    text-decoration: none;
    color: #333;
    border: 1px solid #eee;
}

.config-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.config-icon { font-size: 50px; margin-bottom: 15px; }
.config-title { font-size: 18px; font-weight: bold; }

/* --- MODAL DE JUEGOS (CANVAS) --- */
#gameCanvas {
    background-color: #000;
    display: block;
    margin: 0 auto;
    border: 2px solid #fff;
}
/* Reset b√°sico */
body, html {
    background-color: lightgray !important;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    text-align: center;
}

/* Contenedor principal */
.container {
    padding: 20px;
}

/* T√≠tulo */
.title {
    font-size: 24px;
    color: #2d3e50;
    margin-bottom: 40px;
}





/* Bot√≥n de regresar */
.back-button {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #333;
    font-size: 16px;
    margin-bottom: 20px;
}

.back-button img {
    width: 20px;
    margin-right: 8px;
}

/* T√≠tulo */
.title {
    font-size: 24px;
    color: #2d3e50;
    margin-bottom: 20px;
}

/* Barra de b√∫squeda */
.search-bar {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

.search-bar input {
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #ccc;
    width: 300px;
}

.search-bar button {
    padding: 10px 20px;
    border: none;
    background-color: #2d3e50;
    color: white;
    border-radius: 20px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.search-bar button:hover {
    background-color: #1c2a3d;
}

.btn-export {
    background-color: #28a745 !important; /* Verde tipo √©xito */
    color: white !important;
    border: none;
    padding: 10px 16px;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-export:hover {
    background-color: #218838 !important;
}


.container {
    margin: auto;
    padding: 20px;
    text-align: center;
}

.back-button {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #333;
    font-size: 16px;
    margin-bottom: 20px;
}

.back-button img {
    width: 20px;
    margin-right: 8px;
}

.title {
    font-size: 24px;
    color: #2d3e50;
    margin-bottom: 20px;
}

form {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 20px;
}

.form-group {
    flex: 1 1 calc(50% - 10px);
    display: flex;
    flex-direction: column;
}

label {
    margin-bottom: 8px;
    font-size: 14px;
    color: #2d3e50;
}

input {
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #ccc;
    width: 100%;
    font-size: 14px;
}

button.btn {
    padding: 10px 20px;
    border: none;
    background-color: #2d3e50;
    color: white;
    border-radius: 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
}

button.btn:hover {
    background-color: #1c2a3d;
}


/* T√≠tulo */
.title {
    font-size: 24px;
    margin-bottom: 20px;
}

/* Estilo de los grupos de formularios */
.form-group {
    margin-bottom: 15px;
    text-align: left;
}

label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #333;
}

input, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
}

textarea {
    resize: none;
    height: 80px;
}

/* Estilo del bot√≥n */
.button-group {
    text-align: center;
    margin-top: 20px;
}

button.btn {
    padding: 10px 20px;
    background-color: #2d3e50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
}

button.btn:hover {
    background-color: #1c2a3d;
}


/* T√≠tulo */
.title {
    font-size: 24px;
    margin-bottom: 20px;
}

/* Secciones */
.incident-section {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 20px;
}

.incident-details, .equipment-details {
    flex: 1;
    border: 1px solid #ccc;
    padding: 20px;
    border-radius: 10px;
    background-color: #f9f9f9;
}

.uppercase {
    text-transform: uppercase;
}

h2 {
    font-size: 18px;
    margin-bottom: 10px;
}

/* Inputs y textarea */
textarea, input {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
    margin-bottom: 15px;
}

textarea {
    resize: none;
    height: 100px;
}

/* Botones */
.button-group {
    display: flex;
    justify-content: center;
    gap: 20px;
}

button.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
}

button.confirm {
    background-color: #28a745;
    color: white;
}

button.confirm:hover {
    background-color: #218838;
}

button.close {
    background-color: #0056b3;
    color: white;
}

button.close:hover {
    background-color: #0056b3;
}

/* Asegurar que los dropdowns de Estado y Moneda tengan el mismo estilo que los inputs */
#estado, #Currency {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    background-color: white;
    appearance: none; /* Oculta el dise√±o nativo del navegador */
    cursor: pointer;
}

/* Asegurar que el `select` tenga un icono de flecha uniforme */
#estado::after, #Currency::after {
    content: "‚ñº";
    position: absolute;
    right: 10px;
    pointer-events: none;
}

/* Opcional: Cambiar el color al hacer clic */
#estado:focus, #Currency:focus {
    border-color: #1e2a36;
    outline: none;
    box-shadow: 0px 0px 5px rgba(30, 42, 54, 0.5);
}


textarea {
    height: 160px !important;
}


#ItemCode, #activo_id, #empleado_id, #usuario_id, #area_id{
width: 100%;
padding: 10px;
margin-bottom: 15px;
border: 1px solid #ccc;
border-radius: 5px;
font-size: 16px;
background-color: white;
appearance: none; /* Oculta el dise√±o nativo del navegador */
cursor: pointer;
}
#empleado {
    width:auto !important;
}

#datos-activo {
    width: auto !important;
}

/* Asegurar que la secci√≥n del bot√≥n ocupe toda la fila */
.button-group {
    display: flex;
    justify-content: center;
    width: 100%;
}

/* Hacer que el bot√≥n ocupe toda la fila */
.button-group button {
    width: 100%;
  
    max-width: 5000px; /* Opcional: Limita el tama√±o m√°ximo del bot√≥n */
    padding: 15px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 1px;
    font-size: 18px;
    cursor: pointer;
    text-align: center;
}



#correo,#contrasena,#administrador{
    width: auto !important;
}


.btn-update {
    background-color: #415d7b;
    color: white;
    border: none;
    padding: 8px 12px;
    margin-top: 5px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s ease-in-out;
}

.btn-update:hover {
    background-color: #0056b3;
}
#administrador{
    height: 38px;
    WIDTH: 485px;
}

#username {
    width: auto;
}

#activo_id ,#descripcion{
    width: revert !important;
}

#descripcion {
    height: 170px !important;
}

/* Reset b√°sico */
body, html {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    text-align: center;
}


/* T√≠tulo */
.title {
    font-size: 24px;
    color: #2d3e50;
    margin-bottom: 20px;
}



/* Barra de b√∫squeda */
.search-bar {
    display: flex;
    align-items: center; /* Centra verticalmente */
    justify-content: center; /* Centra horizontalmente */
    gap: 10px;
    flex-wrap: wrap; /* Se adapta en m√≥viles */
    margin-bottom: 20px;
}

.search-bar label {
    font-size: 16px;
    color: #2d3e50;
    margin: 0;
    margin-bottom: 15px;s
}

.search-bar input {
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #ccc;
    width: 300px;
    font-size: 14px;
}

.search-bar button {
    padding: 10px 20px;
    border: none;
    background-color: #415d7b;
    color: white;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.search-bar button:hover {
    background-color: #0056b3;
}



/* Botones de acci√≥n */
button.btn {
    padding: 10px 20px;
    border: none;
    background-color: #415d7b;
    color: white;
    border-radius: 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
}

button.btn:hover {
    background-color: #0056b3;
}


/* Estilos espec√≠ficos para mobile */
@media screen and (max-width: 768px) {
    
    /* Ajuste del contenedor principal */
    .container {
        max-width: 90%;
        margin: 20px auto;
        padding: 20px;
    }
    
    /* Ajuste del t√≠tulo */
    .title {
        font-size: 20px;
    }
    
    /* Opciones: convertir a columna en lugar de fila */
    .options {
        flex-direction: column;
        align-items: center;
    }
    
    .option {
        width: 90%;
        height: auto;
        padding: 15px;
    }
    
    /* Barra de b√∫squeda ajustada */
    .search-bar {
        flex-direction: column;
        align-items: center;
    }
    
    .search-bar input {
        width: 100%;
    }
    
    .search-bar button {
        width: 100%;
    }
    
    
    
    /* Botones m√°s accesibles en pantallas peque√±as */
    button.btn {
        width: 100%;
        padding: 12px;
    }
}
/* Evitar cambio de color p√∫rpura en los botones al hacer clic */
button.btn, .search-bar button {
    outline: none;
    box-shadow: none;
    -webkit-tap-highlight-color: transparent; /* Evita resaltado en m√≥viles */
    margin-bottom: 15px;
}

button.btn:focus, .search-bar button:focus {
    outline: none;
    box-shadow: none;
    background-color: #0056b3;
}
.btn-iniciar {
    background-color: #28a745;
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 5px;
}

.btn-iniciar:hover {
    background-color: #218838;
}

.btn-finalizar {
    background-color: green;
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.btn-finalizar:hover {
    background-color: #415d7b;
}
.estado-equipo {
    padding: 5px 10px;
    border-radius: 5px;
    font-weight: bold;
}

.estado-equipo.verde {
    background-color: #28a745;
    color: white;
}

.estado-equipo.amarillo {
    background-color: #ffc107;
    color: black;
}
/* üîπ Ajustar el tama√±o de los botones para que sean m√°s peque√±os y proporcionados */
.btn-iniciar, .btn-finalizar {
    width: 75px; /* Reducir el ancho */
    height: 30px; /* Reducir la altura */
    font-size: 12px;
    padding: 5px;
    text-align: center;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

/* üîπ Bot√≥n de Iniciar */
.btn-iniciar {
    background-color: #28a745; /* Verde */
    color: white;
}

.btn-iniciar:hover {
    background-color: #218838;
}

/* üîπ Bot√≥n de Finalizar */
.btn-finalizar {
    background-color: #415d7b; /* Rojo */
    color: white;
}

.btn-finalizar:hover {
    background-color: #c82333;
}

/* üîπ Ocultar el texto de las etiquetas pero mantener el dise√±o */
.estado-equipo {
    color: transparent; /* Oculta el texto pero mantiene el espacio */
    font-size: 0; /* Alternativa para asegurar que no se muestre texto */
}


.table-container {
  overflow-x: auto;
}


.input {
  padding: 8px;
  font-size: 14px;
  width: 300px;
}


#buscador {
    height: 20px !important;
}

/* --- Igualar tama√±o de todos los campos dentro de #register-form --- */
#register-form input,
#register-form select,
#register-form textarea {
    width: 100%;        /* ocupa todo el ancho del .form-group */
    height: 44px;       /* alto uniforme ‚îÄ ajusta si prefieres otra medida */
    box-sizing: border-box;  /* incluye padding/borde en el alto-ancho */
}

/* Opcional: mantiene la coherencia de label + espacio */
#register-form .form-group {
    margin-bottom: 16px;   /* mismo espacio debajo de cada grupo */
}
.btn-gray {
    display: inline-block;
    background-color: #6c757d;
    color: white;
    padding: 8px 16px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-gray:hover {
    background-color: #5a6268;
}
a,
a:visited {
    color: white; /* O el color que uses normalmente, por ejemplo azul oscuro */
    text-decoration: none; /* Si quieres quitar el subrayado */
}






/* =========================================
   ESTILOS DE TABLA (CENTRADA Y FLOTANTE)
   ========================================= */

/* 1. CONTENEDOR PRINCIPAL DE LA TABLA */
.table-container {
    width: 100%;                 /* Ocupa todo el ancho disponible */
    display: flex;               /* Activa el modo flexible */
    justify-content: center;     /* CENTRA horizontalmente la tabla */
    align-items: flex-start;     /* Alinea al top */
    overflow-x: auto;            /* Permite scroll si la pantalla es muy chica */
    padding: 20px;               /* Espacio alrededor para que se vea la sombra */
    box-sizing: border-box;
}

/* 2. LA TABLA (TARJETA) */
.data-table {
    margin: 0 auto;              /* Refuerzo para centrar */
    width: auto;                 /* Se ajusta al contenido (no se estira al 100%) */
    min-width: 600px;            /* Un tama√±o m√≠nimo para que no se vea peque√±a */
    border-collapse: separate;   /* Necesario para bordes redondeados */
    border-spacing: 0;
    
    background-color: #ffffff;
    border-radius: 15px;         /* Esquinas redondeadas */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* Sombra flotante */
    overflow: hidden;            /* Recorta el contenido en las esquinas */
}

/* 3. ENCABEZADOS */
.data-table th {
    background-color: #2d3e50;
    color: white;
    padding: 15px 25px;          /* M√°s padding para aire */
    text-transform: uppercase;
    font-size: 13px;
    letter-spacing: 0.5px;
    border-bottom: 3px solid #415d7b;
    white-space: nowrap;         /* T√≠tulos en una sola l√≠nea */
}

/* 4. CELDAS */
.data-table td {
    padding: 12px 20px;
    border-bottom: 1px solid #eeeeee;
    color: #333;
    font-size: 14px;
    vertical-align: middle;
}

/* Efectos visuales de filas */
.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tr:hover { background-color: #e2e6ea; transition: 0.2s; }

/* 5. INPUTS Y SELECTS DENTRO DE LA TABLA */
.data-table input, 
.data-table select {
    width: auto;
    min-width: 100px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
}

/* Botones internos */
.data-table button {
    margin: 2px;
    font-size: 12px;
}


/* =========================================
   MEN√ö DE OPCIONES (VERSI√ìN FLEXBOX - INFALIBLE)
   ========================================= */

/* 1. EL CONTENEDOR */
.options {
    display: flex;              /* Usamos Flex en vez de Grid */
    flex-wrap: wrap;            /* Si no caben, bajan a la siguiente l√≠nea */
    justify-content: center;    /* CENTRA los elementos horizontalmente */
    gap: 25px;
    
    width: 95%;
    max-width: 1800px;
    margin: 40px auto;
    padding: 10px;
}

/* 2. LAS CAJAS (Cards) */
.option {
    /* FLEXIBILIDAD: */
    flex: 1;                    /* Crece para ocupar el espacio disponible */
    min-width: 280px;           /* Ancho m√≠nimo para no aplastarse */
    max-width: 450px;           /* Ancho m√°ximo para no verse rid√≠culamente anchas */
    
    /* Estilos Visuales */
    background-color: #ffffff;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); 
    border: 1px solid #e0e0e0;
    border-radius: 15px;
    padding: 40px 20px;
    height: 550px;              /* Tu altura fija */
    
    /* Centrado interno */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 0.3s ease;
}

/* 3. IMAGEN Y TEXTO (Igual que antes) */
.option img {
    width: 100px;
    height: 100px;
    object-fit: contain;
    margin-bottom: 20px;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
}

.option p {
    font-size: 16px;
    font-weight: bold;
    color: #2d3e50;
    margin: 0;
    text-align: center;
    text-transform: uppercase;
}

/* HOVER */
.option:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    border-color: #d0d0d0;
}

/* =========================================
   EFECTO HOVER (INTERACCI√ìN)
   ========================================= */
.option:hover {
    /* Al pasar el mouse, sube un poco y la sombra se hace m√°s fuerte */
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25); /* Sombra m√°s oscura */
    border-color: #d0d0d0; /* El borde se oscurece un poco */
}



/* =========================================
   CORRECCI√ìN URGENTE: REGISTRAR EMPLEADO
   ========================================= */

/* 1. Forzamos al formulario a ser una columna vertical de contenedores */
#register-employee-form {
    display: flex !important;
    flex-direction: column !important; /* Asegura que las filas caigan una bajo la otra */
    gap: 25px !important;
    width: 100% !important;
    margin-top: 20px;
}

/* 2. Estilo de las FILAS (.form-row) */
/* Esto obliga a que los campos dentro de "form-row" se pongan lado a lado */
#register-employee-form .form-row {
    display: flex !important;
    flex-direction: row !important; /* Horizontal */
    flex-wrap: nowrap !important;   /* Evita que se caigan si hay espacio */
    gap: 20px !important;
    width: 100% !important;
}

/* 3. Comportamiento de los inputs dentro de la fila */
#register-employee-form .form-group {
    display: flex !important;
    flex-direction: column !important;
    flex: 1 1 auto !important; /* Crece para ocupar el espacio disponible */
    min-width: 0 !important;   /* Evita desbordamientos */
    margin: 0 !important;
}

/* --- REGLAS DE TAMA√ëO ESPEC√çFICAS (Para que se vea profesional) --- */

/* Fila 1: C√≥digo, Nombre, Correo */
/* Hacemos que el C√ìDIGO sea m√°s peque√±o y el NOMBRE/CORREO m√°s grandes */
#register-employee-form .form-row:first-of-type .form-group:nth-child(1) { flex: 1 !important; } /* C√≥digo */
#register-employee-form .form-row:first-of-type .form-group:nth-child(2) { flex: 2 !important; } /* Nombre */
#register-employee-form .form-row:first-of-type .form-group:nth-child(3) { flex: 2 !important; } /* Correo */

/* Fila 2: √Årea, Fecha */
#register-employee-form .form-row:nth-of-type(2) .form-group {
    flex: 1 !important; /* Mitad y mitad */
}

/* 4. Estilos visuales de los inputs (Igualar al otro formulario) */
#register-employee-form input,
#register-employee-form select {
    width: 100% !important;
    height: 45px !important;
    padding: 10px 15px !important;
    border: 1px solid #ccc !important;
    border-radius: 5px !important;
    background-color: white !important;
    box-sizing: border-box !important;
}

/* 5. Bot√≥n Registrar (Azul grande) */
#register-employee-form .button-group {
    width: 100% !important;
    text-align: center;
}

#register-employee-form .btn {
    width: 100% !important;
    background-color: #415d7b !important;
    color: white !important;
    padding: 12px !important;
    border-radius: 20px !important;
    font-size: 16px !important;
    cursor: pointer;
    border: none !important;
}
#register-employee-form .btn:hover { background-color: #0056b3 !important; }

/* 6. Bot√≥n Gris (Consultar) */
.btn-gray {
    display: inline-block;
    background-color: #6c757d;
    color: white;
    padding: 8px 20px;
    border-radius: 5px;
    text-decoration: none;
    margin-bottom: 20px;
    font-size: 14px;
}

/* =========================================
   ADAPTACI√ìN M√ìVIL (SOBRESCRIBIR FILAS)
   ========================================= */
@media screen and (max-width: 768px) {
    #register-employee-form .form-row {
        flex-direction: column !important; /* En m√≥vil, uno debajo del otro */
        gap: 15px !important;
    }
}

/* =========================================
   ESTILO BOT√ìN REGRESAR (General)
   ========================================= */
.back-button {
 
    align-items: center;        /* Centrado vertical */
    gap: 8px;                   /* Espacio entre la flecha y el texto */
    
    font-size: 16px;            /* Tama√±o legible */
    font-weight: 600;           /* Un poco de negrita para destacar */
    color: #2d3e50;             /* Tu color primario (Dark Blue) */
    text-decoration: none;      /* Quita el subrayado feo de los links */
    
    padding: 8px 12px;          /* √Årea de clic c√≥moda */
    border-radius: 8px;         /* Bordes suaves */
    transition: all 0.3s ease;  /* Animaci√≥n suave */
    
    /* Opcional: un fondo muy sutil inicial */
    background-color: transparent; 
    margin-bottom: 20px;        /* Espacio para separarlo del t√≠tulo */
}

/* Efecto Hover (Al pasar el mouse) */
.back-button:hover {
    color: #415d7b;             /* Cambia a tu azul brillante */
    background-color: rgba(0, 123, 255, 0.1); /* Fondo azulito muy suave */
    transform: translateX(-5px); /* Se mueve un poquito a la izquierda */
}

/* Ajuste del emoji o icono si usas <img> */
.back-button img {
    width: 20px;
    height: 20px;
    object-fit: contain;
}



/* =========================================
   NAVBAR (BARRA SUPERIOR)
   ========================================= */
.navbar {
    display: flex;
    justify-content: space-between; /* Separa izquierda y derecha al m√°ximo */
    align-items: center;            /* Centra verticalmente el contenido */
    
    background-color: #2d3e50;      /* Tu color primario oscuro */
    color: white;
    
    padding: 15px 30px;             /* Espacio interno */
    box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* Sombra para que flote sobre el fondo */
    
    /* Opcional: Para que se quede fija al hacer scroll */
    position: sticky;
    top: 0;
    z-index: 1000;                  /* Asegura que est√© siempre encima de todo */
}

/* --- ESTILOS DE LA IZQUIERDA (MARCA) --- */
.navbar-brand {
    font-size: 20px;
    font-weight: bold;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.navbar-brand .version {
    background-color: #415d7b;      /* Tu azul brillante */
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 4px;
    vertical-align: middle;
}

/* --- ESTILOS DE LA DERECHA (LINKS) --- */
.navbar-links {
    display: flex;
    gap: 20px; /* Espacio entre cada bot√≥n */
}

.nav-link {
    color: #ecf0f1;                 /* Blanco suave */
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;                       /* Espacio entre emoji y texto */
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

/* Efecto Hover en los links */
.nav-link:hover {
    background-color: rgba(255, 255, 255, 0.1); /* Fondo blanco transparente */
    color: #ffffff;
    transform: translateY(-2px);    /* Peque√±a elevaci√≥n */
}

/* =========================================
   ADAPTACI√ìN M√ìVIL (NAVBAR)
   ========================================= */
@media screen and (max-width: 768px) {
    .navbar {
        flex-direction: column;     /* Uno debajo del otro en celular */
        padding: 15px;
        gap: 15px;
    }
    
    .navbar-links {
        width: 100%;
        justify-content: space-between; /* Distribuye los iconos */
        gap: 5px;
    }
    
    .nav-link {
        font-size: 12px;            /* Letra m√°s peque√±a */
        padding: 8px;
        flex-direction: column;     /* Icono arriba, texto abajo */
        gap: 4px;
        text-align: center;
    }
    
    /* Opcional: Ocultar texto en m√≥viles muy peque√±os y dejar solo iconos */
    /* .nav-link span { display: none; } */
}


/* =========================================
   PAGINACI√ìN
   ========================================= */
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 20px;
    padding: 10px;
}

.pagination-controls button {
    background-color: #2d3e50; /* Tu azul oscuro */
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}

.pagination-controls button:hover:not(:disabled) {
    background-color: #415d7b; /* Azul brillante al pasar mouse */
}

.pagination-controls button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.pagination-controls span {
    font-weight: bold;
    color: #2d3e50;
}



/* Ajuste para que Select2 se vea igual a tus otros inputs */
.select2-container .select2-selection--single {
    height: 38px !important; /* Ajusta a la altura de tus inputs */
    padding: 5px;
    border: 1px solid #ccc; /* Color de borde igual a tus inputs */
}
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px !important;
}






/* =========================================================
   ADAPTACI√ìN MOBILE (SOLUCI√ìN SIN TOCAR HTML)
   ========================================================= */

@media screen and (max-width: 768px) {

    /* 1. RESET GENERAL DEL CUERPO */
    body, html {
        width: 100%;
        overflow-x: hidden; /* Evita desplazamiento lateral de la web */
        margin: 0;
        padding: 0;
    }

    .container {
        width: 100% !important;
        padding: 10px !important;
        box-sizing: border-box;
        margin: 0 !important;
        max-width: 100vw !important;
    }

    /* 2. FORZAR SCROLL EN LA TABLA (TRUCO CSS) */
    /* Al cambiar display a block, la tabla se comporta como un div con scroll */
    .data-table {
        display: block !important;
        width: 100% !important;
        overflow-x: auto !important; /* Aqu√≠ aparece el scroll */
        -webkit-overflow-scrolling: touch;
        border: none;
    }

    /* Ajuste de celdas para que no se deformen */
    .data-table tbody, 
    .data-table thead, 
    .data-table tr {
        /* Mantiene la estructura interna de la tabla */
        display: table-row-group; 
    }
    
    .data-table thead {
        display: table-header-group;
    }

    .data-table tr {
        display: table-row;
    }

    .data-table th, 
    .data-table td {
        white-space: nowrap; /* Evita que el texto se rompa */
        padding: 10px 5px !important;
        font-size: 13px !important;
    }

    /* Excepci√≥n: Permitir que la descripci√≥n tenga saltos de l√≠nea pero ancho fijo */
    .data-table td:nth-child(4) {
        white-space: normal !important;
        min-width: 250px !important; /* Fuerza un ancho para leer bien */
    }

    /* 3. ARREGLAR BOT√ìN "REGRESAR" */
    .back-button {
        display: flex !important;
        width: 100% !important;
        justify-content: center !important;
        align-items: center !important;
        background-color: #f0f2f5; /* Fondo suave para darle cuerpo */
        padding: 12px 0 !important;
        margin-bottom: 20px !important;
        border-radius: 8px;
        box-sizing: border-box;
        text-decoration: none;
        color: #333;
        font-weight: bold;
    }

    /* 4. ARREGLAR "OPTION" (Ver activos) */
    .option {
        width: 100% !important; /* Ancho completo */
        height: auto !important; /* Altura flexible */
        min-height: auto !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        padding: 20px !important;
        box-sizing: border-box;
        margin-bottom: 15px !important;
    }

    .option img {
        width: 60px !important;
        height: 60px !important;
        margin-bottom: 10px !important;
    }
    
    .option p {
        margin: 0 !important;
        font-size: 16px !important;
    }

    /* 5. SOBRESCRIBIR ESTILOS EN L√çNEA (FILTROS Y BUSCADOR) */
    /* Usamos selectores espec√≠ficos y !important para ganar prioridad */
    
    .search-bar, 
    .filter-bar { /* .filter-bar tiene display: flex en el HTML, esto lo mata */
        display: flex !important;
        flex-direction: column !important;
        width: 100% !important;
        height: auto !important;
        gap: 10px !important;
        margin-top: 10px !important;
        align-items: stretch !important; /* Estira los hijos al 100% */
    }
    
    /* Asegurar que los divs hijos del filter-bar ocupen todo el ancho */
    .filter-bar > div {
        width: 100% !important;
        margin: 0 !important;
    }

    /* Inputs, Selects y Botones al 100% */
    .search-bar input,
    .search-bar button,
    .filter-bar select,
    select {
        width: 100% !important;
        max-width: 100% !important;
        height: 45px !important; /* Altura t√°ctil */
        margin: 0 0 10px 0 !important;
        box-sizing: border-box;
    }

    /* 6. NAVBAR */
    .navbar {
        flex-direction: column !important;
        height: auto !important;
        padding: 15px !important;
    }

    .navbar-links {
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        gap: 10px !important;
        margin-top: 10px !important;
    }
}

/* =========================================================
   PARCHE PARA TABLA "VER ACTIVOS" (Scroll y Botones)
   ========================================================= */

@media screen and (max-width: 768px) {

    /* 1. Forzar scroll en la tabla sin contenedor extra */
    .data-table {
        display: block !important;     /* Convierte la tabla en bloque */
        width: 100% !important;
        overflow-x: auto !important;   /* Activa el scroll horizontal */
        white-space: nowrap !important; /* Evita que las filas se partan */
        padding-bottom: 10px;          /* Espacio para la barra de scroll */
    }

    /* 2. Asegurar que las celdas se comporten correctamente */
    .data-table tbody, 
    .data-table thead, 
    .data-table tr {
        display: table-row-group; /* Mantiene estructura interna */
    }
    
    .data-table tr {
        display: table-row;
    }

    /* 3. ARREGLO CR√çTICO: Select y Bot√≥n en la misma l√≠nea */
    /* Sobrescribimos la regla general de 100% de ancho solo para esta tabla */
    .data-table td select,
    .data-table td .estado-select,
    .data-table td .propietario-select {
        width: auto !important;       /* Deja que ocupe su ancho natural */
        min-width: 120px !important;  /* Ancho m√≠nimo legible */
        max-width: 200px !important;
        display: inline-block !important;
        margin-right: 5px !important;
    }

    .data-table td button.btn-update {
        width: auto !important;       /* El bot√≥n solo ocupa lo que necesita */
        display: inline-block !important;
        padding: 8px 12px !important;
        margin-top: 0 !important;     /* Quita m√°rgenes verticales */
    }

    /* 4. Dar espacio al final de la tabla para que no se corte el √∫ltimo bot√≥n */
    .data-table td:last-child {
        padding-right: 20px !important;
    }
    
    /* 5. Ajuste de filtros superiores (Area, Estado, Asignado) */
    /* Para que no se vean gigantes uno encima de otro, los ponemos m√°s compactos */
    #filtro-area, #filtro-estado, #filtro-asignado {
        margin-bottom: 10px !important;
    }
}

/* =========================================================
   CORRECCI√ìN FINAL: SCROLL TABLA Y BOTONES VISIBLES
   ========================================================= */

@media screen and (max-width: 768px) {

    /* 1. LIBERAR EL CONTENEDOR (CRUCIAL) */
    /* Esto permite que el contenido que se sale (la tabla) no sea "tijeretado" */
    .container {
        overflow: visible !important; 
        width: 100% !important;
        padding: 5px !important; /* Menos padding para ganar espacio */
        margin: 0 !important;
    }

    /* 2. FORZAR EL COMPORTAMIENTO DE BLOQUE DESLIZABLE EN LA TABLA */
    .data-table {
        display: block !important;       /* Convierte la tabla en un bloque contenedor */
        width: 100% !important;          /* Ocupa el ancho del celular */
        min-width: 0 !important;         /* ¬°IMPORTANTE! Anula los 600px de escritorio */
        overflow-x: auto !important;     /* Activa el scroll horizontal */
        border-radius: 1 !important;     /* Quita bordes redondos que a veces ocultan contenido */
        box-shadow: none !important;     /* Quita sombras para limpiar la vista */
    }

    /* 3. ASEGURAR QUE LAS FILAS MANTENGAN SU ANCHO */
    .data-table tbody, 
    .data-table thead, 
    .data-table tr {
        display: table-row-group;
    }
    
    .data-table tr {
        display: table-row;
    }

    .data-table th, 
    .data-table td {
        white-space: nowrap !important;  /* Obliga a que todo est√© en una l√≠nea */
        padding: 12px 10px !important;   /* Espaciado c√≥modo */
    }

    /* 4. ARREGLO ESPEC√çFICO PARA LA COLUMNA DE BOTONES (VER ACTIVOS) */
    /* Esto evita que el bot√≥n "Guardar" se vea gigante o se rompa */
    .data-table td select,
    .data-table td .estado-select,
    .data-table td .propietario-select {
        width: auto !important;          /* Ancho natural del texto */
        min-width: 120px !important;     
        display: inline-block !important;
        vertical-align: middle !important;
        margin-right: 5px !important;
    }

    .data-table td button.btn-update {
        width: auto !important;
        display: inline-block !important;
        vertical-align: middle !important;
        padding: 8px 12px !important;
        margin: 0 !important;
    }

    /* 5. MARGEN EXTRA AL FINAL DE LA TABLA */
    /* Agrega un espacio transparente a la derecha para que el √∫ltimo bot√≥n no quede pegado al borde del celular */
    .data-table td:last-child {
        padding-right: 30px !important;
    }
    
    /* Peque√±o parche visual para que se note que hay scroll */
    .table-container::after {
        content: '‚Üí Desliza para ver m√°s';
        display: block;
        text-align: right;
        font-size: 10px;
        color: #666;
        margin-top: 5px;
    }
}
/* =========================================================
   ESTILOS MOBILE PARA INCIDENCIAS (VERSI√ìN FINAL)
   ========================================================= */

@media screen and (max-width: 768px) {

    /* 1. RESET Y ESTRUCTURA */
    body, html { width: 100%; overflow-x: hidden; }
    .container { width: 100%; padding: 10px; margin: 0; box-sizing: border-box; }

    /* 2. NAVBAR */
    .navbar { flex-direction: column; height: auto; padding: 10px; }
    .navbar-links { flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 10px; }

    /* 3. BARRA DE B√öSQUEDA */
    .search-bar {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 10px;
    }
    .search-bar input, .search-bar button, #btn-exportar-todo {
        width: 100%; height: 45px; margin: 0;
    }

    /* 4. BARRA DE FILTROS (Vertical) */
    .filter-bar {
        display: flex;
        flex-direction: column; /* Uno debajo del otro */
        width: 100%;
        gap: 10px;
        margin-top: 10px;
    }
    .filter-group { width: 100%; }
    #filtro-area, #filtro-estado {
        width: 100%;
        height: 45px;
        background-color: white;
        border: 1px solid #ccc;
    }

    /* 5. TABLA Y MENSAJE DE SCROLL (SANDWICH) */
    
    /* El Padre: Contiene la tabla y el mensaje */
    .table-container {
        display: block;
        width: 100%;
        margin-top: 20px;
    }

    /* La Tabla: Es la que hace scroll */
    .data-table {
        display: block;
        width: 100%;
        overflow-x: auto;    /* Scroll horizontal */
        white-space: nowrap; /* Filas en una l√≠nea */
        border: 1px solid #ddd;
        margin-bottom: 0;
    }

    /* El Mensaje: Se genera AFUERA de la tabla */
    .table-container::after {
        content: '‚Üí Desliza para ver m√°s';
        display: block;
        text-align: right;
        font-size: 11px;
        color: #666;
        padding: 5px 0;
        font-style: italic;
    }

    /* Celdas */
    .data-table th, .data-table td {
        padding: 12px 10px;
        font-size: 13px;
    }
    
    /* Descripci√≥n larga permitida */
    .data-table td:nth-child(4) {
        white-space: normal;
        min-width: 220px;
        text-align: left;
    }
    
    /* Botones de acci√≥n */
    .back-button { width: 100%; justify-content: center; background: #f4f4f4; padding: 10px; margin-bottom: 15px; }
    .btn-iniciar, .btn-finalizar { width: 100%; display: block; margin-bottom: 5px; }
}

/* =========================================================
   ESTILOS MOBILE GLOBALES (PARA TODAS LAS P√ÅGINAS)
   ========================================================= */

@media screen and (max-width: 768px) {

    /* 1. AJUSTES GENERALES */
    body, html { width: 100%; overflow-x: hidden; }
    .container { width: 100%; padding: 10px; margin: 0; box-sizing: border-box; }
    
    /* Navbar, Filtros, Buscadores */
    .navbar { flex-direction: column; height: auto; padding: 10px; }
    .navbar-links { flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 10px; }
    .search-bar, .filter-bar { display: flex; flex-direction: column; width: 100%; gap: 10px; margin-top: 10px; }
    .search-bar input, .search-bar button, select, .btn-export { width: 100%; height: 45px; margin: 0; box-sizing: border-box; }
    .back-button { width: 100%; justify-content: center; background: #f4f4f4; padding: 10px; margin-bottom: 15px; }

    /* --- SISTEMA DE TABLAS CON MENSAJE DE SCROLL (GLOBAL) --- */
    
    /* El Padre: Contiene la tabla y el mensaje */
    .table-container {
        display: block;
        width: 100%;
        margin-top: 15px;
        position: relative; /* Mantiene el orden */
    }

    /* La Tabla: Es la que se mueve */
    .data-table {
        display: block;
        width: 100%;
        overflow-x: auto;    /* Scroll horizontal */
        white-space: nowrap; /* Filas en una l√≠nea */
        border: 1px solid #ddd;
        margin-bottom: 0;    /* Pegado al mensaje de abajo */
        background: white;
    }

    /* EL MENSAJE M√ÅGICO: Aparece autom√°ticamente debajo de cualquier .table-container */
    .table-container::after {
        content: '‚Üí Desliza para ver m√°s';
        display: block;
        text-align: right;
        font-size: 11px;
        color: #666;
        padding: 5px 0;
        font-style: italic;
        width: 100%;
    }

    /* Celdas generales */
    .data-table th, .data-table td {
        padding: 12px 10px;
        font-size: 13px;
        vertical-align: middle;
    }

    /* --- AJUSTES ESPEC√çFICOS PARA QUE NO SE CORTEN LOS BOTONES --- */
    
    /* Parche para columnas de botones (Guardar, Iniciar, etc.) */
    .data-table td:last-child {
        padding-right: 20px; /* Un poco de aire al final */
    }

    /* Botones y Selects DENTRO de las tablas (ej: Ver Activos) */
    .data-table select {
        width: auto !important; /* No ocupen todo el ancho */
        min-width: 100px;
        display: inline-block;
    }
    
    .data-table button, .btn-update {
        width: auto !important; /* Bot√≥n tama√±o natural */
        display: inline-block;
        padding: 8px 12px;
        margin: 2px;
    }
    
    /* Descripci√≥n larga (Incidencias) */
    .data-table td:nth-child(4) {
        white-space: normal;
        min-width: 200px;
        text-align: left;
    }
}

/* =========================================================
   ESTILOS MOBILE CORREGIDOS (SIN DESCUADRE)
   ========================================================= */

@media screen and (max-width: 768px) {

    /* 1. CONTENEDOR PRINCIPAL FIJO */
    body, html { 
        width: 100%; 
        overflow-x: hidden; /* Bloquea scroll lateral de la p√°gina entera */
    }
    
    .container { 
        width: 100vw !important; /* Ancho del viewport */
        max-width: 100% !important;
        padding: 10px !important; 
        margin: 0 !important; 
        box-sizing: border-box;
        overflow: hidden; /* Corta cualquier hijo rebelde */
    }

    /* 2. NAVBAR Y ELEMENTOS DE ARRIBA */
    .navbar { flex-direction: column; padding: 10px; }
    .navbar-links { flex-wrap: wrap; justify-content: center; width: 100%; }
    
    /* Inputs y botones al 100% */
    .search-bar, .filter-bar { display: flex; flex-direction: column; width: 100% !important; gap: 10px; }
    .search-bar input, .search-bar button, select, .btn-export, #btn-exportar-todo { 
        width: 100% !important; height: 45px; margin: 0; box-sizing: border-box; 
    }
    .back-button { width: 100%; justify-content: center; background: #fff; padding: 12px; margin-bottom: 15px; }

    /* 3. ARREGLO DEL CONTENEDOR DE TABLA (TARJETA) */
    .table-container {
        display: block;
        width: 100% !important;
        max-width: 100% !important;
        margin-top: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 0 !important; /* Sin padding para que la tabla llegue al borde */
        overflow: hidden; /* Mantiene las esquinas redondas */
    }

    /* 4. LA TABLA (SCROLL INTERNO SOLAMENTE) */
    .data-table {
        display: block !important;      /* Convertir tabla en bloque */
        width: 100% !important;         /* Ancho del padre */
        min-width: 0 !important;        /* CR√çTICO: Elimina el ancho fijo de escritorio */
        overflow-x: auto !important;    /* Aqu√≠ va el scroll */
        white-space: nowrap;            /* Filas en una l√≠nea */
        border: none !important;
        margin: 0 !important;
    }

    /* 5. MENSAJE "DESLIZA" (Fuera del √°rea de scroll) */
    .table-container::after {
        content: '‚Üí Desliza para ver m√°s';
        display: block;
        text-align: right;
        font-size: 11px;
        color: #888;
        padding: 8px 15px;
        background-color: #fff;
        border-top: 1px solid #f0f0f0;
    }

    /* Ajuste de celdas */
    .data-table th, .data-table td {
        padding: 15px 10px; /* M√°s espacio para el dedo */
        font-size: 13px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    /* Cabecera oscura fija */
    .data-table th {
        background-color: #2d3e50;
        color: white;
        position: sticky; /* Opcional: deja fija la cabecera al hacer scroll vertical */
        top: 0;
    }

    /* Paginaci√≥n */
    .pagination-controls {
        display: flex;
        justify-content: center;
        width: 100%;
        margin-top: 20px;
        padding-bottom: 20px;
    }
}

/* =========================================================
   ESTILOS MOBILE FINAL (TEXTO FUERA DEL CUADRO)
   ========================================================= */

@media screen and (max-width: 768px) {

    /* 1. ESTRUCTURA GENERAL */
    body, html { width: 100%; overflow-x: hidden; }
    
    .container { 
        width: 100vw !important; 
        max-width: 100% !important;
        padding: 10px !important; 
        margin: 0 !important; 
        box-sizing: border-box;
    }

    /* Navbar y elementos superiores */
    .navbar { flex-direction: column; padding: 10px; }
    .navbar-links { flex-wrap: wrap; justify-content: center; width: 100%; gap: 10px; }
    
    .search-bar, .filter-bar { 
        display: flex; flex-direction: column; width: 100% !important; gap: 10px; margin-top: 10px; 
    }
    
    .search-bar input, .search-bar button, select, .btn-export, #btn-exportar-todo { 
        width: 100% !important; height: 45px; margin: 0; box-sizing: border-box; 
    }
    
    .back-button { width: 100%; justify-content: center; background: #fff; padding: 12px; margin-bottom: 15px; }

    /* --- 2. CONTENEDOR TIPO TARJETA (PADRE) --- */
    .table-container {
        display: block;
        width: 100% !important;
        background: white;             /* La tarjeta blanca */
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        padding: 0 !important;
        margin-top: 15px;
        
        /* TRUCO PARA SACAR EL TEXTO FUERA: */
        position: relative !important; /* Necesario para posicionar el texto */
        overflow: visible !important;  /* Permite que el texto salga de la caja */
        margin-bottom: 40px !important; /* Espacio extra abajo para que quepa el texto */
    }

    /* --- 3. LA TABLA CON SCROLL (HIJO) --- */
    .data-table {
        display: block !important;
        width: 100% !important;
        min-width: 0 !important;
        overflow-x: auto !important;   /* El scroll ocurre AQU√ç */
        white-space: nowrap;
        border: none !important;
        margin: 0 !important;
        border-radius: 8px; /* Bordes redondos para la tabla tambi√©n */
    }

    /* --- 4. EL MENSAJE FLOTANTE (FUERA DE LA CAJA) --- */
    .table-container::after {
        content: '‚Üí Desliza para ver m√°s';
        
        /* Posicionamiento para sacarlo del cuadro */
        position: absolute;
        bottom: -25px;        /* Lo empuja 25px hacia abajo */
        right: 5px;           /* Alineado a la derecha */
        
        display: block;
        font-size: 11px;
        color: #666;          /* Color gris oscuro */
        font-style: italic;
        background-color: transparent; /* Sin fondo blanco */
        border: none;
        z-index: 10;
    }

    /* Estilos de celdas */
    .data-table th, .data-table td {
        padding: 15px 10px;
        font-size: 13px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .data-table th {
        background-color: #2d3e50;
        color: white;
    }

    /* Ajuste de botones internos */
    .data-table button, .btn-editar, .btn-guardar {
        display: inline-block;
        padding: 6px 12px;
        margin: 2px;
    }
    
    /* Paginaci√≥n (Ahora queda debajo del texto flotante) */
    .pagination-controls {
        display: flex;
        justify-content: center;
        width: 100%;
        margin-top: 10px;
        padding-bottom: 30px;
    }
}

/* --- ESTILOS DEL CHATBOT CIMS --- */
.chat-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Bot√≥n flotante (Burbuja) */
.chat-button {
    background-color: #415d7b; /* Azul del sistema */
    color: white;
    border: none;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: transform 0.3s ease, background-color 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-button:hover {
    transform: scale(1.05);
    background-color: #0056b3;
}

/* Ventana del Chat */
.chat-window {
    display: none; /* Oculto al inicio */
    width: 340px;
    height: 480px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    flex-direction: column;
    overflow: hidden;
    position: absolute;
    bottom: 80px; /* Encima del bot√≥n */
    right: 0;
    border: 1px solid #e1e1e1;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Cabecera */
.chat-header {
    background: linear-gradient(135deg, #415d7b, #0056b3);
    color: white;
    padding: 15px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #004494;
}

/* Cuerpo de mensajes */
.chat-body {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background-color: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Pie (Input) */
.chat-footer {
    padding: 12px;
    background: white;
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
}

.chat-footer input {
    flex: 1;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 20px;
    outline: none;
    font-size: 14px;
    transition: border-color 0.2s;
}

.chat-footer input:focus {
    border-color: #415d7b;
}

.chat-footer button {
    background: #415d7b;
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.chat-footer button:hover {
    background: #0056b3;
}

/* Burbujas de mensaje */
.msg {
    padding: 10px 14px;
    border-radius: 18px;
    max-width: 85%;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
}

.msg-bot {
    background: #e9ecef;
    color: #333;
    border-bottom-left-radius: 4px;
    align-self: flex-start;
}

.msg-user {
    background: #415d7b;
    color: white;
    border-bottom-right-radius: 4px;
    align-self: flex-end;
}

/* Animaci√≥n de "Escribiendo..." */
.typing-indicator {
    font-style: italic;
    color: #666;
    font-size: 12px;
    margin-left: 10px;
}

/* --- MODAL DE EXPORTACI√ìN --- */
.modal-overlay {
    display: none; /* Oculto por defecto */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro transparente */
    z-index: 10000; /* Por encima de todo, incluso del chat */
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 15px;
    width: 300px;
    text-align: center;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    position: relative;
    animation: popIn 0.3s ease;
}

@keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.close-modal {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    transition: color 0.2s;
}

.close-modal:hover { color: #333; }

.export-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.btn-export-option {
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
    font-weight: bold;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-pdf { background-color: #dc3545; } /* Rojo PDF */
.btn-excel { background-color: #28a745; } /* Verde Excel */

.btn-export-option:hover {
    transform: translateY(-2px);
    opacity: 0.9;
}

================
File: public/auth.js
================
// --- GESTI√ìN DE TOKEN Y AUTENTICACI√ìN ---
const getToken = () => localStorage.getItem('token');

const setAuthHeader = (headers = {}) => {
    const token = getToken();
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    } else {
        console.warn("No se encontr√≥ token para setAuthHeader");
    }
    return headers;
};

const logout = () => {
    console.log("Cerrando sesi√≥n...");
    localStorage.removeItem('token');
    // Limpiar cookies tambi√©n por seguridad
    document.cookie = 'authToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
    window.location.href = "/login.html";
};

const checkAuth = async () => {
    const token = getToken();
    if (!token) {
        console.log("No hay token, redirigiendo a login");
        // Si no estamos ya en el login, redirigir
        if (!window.location.pathname.includes('login.html')) {
            window.location.href = "/login.html";
        }
        return null;
    }
    try {
        const response = await fetch("/api/user", {
            headers: setAuthHeader()
        });
        if (!response.ok) {
            throw new Error('Token inv√°lido o expirado');
        }
        return await response.json();
    } catch (error) {
        console.error("Error sesi√≥n:", error);
        logout();
        return null;
    }
};


// Se ejecuta autom√°ticamente apenas se carga este archivo
(function aplicarTemaGuardado() {
    const primary = localStorage.getItem('cims_primary');
    const accent = localStorage.getItem('cims_accent');
    
    if (primary && accent) {
        // Aplicamos los colores al documento entero
        document.documentElement.style.setProperty('--primary-color', primary);
        document.documentElement.style.setProperty('--accent-color', accent);
    }
})();

================
File: public/chatbot.js
================
document.addEventListener("DOMContentLoaded", () => {
    // 1. Inyectar el HTML del chat en la p√°gina
    const chatHTML = `
        <div class="chat-widget">
            <div class="chat-window" id="chatWindow">
                <div class="chat-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span>ü§ñüò∫</span>
                        <span>Asistente CIaMS</span>
                    </div>
                    <button id="closeChat" title="Cerrar chat" style="background:none;border:none;color:white;cursor:pointer;font-size:18px;">&times;</button>
                </div>
                <div class="chat-body" id="chatBody">
                    <div class="msg msg-bot">
                        Hola üëã. Soy CIaMS-BOT. <br>
                        Puedo ayudarte con activos, incidencias, empleados o dudas del sistema. ¬øQu√© necesitas?
                    </div>
                </div>
                <div class="chat-footer">
                    <input type="text" id="chatInput" placeholder="Escribe tu pregunta..." autocomplete="off" />
                    <button id="sendChat">‚û§</button>
                </div>
            </div>
            <button class="chat-button" id="toggleChat" title="Ayuda IA">üí¨</button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', chatHTML);

    // 2. Referencias a elementos
    const toggleBtn = document.getElementById("toggleChat");
    const closeBtn = document.getElementById("closeChat");
    const chatWindow = document.getElementById("chatWindow");
    const chatBody = document.getElementById("chatBody");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendChat");

    let isOpen = false;

    // 3. Funciones
    const toggleChat = () => {
        isOpen = !isOpen;
        chatWindow.style.display = isOpen ? "flex" : "none";
        toggleBtn.style.display = isOpen ? "none" : "flex"; // Oculta burbuja al abrir
        if (isOpen) {
            chatInput.focus();
            scrollToBottom();
        }
    };

    const closeChatMain = () => {
        isOpen = false;
        chatWindow.style.display = "none";
        toggleBtn.style.display = "flex";
    };

    const appendMessage = (text, sender) => {
        const div = document.createElement("div");
        div.classList.add("msg", sender === "user" ? "msg-user" : "msg-bot");
        // Permitir saltos de l√≠nea y negritas simples
        div.innerHTML = text.replace(/\n/g, "<br>").replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
        chatBody.appendChild(div);
        scrollToBottom();
    };

    const scrollToBottom = () => {
        chatBody.scrollTop = chatBody.scrollHeight;
    };

    const sendMessage = async () => {
        const text = chatInput.value.trim();
        if (!text) return;

        // 1. Mostrar mensaje usuario
        appendMessage(text, "user");
        chatInput.value = "";

        // 2. Indicador de carga
        const loadingId = "loading-" + Date.now();
        const loadingDiv = document.createElement("div");
        loadingDiv.id = loadingId;
        loadingDiv.className = "msg msg-bot";
        loadingDiv.innerHTML = "<i>Escribiendo...</i>";
        chatBody.appendChild(loadingDiv);
        scrollToBottom();

        try {
            // 3. Petici√≥n al Backend 
            const response = await fetch('/api/chat-guia', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mensaje: text })
            });

            const data = await response.json();
            
            // 4. Quitar loading y mostrar respuesta
            document.getElementById(loadingId).remove();
            
            if (data.error) {
                appendMessage("‚ö†Ô∏è " + data.error, "bot");
            } else {
                appendMessage(data.respuesta, "bot");
            }

        } catch (error) {
            document.getElementById(loadingId).remove();
            console.error(error);
            appendMessage("‚ùå Error de conexi√≥n. Intenta de nuevo.", "bot");
        }
    };

    // 4. Eventos
    toggleBtn.addEventListener("click", toggleChat);
    closeBtn.addEventListener("click", closeChatMain);
    
    sendBtn.addEventListener("click", sendMessage);
    
    chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });
});

================
File: public/configuracion.html
================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n del Sistema</title>
    <link rel="stylesheet" href="assets/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>

    <div class="container">
        <a href="/" class="back-button">‚¨ÖÔ∏è Regresar al Inicio</a>
        <h1 class="title">‚öôÔ∏è Configuraci√≥n y Herramientas</h1>

        <div class="config-grid">
            
            <div class="config-card" id="card-usuarios">
                <div class="config-icon">üë•</div>
                <div class="config-title">Gesti√≥n de Usuarios</div>
                <small>Crear nuevos accesos</small>
            </div>

            <div class="config-card" id="card-colores">
                <div class="config-icon">üé®</div>
                <div class="config-title">Temas y Colores</div>
                <small>Personaliza la interfaz</small>
            </div>

            <div class="config-card" id="card-version">
                <div class="config-icon">‚ÑπÔ∏è</div>
                <div class="config-title">Acerca de CIMS</div>
                <small>Versi√≥n y Cr√©ditos</small>
            </div>

            <div class="config-card" id="card-juegos">
                <div class="config-icon">üïπÔ∏è</div>
                <div class="config-title">Zona Arcade</div>
                <small>Arcade</small>
            </div>

        </div>
    </div>

    <div id="gameModal" class="modal-overlay">
        <div class="modal-content" style="width: 500px; height: auto;">
            <span class="close-modal" id="close-game">&times;</span>
            <h3 id="gameTitle">Juego</h3>
            <div id="gameContainer">
    <p>Selecciona un juego:</p>
    <button class="btn" id="btn-snake">üêç Snake</button>
    <button class="btn" id="btn-pong" style="background-color: #e67e22 !important;">üèì Pong</button>
</div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="configuracion.js"></script>
    <script src="chatbot.js"></script>
</body>
</html>

================
File: public/configuracion.js
================
document.addEventListener("DOMContentLoaded", async () => {
    // 1. Verificar autenticaci√≥n
    if (typeof checkAuth === 'function') {
        const userData = await checkAuth();
        if (!userData) window.location.href = "/login.html";
    }
    
    // 2. Aplicar tema guardado
    aplicarTemaGuardado();

    // 3. LISTENERS (Conectamos los IDs del HTML con las funciones aqu√≠)
    
    // Tarjeta Usuarios
    const cardUsuarios = document.getElementById("card-usuarios");
    if (cardUsuarios) {
        cardUsuarios.addEventListener("click", () => {
            window.location.href = 'registrar-usuario.html';
        });
    }

    // Tarjeta Colores
    const cardColores = document.getElementById("card-colores");
    if (cardColores) {
        cardColores.addEventListener("click", abrirSelectorColor);
    }

    // Tarjeta Versi√≥n
    const cardVersion = document.getElementById("card-version");
    if (cardVersion) {
        cardVersion.addEventListener("click", mostrarVersion);
    }

    // Tarjeta Juegos
    const cardJuegos = document.getElementById("card-juegos");
    if (cardJuegos) {
        cardJuegos.addEventListener("click", abrirMenuJuegos);
    }

    // Bot√≥n Cerrar Juego (Modal)
    const btnCloseGame = document.getElementById("close-game");
    if (btnCloseGame) {
        btnCloseGame.addEventListener("click", cerrarJuego);
    }

    // Botones de Juegos (Delegaci√≥n de eventos)
    const gameContainer = document.getElementById("gameContainer");
    if (gameContainer) {
        gameContainer.addEventListener("click", (e) => {
            // JUEGO 1: SNAKE
            if (e.target.id === "btn-snake") {
                iniciarSnake();
            }
            // JUEGO 2: PONG (NUEVO)
            if (e.target.id === "btn-pong") {
                iniciarPong();
            }
        });
    }
});

// --- FUNCIONES DE L√ìGICA ---

// 1. SELECTOR DE COLOR
function abrirSelectorColor() {
    Swal.fire({
        title: 'üé® Elige el color principal',
        html: `
            <div style="display:flex; justify-content:center; gap:10px; margin-top:10px;">
                <div class="color-option" data-p="#2d3e50" data-a="#415d7b" style="width:40px; height:40px; background:#2d3e50; cursor:pointer; border-radius:50%; border:2px solid #ccc;"></div>
                <div class="color-option" data-p="#8e44ad" data-a="#9b59b6" style="width:40px; height:40px; background:#8e44ad; cursor:pointer; border-radius:50%; border:2px solid #ccc;"></div>
                <div class="color-option" data-p="#c0392b" data-a="#e74c3c" style="width:40px; height:40px; background:#c0392b; cursor:pointer; border-radius:50%; border:2px solid #ccc;"></div>
                <div class="color-option" data-p="#16a085" data-a="#1abc9c" style="width:40px; height:40px; background:#16a085; cursor:pointer; border-radius:50%; border:2px solid #ccc;"></div>
            </div>
            <p style="margin-top:15px; font-size:12px;">El cambio se guardar√° en tu navegador.</p>
        `,
        showConfirmButton: false,
        didOpen: () => {
            const opciones = Swal.getHtmlContainer().querySelectorAll('.color-option');
            opciones.forEach(el => {
                el.addEventListener('click', () => {
                    cambiarColor(el.dataset.p, el.dataset.a);
                    Swal.close();
                });
            });
        }
    });
}

function cambiarColor(primary, accent) {
    document.documentElement.style.setProperty('--primary-color', primary);
    document.documentElement.style.setProperty('--accent-color', accent);
    localStorage.setItem('cims_primary', primary);
    localStorage.setItem('cims_accent', accent);
    
    Swal.fire({
        icon: 'success',
        title: 'Tema Actualizado',
        timer: 1000,
        showConfirmButton: false
    });
}

function aplicarTemaGuardado() {
    const primary = localStorage.getItem('cims_primary');
    const accent = localStorage.getItem('cims_accent');
    if (primary && accent) {
        document.documentElement.style.setProperty('--primary-color', primary);
        document.documentElement.style.setProperty('--accent-color', accent);
    }
}

// 2. VERSI√ìN
function mostrarVersion() {
    Swal.fire({
        title: 'üñ•Ô∏è CIMS GESTOR',
        html: `
            <h3>Versi√≥n 1.3.0 (Stable)</h3>
            <p>Build: 2026/01</p>
            <hr>
            <p><strong>Desarrollado por:</strong> CIaMS Team</p>
            <p><strong>Stack:</strong> Node.js, Express, MySQL, AI</p>
        `,
        icon: 'info'
    });
}

// 3. JUEGOS
let gameInterval;

function abrirMenuJuegos() {
    const modal = document.getElementById('gameModal');
    if(modal) modal.style.display = 'flex';
}

function cerrarJuego() {
    const modal = document.getElementById('gameModal');
    if(modal) modal.style.display = 'none';
    
    clearInterval(gameInterval); // Detener loop del juego
    
    // Restaurar men√∫ inicial (Ahora con los dos botones)
    const container = document.getElementById('gameContainer');
    if(container) {
        container.innerHTML = `
            <p>Selecciona un juego:</p>
            <button class="btn" id="btn-snake">üêç Snake</button>
            <button class="btn" id="btn-pong" style="background-color: #e67e22 !important;">üèì Pong</button>
        `;
        document.getElementById('gameTitle').innerText = "Juego";
    }
}

// --- JUEGO 1: SNAKE ---
function iniciarSnake() {
    const container = document.getElementById('gameContainer');
    document.getElementById('gameTitle').innerText = "üêç Snake (Usa flechas)";
    container.innerHTML = '<canvas id="gameCanvas" width="300" height="300"></canvas>';
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const box = 15;
    let snake = [{ x: 9 * box, y: 10 * box }];
    let direction = "RIGHT";
    let food = { x: Math.floor(Math.random() * 19 + 1) * box, y: Math.floor(Math.random() * 19 + 1) * box };
    let score = 0;

    // Control de teclado
    const keyHandler = (event) => {
        if (event.keyCode == 37 && direction != "RIGHT") direction = "LEFT";
        else if (event.keyCode == 38 && direction != "DOWN") direction = "UP";
        else if (event.keyCode == 39 && direction != "LEFT") direction = "RIGHT";
        else if (event.keyCode == 40 && direction != "UP") direction = "DOWN";
    };
    
    document.addEventListener("keydown", keyHandler);

    function draw() {
        if (!document.getElementById('gameCanvas')) {
            clearInterval(gameInterval);
            document.removeEventListener("keydown", keyHandler);
            return;
        }

        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (let i = 0; i < snake.length; i++) {
            ctx.fillStyle = (i == 0) ? "green" : "white";
            ctx.fillRect(snake[i].x, snake[i].y, box, box);
        }

        ctx.fillStyle = "red";
        ctx.fillRect(food.x, food.y, box, box);

        let snakeX = snake[0].x;
        let snakeY = snake[0].y;

        if (direction == "LEFT") snakeX -= box;
        if (direction == "UP") snakeY -= box;
        if (direction == "RIGHT") snakeX += box;
        if (direction == "DOWN") snakeY += box;

        if (snakeX == food.x && snakeY == food.y) {
            score++;
            food = { x: Math.floor(Math.random() * 19 + 1) * box, y: Math.floor(Math.random() * 19 + 1) * box };
        } else {
            snake.pop();
        }

        let newHead = { x: snakeX, y: snakeY };

        if (snakeX < 0 || snakeX >= canvas.width || snakeY < 0 || snakeY >= canvas.height || collision(newHead, snake)) {
            clearInterval(gameInterval);
            document.removeEventListener("keydown", keyHandler);
            Swal.fire("Game Over", "Puntuaci√≥n: " + score, "error").then(() => cerrarJuego());
        }

        snake.unshift(newHead);
    }

    function collision(head, array) {
        for (let i = 0; i < array.length; i++) {
            if (head.x == array[i].x && head.y == array[i].y) return true;
        }
        return false;
    }

    clearInterval(gameInterval);
    gameInterval = setInterval(draw, 100);
}

// --- JUEGO 2: PONG ---
function iniciarPong() {
    const container = document.getElementById('gameContainer');
    document.getElementById('gameTitle').innerText = "üèì Pong vs CPU (Usa W y S)";
    container.innerHTML = '<canvas id="gameCanvas" width="400" height="300"></canvas>';
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Elementos del juego
    const user = { x: 0, y: canvas.height/2 - 50, width: 10, height: 100, color: "white", score: 0 };
    const com = { x: canvas.width - 10, y: canvas.height/2 - 50, width: 10, height: 100, color: "white", score: 0 };
    const ball = { x: canvas.width/2, y: canvas.height/2, radius: 10, speed: 5, velocityX: 5, velocityY: 5, color: "#e74c3c" };
    const net = { x: (canvas.width - 2)/2, y: 0, width: 2, height: 10, color: "white" };

    function drawRect(x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
    }

    function drawArc(x, y, r, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI*2, true);
        ctx.closePath();
        ctx.fill();
    }

    function drawNet() {
        for(let i = 0; i <= canvas.height; i+=15) {
            drawRect(net.x, net.y + i, net.width, net.height, net.color);
        }
    }

    function drawText(text, x, y) {
        ctx.fillStyle = "#FFF";
        ctx.font = "35px sans-serif";
        ctx.fillText(text, x, y);
    }

    // Control del mouse
    const mouseHandler = (evt) => {
        if (!document.getElementById('gameCanvas')) return;
        let rect = canvas.getBoundingClientRect();
        user.y = evt.clientY - rect.top - user.height/2;
    };
    canvas.addEventListener("mousemove", mouseHandler);
    
    // Control teclado alternativo (W y S)
    const keyHandlerPong = (e) => {
        if(e.key === 'w' || e.key === 'W') user.y -= 25;
        if(e.key === 's' || e.key === 'S') user.y += 25;
    };
    document.addEventListener("keydown", keyHandlerPong);

    function collision(b, p) {
        p.top = p.y;
        p.bottom = p.y + p.height;
        p.left = p.x;
        p.right = p.x + p.width;

        b.top = b.y - b.radius;
        b.bottom = b.y + b.radius;
        b.left = b.x - b.radius;
        b.right = b.x + b.radius;

        return p.left < b.right && p.top < b.bottom && p.right > b.left && p.bottom > b.top;
    }

    function resetBall() {
        ball.x = canvas.width/2;
        ball.y = canvas.height/2;
        ball.speed = 5;
        ball.velocityX = -ball.velocityX;
    }

    function update() {
        if (!document.getElementById('gameCanvas')) {
            clearInterval(gameInterval);
            document.removeEventListener("keydown", keyHandlerPong);
            return;
        }

        ball.x += ball.velocityX;
        ball.y += ball.velocityY;

        // IA Computadora
        let computerLevel = 0.1;
        com.y += (ball.y - (com.y + com.height/2)) * computerLevel;

        if(ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
            ball.velocityY = -ball.velocityY;
        }

        let player = (ball.x + ball.radius < canvas.width/2) ? user : com;

        if(collision(ball, player)) {
            let collidePoint = (ball.y - (player.y + player.height/2));
            collidePoint = collidePoint / (player.height/2);
            let angleRad = (Math.PI/4) * collidePoint;
            let direction = (ball.x + ball.radius < canvas.width/2) ? 1 : -1;
            ball.velocityX = direction * ball.speed * Math.cos(angleRad);
            ball.velocityY = ball.speed * Math.sin(angleRad);
            ball.speed += 0.2;
        }

        if(ball.x - ball.radius < 0) {
            com.score++;
            resetBall();
        } else if(ball.x + ball.radius > canvas.width) {
            user.score++;
            resetBall();
        }
    }

    function game() {
        drawRect(0, 0, canvas.width, canvas.height, "#2d3e50");
        drawText(user.score, canvas.width/4, canvas.height/5);
        drawText(com.score, 3*canvas.width/4, canvas.height/5);
        drawNet();
        drawRect(user.x, user.y, user.width, user.height, user.color);
        drawRect(com.x, com.y, com.width, com.height, com.color);
        drawArc(ball.x, ball.y, ball.radius, ball.color);
        update();
    }

    clearInterval(gameInterval);
    gameInterval = setInterval(game, 1000/50);
}

================
File: public/consultar-empleados.html
================
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Empleados</title>
  <link rel="stylesheet" href="assets/styles.css">
  <script src="/auth.js"></script>
  <script defer src="consultar-empleados.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>

  <div class="container">
    <a href="registrar-empleado.html" class="back-button">‚¨ÖÔ∏è Regresar</a>
    <h1 class="title">üë• Consulta de Empleados</h1>
    

    <input type="text" id="buscador" placeholder="Buscar por nombre o ID..." class="input"><button id="btn-exportar-todo" class="btn-export">
      üì• Exportar PDF o Excel</button> 
    <br>


<div>
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>√Årea</th> <th>Fecha Ingreso</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-empleados">
            </tbody>
    </table>
    </div>

<div id="pagination-controls" class="pagination-controls"></div>
</div>
<div id="exportModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" id="modal-close">&times;</span>
        <h3>üì• Exportar Datos</h3>
        <p>Selecciona el formato:</p>
        <div class="export-options">
            <button id="btn-confirm-pdf" class="btn-export-option btn-pdf">
                üìÑ Descargar PDF
            </button>
            <button id="btn-confirm-excel" class="btn-export-option btn-excel">
                üìä Descargar Excel
            </button>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>

================
File: public/consultar-empleados.js
================
const API_URL = "api/empleados";
const API_URL_AREAS = "api/areas";

let empleados = []; 
let empleadosFiltrados = []; 
let listaAreas = []; 

// --- VARIABLES DE PAGINACI√ìN ---
let currentPage = 1;
const itemsPerPage = 10;
let totalPages = 1;

function eliminarDuplicados(lista) {
  const mapa = new Map();
  lista.forEach(emp => {
    if (!mapa.has(emp.id)) {
      mapa.set(emp.id, emp);
    }
  });
  return Array.from(mapa.values());
}

// 1. Cargar √Åreas primero
async function cargarAreas() {
    try {
        const res = await fetch(API_URL_AREAS);
        if(res.ok) {
            listaAreas = await res.json();
            console.log("√Åreas cargadas:", listaAreas);
        }
    } catch (error) {
        console.error("Error cargando √°reas:", error);
    }
}

// 2. Cargar empleados
async function cargarEmpleados() {
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error("Error en la respuesta del servidor");
    
    const data = await res.json();
    empleados = eliminarDuplicados(data);
    empleadosFiltrados = [...empleados]; 
    mostrarEmpleados(); 

  } catch (err) {
    console.error(err);
  }
}

function mostrarEmpleados(lista = empleadosFiltrados) {
  empleadosFiltrados = lista;
  const tbody = document.getElementById("tabla-empleados");
  tbody.innerHTML = "";

  totalPages = Math.ceil(empleadosFiltrados.length / itemsPerPage);

  if (currentPage < 1) currentPage = 1;
  if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedData = empleadosFiltrados.slice(startIndex, endIndex);

  if (paginatedData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align: center;">No se encontraron empleados.</td></tr>`;
      renderPaginationControls();
      return;
  }

  paginatedData.forEach(emp => {
    const tr = document.createElement("tr");
    const fecha = emp.fecha_ingreso ? emp.fecha_ingreso.split("T")[0] : "";
    
    const nombreArea = emp.area || emp.nombre_area || "Sin √Årea"; 
    const areaObj = listaAreas.find(a => a.nombre === nombreArea);
    const areaIdEncontrado = areaObj ? areaObj.id : "";

    const tdId = document.createElement('td');
    tdId.textContent = emp.id;
    
    const tdCodigo = document.createElement('td');
    tdCodigo.textContent = emp.codigo || "N/A";
    
    const tdNombre = document.createElement('td');
    tdNombre.textContent = emp.nombre; 
    
    const tdCorreo = document.createElement('td');
    tdCorreo.textContent = emp.correo || "";
    
    const tdArea = document.createElement('td');
    tdArea.textContent = nombreArea;
    tdArea.setAttribute("data-area-id", areaIdEncontrado); 
    
    const tdFecha = document.createElement('td');
    tdFecha.textContent = fecha || "";

    const tdAcciones = document.createElement('td');
    tdAcciones.innerHTML = `
        <button type="button" class="btn-editar">Modificar</button>
        <button type="button" class="btn-guardar" style="display:none;">Guardar</button>
    `;

    tr.appendChild(tdId);
    tr.appendChild(tdCodigo);
    tr.appendChild(tdNombre);
    tr.appendChild(tdCorreo);
    tr.appendChild(tdArea);
    tr.appendChild(tdFecha);
    tr.appendChild(tdAcciones);

    tbody.appendChild(tr);
  });

  renderPaginationControls();
}

function renderPaginationControls() {
    let paginationContainer = document.getElementById("pagination-controls");
    if (!paginationContainer) {
        const table = document.querySelector(".data-table") || document.querySelector("table");
        if (table) {
            paginationContainer = document.createElement("div");
            paginationContainer.id = "pagination-controls";
            paginationContainer.className = "pagination-controls"; 
            table.parentNode.insertBefore(paginationContainer, table.nextSibling);
        } else { return; }
    }

    paginationContainer.innerHTML = "";
    const prevButton = document.createElement("button");
    prevButton.textContent = "‚¨Ö Anterior";
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            mostrarEmpleados(empleadosFiltrados);
        }
    };
    const pageInfo = document.createElement("span");
    pageInfo.textContent = ` P√°gina ${currentPage} de ${totalPages || 1} `;
    const nextButton = document.createElement("button");
    nextButton.textContent = "Siguiente ‚û°";
    nextButton.disabled = currentPage >= totalPages;
    nextButton.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            mostrarEmpleados(empleadosFiltrados);
        }
    };
    paginationContainer.appendChild(prevButton);
    paginationContainer.appendChild(pageInfo);
    paginationContainer.appendChild(nextButton);
}

// Funci√≥n Editar
function activarEdicion(btn) {
  const fila = btn.closest("tr");
  const celdas = fila.children;
  const btnGuardar = fila.querySelector(".btn-guardar");

  btn.style.display = "none";
  if(btnGuardar) btnGuardar.style.display = "inline-block";

  const nombreActual = celdas[2].innerText;
  const correoActual = celdas[3].innerText;
  const areaActualId = celdas[4].getAttribute("data-area-id"); 
  const fechaActual = celdas[5].innerText;

  celdas[2].innerHTML = `<input type="text" class="input-edit" value="${nombreActual}" />`;
  celdas[3].innerHTML = `<input type="email" class="input-edit" value="${correoActual}" />`;
  
  let opcionesArea = '<option value="">Seleccione √Årea</option>';
  listaAreas.forEach(area => {
      const selected = (String(area.id) === String(areaActualId)) ? 'selected' : '';
      opcionesArea += `<option value="${area.id}" ${selected}>${area.nombre}</option>`;
  });
  celdas[4].innerHTML = `<select class="input-edit">${opcionesArea}</select>`;

  celdas[5].innerHTML = `<input type="date" class="input-edit" value="${fechaActual}" />`;
}

// Funci√≥n Guardar
async function guardarCambios(btn) {
  const fila = btn.closest("tr");
  const celdas = fila.children;
  const id = celdas[0].textContent.trim();
  
  const inputNombre = celdas[2].querySelector("input");
  const inputCorreo = celdas[3].querySelector("input");
  const inputArea = celdas[4].querySelector("select");
  const inputFecha = celdas[5].querySelector("input");

  if (!inputNombre || !inputCorreo || !inputArea || !inputFecha) {
    Swal.fire({ icon: "error", text: "Error: Campos no encontrados." });
    return;
  }

  const nombre = inputNombre.value?.trim()?.toUpperCase();
  const correo = inputCorreo.value?.trim()?.toLowerCase();
  const area_id = inputArea.value;
  const fecha_ingreso = inputFecha.value;

  if (!nombre || !correo || !fecha_ingreso || !area_id) {
    Swal.fire({ icon: "warning", text: "Todos los campos son obligatorios." });
    return;
  }

  const datos = { nombre, correo, fecha_ingreso, area_id };

  try {
    const result = await Swal.fire({
      title: "¬øGuardar cambios?",
      text: "Se actualizar√° la informaci√≥n del empleado y su √°rea.",
      icon: "question",
      showDenyButton: true,
      confirmButtonText: "Guardar",
      denyButtonText: "Cancelar"
    });

    if (result.isDenied) {
        mostrarEmpleados();
        return;
    }

    const res = await fetch(`${API_URL}/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(datos),
    });

    if (!res.ok) {
      throw new Error("Error al actualizar.");
    }

    await Swal.fire({
      icon: "success",
      text: "‚úÖ Empleado actualizado.",
      showConfirmButton: false,
      timer: 1500
    });

    cargarEmpleados(); 

  } catch (err) {
    console.error("‚ùå Error:", err.message);
    Swal.fire({ icon: "error", text: "Error al guardar los cambios." });
  }
}

// EXPORTACI√ìN INDIVIDUAL (Para usar con el Modal)
async function exportarEmpleadosPDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("Reporte de Empleados", 14, 20);
        const fechaReporte = new Date().toLocaleString();
        doc.setFontSize(10);
        doc.text(`Fecha del reporte: ${fechaReporte}`, 14, 28);
        const dataToExport = empleadosFiltrados; 
        const rows = dataToExport.map(emp => [
            emp.codigo || "N/A",
            emp.nombre || "No especificado",
            emp.correo || "No disponible",
            emp.area || "Sin √Årea",
            emp.fecha_ingreso ? new Date(emp.fecha_ingreso).toLocaleDateString() : "No disponible"
        ]);
        doc.autoTable({
          head: [["C√≥digo", "Nombre", "Correo", "√Årea", "Fecha de Ingreso"]],
          body: rows,
          startY: 35
        });
        doc.save("reporte_empleados.pdf");
      } catch (error) { console.error("Error PDF:", error); }
}

function exportarEmpleadosExcel() {
    try {
        const dataToExport = empleadosFiltrados;
        const wsData = [
          ["C√≥digo", "Nombre", "Correo", "√Årea", "Fecha de Ingreso"],
          ...dataToExport.map(emp => [
            emp.codigo || "N/A",
            emp.nombre || "No especificado",
            emp.correo || "No disponible",
            emp.area || "Sin √Årea",
            emp.fecha_ingreso ? new Date(emp.fecha_ingreso).toLocaleDateString() : "No disponible"
          ])
        ];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Empleados");
        XLSX.writeFile(wb, "reporte_empleados.xlsx");
      } catch (error) { console.error("Error Excel:", error); }
}

// --- L√ìGICA DEL MODAL DE EXPORTACI√ìN (VERSI√ìN SEGURA) ---
document.addEventListener("DOMContentLoaded", async () => {
  await cargarAreas();
  cargarEmpleados();

  const buscador = document.getElementById("buscador");
  if (buscador) {
    buscador.addEventListener("input", () => {
        const texto = buscador.value.toLowerCase();
        const filtrados = empleados.filter(e => {
            return Object.values(e).some(val =>
            val && val.toString().toLowerCase().includes(texto)
            );
        });
        currentPage = 1;
        mostrarEmpleados(filtrados);
    });
  }

  const tablaEmpleados = document.getElementById("tabla-empleados");
  tablaEmpleados.addEventListener("click", (e) => {
    const target = e.target; 
    if (target.classList.contains("btn-editar")) activarEdicion(target);
    if (target.classList.contains("btn-guardar")) guardarCambios(target);
  });

  // L√≥gica del Modal (AQU√ç DENTRO)
  const exportModal = document.getElementById("exportModal");
  const btnOpen = document.getElementById("btn-exportar-todo");
  const btnClose = document.getElementById("modal-close");
  const btnPdf = document.getElementById("btn-confirm-pdf");
  const btnExcel = document.getElementById("btn-confirm-excel");

  // Abrir Modal
  if (btnOpen) {
      btnOpen.addEventListener("click", () => {
          if (exportModal) exportModal.style.display = "flex";
      });
  }

  // Cerrar Modal
  const cerrarModal = () => {
      if (exportModal) exportModal.style.display = "none";
  };

  if (btnClose) btnClose.addEventListener("click", cerrarModal);

  // Cerrar si clic fuera
  window.addEventListener("click", (event) => {
      if (event.target === exportModal) cerrarModal();
  });

  // Acci√≥n PDF
  if (btnPdf) {
      btnPdf.addEventListener("click", async () => {
          cerrarModal();
          Swal.fire({ title: 'Generando PDF...', didOpen: () => Swal.showLoading() });
          await exportarEmpleadosPDF(); 
          Swal.close();
      });
  }

  // Acci√≥n Excel
  if (btnExcel) {
      btnExcel.addEventListener("click", async () => {
          cerrarModal();
          Swal.fire({ title: 'Generando Excel...', didOpen: () => Swal.showLoading() });
          exportarEmpleadosExcel(); 
          Swal.close();
      });
  }
});

================
File: public/consultar-incidencias.html
================
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <title>Consultar Incidencias</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>

  <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>

  <div class="container">
    <a href="/registrar-incidencia" class="back-button">‚¨ÖÔ∏è Regresar</a> 

    <h1 class="title">üö® Incidencias Registradas</h1>

    <div class="search-bar">
        <label for="search">Buscar:</label>
        <input type="text" id="search" placeholder="Buscar por activo o empleado...">
        <button id="search-button" class="btn">üîé Buscar</button>
        <button id="btn-exportar-todo">üì• Exportar PDF o Excel</button>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    </div>
    
    <div class="filter-bar"> 
      <div class="filter-group">
        <label for="filtro-area">√Årea:</label>
        <select id="filtro-area">
          <option value="">Todas las √°reas</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filtro-estado">Estado:</label>
        <select id="filtro-estado">
          <option value="">Todos</option>
          <option value="amarillo">No solucionados</option>
          <option value="verde">Solucionados</option>
        </select>
      </div>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
        <th>Activo</th>
        <th>√Årea</th>
        <th>Empleado</th>
        <th>Descripci√≥n</th>
        <th>Fecha Reporte</th>
        <th>Fecha Soluci√≥n</th> 
        <th>Diagn√≥stico IA</th>
        <th>Estado</th>
        <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="8" style="text-align: center;">Cargando incidencias...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div style="margin-top: 10px; font-size: 14px; color: #333;">
        <strong>Leyenda Mantenimiento:</strong> &nbsp; üü¢ Solucionado &nbsp; | &nbsp; üü° Pendiente / En Proceso
    </div>
    
    <div id="pagination-controls" class="pagination-controls"></div>
  </div>
  <div id="exportModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" id="modal-close">&times;</span>
        <h3>üì• Exportar Datos</h3>
        <p>Selecciona el formato:</p>
        <div class="export-options">
            <button id="btn-confirm-pdf" class="btn-export-option btn-pdf">
                üìÑ Descargar PDF
            </button>
            <button id="btn-confirm-excel" class="btn-export-option btn-excel">
                üìä Descargar Excel
            </button>
        </div>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/consultar-incidencias.js"></script>
  <script src="/auth.js"></script>
  <script src="chatbot.js"></script>
</body>
</html>

================
File: public/consultar-incidencias.js
================
const API_URL_INCIDENCIAS = "api/incidencias/historico";
const API_URL_MANTENIMIENTO = "api/mantenimientos";
const API_URL_ACTIVOS = "api/activos/numero-serie";

const tbody = document.querySelector(".data-table tbody");
const searchInput = document.getElementById("search");
const searchButton = document.getElementById("search-button");
const areaFilter = document.getElementById("filtro-area");
let areaFilterInicializado = false;

// --- VARIABLES DE PAGINACI√ìN ---
let currentPage = 1;
const itemsPerPage = 10;
let totalPages = 1;

// Obtener datos del backend
const getIncidencias = async () => {
  try {
    const response = await fetch(API_URL_INCIDENCIAS, {
      headers: setAuthHeader()
    });
    if (!response.ok) {
      if (response.status === 401 || response.status === 403) logout();
      throw new Error("‚ùå No se pudieron obtener las incidencias.");
    }

    const incidencias = await response.json();
    return incidencias.map(incidencia => {
      let fechaSolucion = incidencia.fin_mantenimiento;
      if (fechaSolucion === "0000-00-00" || fechaSolucion === "0000-00-00 00:00:00") {
        fechaSolucion = null;
      }

      return {
        id: incidencia.id,
        itemcode_popup: incidencia.itemcode_popup || null,
        nombre_activo: incidencia.nombre_activo || "Desconocido",
        nombre_area: incidencia.nombre_area || "Sin √°rea",
        nombre_empleado: incidencia.nombre_empleado || "No asignado",
        descripcion: incidencia.descripcion || "Sin descripci√≥n",
        fecha_reporte: incidencia.fecha_reporte
          ? incidencia.fecha_reporte.split("T")[0]
          : "No disponible",
        estado_equipo: incidencia.estado_equipo || "verde",
        fin_mantenimiento: fechaSolucion 
      };
    });
  } catch (error) {
    console.error("‚ùå Error al obtener incidencias:", error);
    return [];
  }
};

// Acciones de mantenimiento
const iniciarMantenimiento = async (incidenciaId, btn) => {
  if (btn) {
      btn.disabled = true;
      btn.textContent = "Iniciando...";
      btn.style.cursor = "wait";
  }

  const fechaActual = new Date().toISOString().split("T")[0];
  try {
    const response = await fetch(`${API_URL_MANTENIMIENTO}/iniciar`, {
      method: "POST",
      headers: setAuthHeader({ "Content-Type": "application/json" }),
      body: JSON.stringify({
        incidencia_id: incidenciaId,
        init_mantenimiento: fechaActual
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Error al iniciar mantenimiento");

    Swal.fire("Iniciado", "El mantenimiento ha comenzado.", "success");
    loadIncidencias(searchInput.value.trim()); 
  } catch (error) {
    console.error("‚ùå Error al iniciar mantenimiento:", error);
    Swal.fire("Error", "No se pudo iniciar el mantenimiento", "error");
    if (btn) {
        btn.disabled = false;
        btn.textContent = "Iniciar";
        btn.style.cursor = "pointer";
    }
  }
};

// Finalizar mantenimiento
const finalizarMantenimiento = async (incidenciaId, btn) => {
  const result = await Swal.fire({
    title: '¬øSe solucion√≥ correctamente el incidente?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#28a745', 
    cancelButtonColor: '#d33',    
    confirmButtonText: 'Si',
    cancelButtonText: 'No'
  });

  if (!result.isConfirmed) return;

  if (btn) {
      btn.disabled = true;
      btn.textContent = "Procesando...";
      btn.style.cursor = "wait";
  }

  const fechaActual = new Date().toISOString().split("T")[0];
  try {
    const response = await fetch(`${API_URL_MANTENIMIENTO}/finalizar`, {
      method: "POST",
      headers: setAuthHeader({ "Content-Type": "application/json" }),
      body: JSON.stringify({
        incidencia_id: incidenciaId,
        fin_mantenimiento: fechaActual
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Error al finalizar mantenimiento");

    Swal.fire("¬°Solucionado!", "Incidente cerrado con fecha: " + fechaActual, "success");
    loadIncidencias(searchInput.value.trim()); 
  } catch (error) {
    console.error("‚ùå Error al finalizar mantenimiento:", error);
    Swal.fire("Error", "Ocurri√≥ un error al finalizar.", "error");
    if (btn) {
        btn.disabled = false;
        btn.textContent = "Solucionar?";
        btn.style.cursor = "pointer";
    }
  }
};

// --- POPUPS ---
const mostrarPopupActivo = async (itemCode) => {
  try {
    const response = await fetch(`${API_URL_ACTIVOS}/${itemCode}`, {
      headers: setAuthHeader()
    });
    if (!response.ok) throw new Error("Activo no encontrado");

    const data = await response.json();
    const precioFormateado = data.Price ? `$${parseFloat(data.Price).toFixed(2)}` : "N/A";

    const infoActivo = `
üìå C√≥digo: ${data.ItemCode || "N/A"}
üè∑Ô∏è Nombre: ${data.ItemName || "N/A"}
üè¢ Marca: ${data.marca || "N/A"}
üè∑Ô∏è Modelo: ${data.modelo || "N/A"}
üìÖ Fecha Compra: ${data.fecha_compra ? data.fecha_compra.split("T")[0] : "N/A"}
üí∞ Precio: ${precioFormateado}
üí≤ Moneda: ${data.Currency || "USD"}
    `.trim();

    Swal.fire({
      title: 'üì¶ Detalle del Activo',
      icon: 'info',
      html: `<pre style="text-align:left; white-space: pre-wrap; font-family: sans-serif;">${infoActivo}</pre>`,
      confirmButtonText: 'Cerrar'
    });
  } catch (error) {
    console.error("‚ùå Error al mostrar info del activo:", error);
    Swal.fire("Error", "No se pudo obtener informaci√≥n.", "error");
  }
};

const mostrarPopupDescripcion = (textoCompleto) => {
    Swal.fire({
        text: textoCompleto, 
        icon: 'info',
        confirmButtonText: 'Entendido',
    });
};

// --- CARGAR INCIDENCIAS ---
const loadIncidencias = async (filter = "") => {
  if(tbody.innerHTML === "") tbody.innerHTML = "<tr><td colspan='9'>Cargando incidencias...</td></tr>"; 

  const incidencias = await getIncidencias();
  
  const filterTerm = filter.toLowerCase();
  const selectedArea = areaFilter ? areaFilter.value.toLowerCase() : "";
  const estadoFilter = document.getElementById("filtro-estado");
  const selectedEstado = estadoFilter ? estadoFilter.value.toLowerCase() : "";

  const incidenciasFiltradas = incidencias.filter(i =>
    (
      i.nombre_activo.toLowerCase().includes(filterTerm) ||
      i.nombre_empleado.toLowerCase().includes(filterTerm) ||
      i.nombre_area.toLowerCase().includes(filterTerm)
    ) &&
    (!selectedArea || i.nombre_area.toLowerCase() === selectedArea) &&
    (!selectedEstado || i.estado_equipo.toLowerCase() === selectedEstado)
  );

  if (areaFilter && !areaFilterInicializado) {
    const areasUnicas = [...new Set(incidencias.map(i => i.nombre_area).filter(Boolean))];
    areaFilter.innerHTML = `<option value="">Todas las √°reas</option>`;
    areasUnicas.forEach(area => {
      const option = document.createElement("option");
      option.value = area;
      option.textContent = area;
      areaFilter.appendChild(option);
    });
    areaFilterInicializado = true;
  }

  totalPages = Math.ceil(incidenciasFiltradas.length / itemsPerPage);
  if (currentPage < 1) currentPage = 1;
  if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedData = incidenciasFiltradas.slice(startIndex, endIndex);

  renderPaginationControls();

  tbody.innerHTML = "";
  if (!paginatedData.length) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align: center;">
        ${filter ? "No se encontraron resultados." : "No hay incidencias."}
    </td></tr>`;
    return;
  }

  paginatedData.forEach(incidencia => {
    
    // Descripci√≥n Corta
    const MAX_LENGTH = 150; 
    let descripcionHTML = incidencia.descripcion;
    let esLargo = false;

    if (incidencia.descripcion.length > MAX_LENGTH) {
        esLargo = true;
        descripcionHTML = incidencia.descripcion.substring(0, MAX_LENGTH) + "...";
    }

    const row = document.createElement("tr");
    
    // Fecha Soluci√≥n
    let celdaFechaSolucion = "<em style='color:#e67e22; font-weight:bold;'>Por solucionar</em>";
    if (incidencia.fin_mantenimiento) {
        const fechaStr = String(incidencia.fin_mantenimiento);
        if (!fechaStr.startsWith("0000") && !fechaStr.startsWith("1899") && !fechaStr.startsWith("1900")) {
            celdaFechaSolucion = fechaStr.split("T")[0];
        }
    }

    // 1. Columnas Base
    row.innerHTML = `
      <td>
        <a href="#" class="activo-link" data-itemcode="${incidencia.itemcode_popup}" style="color:#007bff; font-weight:bold; text-decoration:underline;">
          ${incidencia.nombre_activo}
        </a>
      </td>
      <td>${incidencia.nombre_area}</td>
      <td>${incidencia.nombre_empleado}</td>
      <td>
          ${descripcionHTML}
          ${esLargo ? `<br><a href="#" class="ver-desc-link" style="font-size:12px; color:#007bff;">(Ver m√°s)</a>` : ''}
      </td>
      <td>${incidencia.fecha_reporte}</td>
      <td>${celdaFechaSolucion}</td>
    `;

    // 2. Columna Diagn√≥stico IA
    const iaCell = document.createElement("td");
    iaCell.style.textAlign = "center"; 

    const btnIA = document.createElement("button");
    btnIA.textContent = "üß† Diagn√≥stico"; 
    btnIA.title = "Consultar a la IA";
    btnIA.style.backgroundColor = "#6f42c1"; 
    btnIA.style.color = "white";
    btnIA.style.border = "none";
    btnIA.style.borderRadius = "20px";
    btnIA.style.padding = "5px 12px";
    btnIA.style.cursor = "pointer";
    btnIA.style.fontSize = "12px";
    btnIA.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";

    btnIA.addEventListener("click", async () => {
        Swal.fire({
            title: 'Analizando...',
            text: 'El asistente virtual est√° revisando el caso...',
            didOpen: () => Swal.showLoading()
        });

        try {
            const response = await fetch("/api/sugerir-solucion", {
                method: "POST",
                headers: setAuthHeader({ "Content-Type": "application/json" }),
                body: JSON.stringify({ 
                    descripcion: incidencia.descripcion,
                    activo_modelo: incidencia.nombre_activo 
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || "Error al consultar IA");

            let pasosHtml = "<em>Sin pasos espec√≠ficos.</em>";
            if (data.pasos && Array.isArray(data.pasos)) {
                pasosHtml = `<ul style="text-align: left; margin-top: 5px;">${data.pasos.map(p => `<li>${p}</li>`).join('')}</ul>`;
            }

            Swal.fire({
                title: 'üß† Diagn√≥stico Sugerido',
                html: `
                    <div style="text-align: left; font-family: sans-serif; font-size: 14px;">
                        <div style="background: #f8f9fa; padding: 10px; border-left: 4px solid #6f42c1; border-radius: 4px; margin-bottom: 10px;">
                            <strong>ü©∫ Diagn√≥stico Probable:</strong><br>
                            ${data.diagnostico}
                        </div>
                        <strong>üõ†Ô∏è Pasos de Soluci√≥n:</strong>
                        ${pasosHtml}
                        <hr>
                        <div style="margin-top:10px;">
                            <strong>Nivel de Riesgo:</strong> 
                            <span style="font-weight:bold; color: ${data.riesgo === 'alto' ? '#dc3545' : (data.riesgo === 'medio' ? '#fd7e14' : '#28a745')}">
                                ${data.riesgo ? data.riesgo.toUpperCase() : 'DESCONOCIDO'}
                            </span>
                        </div>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#6f42c1',
                width: '600px'
            });

        } catch (error) {
            console.error(error);
            Swal.fire("Error", "No se pudo obtener el diagn√≥stico.", "error");
        }
    });
    iaCell.appendChild(btnIA);
    row.appendChild(iaCell);

    // 3. Columna Estado
    const estadoCell = document.createElement("td");
    estadoCell.innerHTML = `<span class="estado-equipo ${incidencia.estado_equipo}">${incidencia.estado_equipo}</span>`;
    row.appendChild(estadoCell);

    // 4. Columna Acciones
    const accionesCell = document.createElement("td");
    
    const iniciarBtn = document.createElement("button");
    iniciarBtn.textContent = "Iniciar";
    iniciarBtn.classList.add("btn-iniciar");

    const finalizarBtn = document.createElement("button");
    finalizarBtn.textContent = "Solucionar?"; 
    finalizarBtn.classList.add("btn-finalizar");

    const finalizadoSpan = document.createElement("span");
    finalizadoSpan.textContent = "‚úÖ Solucionado";
    finalizadoSpan.style.fontWeight = "bold";
    finalizadoSpan.style.color = "green";

    iniciarBtn.style.display = "none";
    finalizarBtn.style.display = "none";
    finalizadoSpan.style.display = "none";

    switch (incidencia.estado_equipo) {
      case "verde":
        finalizadoSpan.style.display = "inline-block";
        break;
      case "amarillo":
        finalizarBtn.style.display = "inline-block";
        break;
      default: 
        iniciarBtn.style.display = "inline-block";
        break;
    }

    iniciarBtn.addEventListener("click", (e) => iniciarMantenimiento(incidencia.id, e.target));
    finalizarBtn.addEventListener("click", (e) => finalizarMantenimiento(incidencia.id, e.target));
    
    accionesCell.appendChild(iniciarBtn);
    accionesCell.appendChild(finalizarBtn);
    accionesCell.appendChild(finalizadoSpan);
    row.appendChild(accionesCell);

    tbody.appendChild(row);

    // Eventos Links
    const linkActivo = row.querySelector(".activo-link");
    if (linkActivo) {
      linkActivo.addEventListener("click", async (e) => {
        e.preventDefault();
        const itemCode = linkActivo.dataset.itemcode;
        if (!itemCode || itemCode === "null") {
          Swal.fire("Info", "Sin detalles disponibles.", "info");
          return;
        }
        await mostrarPopupActivo(itemCode);
      });
    }

    const linkDesc = row.querySelector(".ver-desc-link");
    if (linkDesc) {
        linkDesc.addEventListener("click", (e) => {
            e.preventDefault();
            mostrarPopupDescripcion(incidencia.descripcion);
        });
    }
  });
};

// --- PAGINACI√ìN ---
const renderPaginationControls = () => {
    let paginationContainer = document.getElementById("pagination-controls");
    if (!paginationContainer) {
        const table = document.querySelector(".data-table") || document.querySelector("table");
        if (table) {
            paginationContainer = document.createElement("div");
            paginationContainer.id = "pagination-controls";
            paginationContainer.className = "pagination-controls"; 
            table.parentNode.insertBefore(paginationContainer, table.nextSibling);
        } else {
            return;
        }
    }

    paginationContainer.innerHTML = "";

    const prevButton = document.createElement("button");
    prevButton.textContent = "‚¨Ö Anterior";
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            loadIncidencias(searchInput.value.trim());
        }
    };

    const pageInfo = document.createElement("span");
    pageInfo.textContent = ` P√°gina ${currentPage} de ${totalPages > 0 ? totalPages : 1} `;

    const nextButton = document.createElement("button");
    nextButton.textContent = "Siguiente ‚û°";
    nextButton.disabled = currentPage >= totalPages;
    nextButton.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            loadIncidencias(searchInput.value.trim());
        }
    };

    paginationContainer.appendChild(prevButton);
    paginationContainer.appendChild(pageInfo);
    paginationContainer.appendChild(nextButton);
};

// --- FUNCIONES EXPORTAR (INDIVIDUALES) ---
async function exportarPDFIncidencias() {
  const incidencias = await getIncidencias();
  
  const filter = searchInput.value.trim().toLowerCase();
  const selectedArea = areaFilter ? areaFilter.value.toLowerCase() : "";
  const estadoEl = document.getElementById("filtro-estado");
  const selectedEstado = estadoEl ? estadoEl.value.toLowerCase() : "";

  const filtradas = incidencias.filter(i =>
    (
      i.nombre_activo.toLowerCase().includes(filter) ||
      i.nombre_empleado.toLowerCase().includes(filter) ||
      i.nombre_area.toLowerCase().includes(filter)
    ) &&
    (!selectedArea || i.nombre_area.toLowerCase() === selectedArea) &&
    (!selectedEstado || i.estado_equipo.toLowerCase() === selectedEstado)
  );

  const fechaReporte = new Date().toLocaleString();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Reporte de Incidencias", 14, 20);
  doc.setFontSize(10);
  doc.text(`Fecha del reporte: ${fechaReporte}`, 14, 28);

  const rows = filtradas.map(i => [
    i.nombre_activo,
    i.nombre_area,
    i.nombre_empleado,
    i.descripcion,
    i.fecha_reporte,
    i.fin_mantenimiento || "No solucionado",
    "IA DISPONIBLE", 
    i.estado_equipo
  ]);

  doc.autoTable({
    head: [["Activo", "√Årea", "Empleado", "Descripci√≥n", "Fecha", "Finalizaci√≥n", "Diagn√≥stico IA", "Estado"]],
    body: rows,
    startY: 35
  });

  doc.save("reporte_incidencias.pdf");
}

async function exportarExcelIncidencias() {
  const incidencias = await getIncidencias();
  const filter = searchInput.value.trim().toLowerCase();
  const selectedArea = areaFilter ? areaFilter.value.toLowerCase() : "";
  const estadoEl = document.getElementById("filtro-estado");
  const selectedEstado = estadoEl ? estadoEl.value.toLowerCase() : "";

  const filtradas = incidencias.filter(i =>
    (
      i.nombre_activo.toLowerCase().includes(filter) ||
      i.nombre_empleado.toLowerCase().includes(filter) ||
      i.nombre_area.toLowerCase().includes(filter)
    ) &&
    (!selectedArea || i.nombre_area.toLowerCase() === selectedArea) &&
    (!selectedEstado || i.estado_equipo.toLowerCase() === selectedEstado)
  );

  const wsData = [
    ["Activo", "√Årea", "Empleado", "Descripci√≥n", "Fecha", "Finalizaci√≥n", "Estado"], 
    ...filtradas.map(i => [
      i.nombre_activo,
      i.nombre_area,
      i.nombre_empleado,
      i.descripcion,
      i.fecha_reporte,
      i.fin_mantenimiento || "No solucionado",
      i.estado_equipo
    ])
  ];

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Incidencias");
  XLSX.writeFile(wb, "reporte_incidencias.xlsx");
}

// --- L√ìGICA DEL MODAL DE EXPORTACI√ìN (VERSI√ìN SEGURA) ---
document.addEventListener("DOMContentLoaded", () => {
    // 1. Cargar Datos
    loadIncidencias();

    // 2. Filtros y B√∫squeda
    if (searchButton) searchButton.addEventListener("click", () => { currentPage = 1; loadIncidencias(searchInput.value.trim()); });
    if (searchInput) searchInput.addEventListener("input", () => { currentPage = 1; loadIncidencias(searchInput.value.trim()); });
    if (areaFilter) areaFilter.addEventListener("change", () => { currentPage = 1; loadIncidencias(searchInput.value.trim()); });
    if (document.getElementById("filtro-estado")) {
        document.getElementById("filtro-estado").addEventListener("change", () => { currentPage = 1; loadIncidencias(searchInput.value.trim()); });
    }

    // 3. Modal de Exportaci√≥n (L√≥gica segura sin onclick)
    const exportModal = document.getElementById("exportModal");
    const btnOpen = document.getElementById("btn-exportar-todo");
    const btnClose = document.getElementById("modal-close");
    const btnPdf = document.getElementById("btn-confirm-pdf");
    const btnExcel = document.getElementById("btn-confirm-excel");

    // Abrir
    if (btnOpen) {
        btnOpen.addEventListener("click", () => {
            if (exportModal) exportModal.style.display = "flex";
        });
    }

    // Cerrar
    const cerrarModal = () => { if (exportModal) exportModal.style.display = "none"; };
    if (btnClose) btnClose.addEventListener("click", cerrarModal);
    
    // Cerrar clic fuera
    window.addEventListener("click", (event) => {
        if (event.target === exportModal) cerrarModal();
    });

    // Acci√≥n PDF
    if (btnPdf) {
        btnPdf.addEventListener("click", async () => {
            cerrarModal();
            Swal.fire({ title: 'Generando PDF...', didOpen: () => Swal.showLoading() });
            await exportarPDFIncidencias(); 
            Swal.close();
        });
    }

    // Acci√≥n Excel
    if (btnExcel) {
        btnExcel.addEventListener("click", async () => {
            cerrarModal();
            Swal.fire({ title: 'Generando Excel...', didOpen: () => Swal.showLoading() });
            await exportarExcelIncidencias(); 
            Swal.close();
        });
    }
});

================
File: public/index.html
================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio - Gesti√≥n de Activos</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>
    <div class="container">
        <h1 class="title">üí° ¬øQU√â DESEA REALIZAR?</h1>

        <div class="options" id="options-container">
            <a href="#" data-href="/ver-activos" class="option" id="ver-activos">
                <img src="assets/icon-activos.webp" alt="Ver activos disponibles">
                <p>Ver activos disponibles</p>
            </a>
            <a href="#" data-href="/registrar-activo" class="option" id="registrar-activo">
                <img src="assets/icon-registrar-activo.webp" alt="Registrar Activo">
                <p>Registrar Activo</p>
            </a>
            <a href="#" data-href="/registrar-incidencia" class="option" id="registrar-incidencia">
                <img src="assets/icon-registrar-incidencia.webp" alt="Registrar Incidencia">
                <p>Registrar Incidencia</p>
            </a>
            <a href="#" data-href="/registrar-empleado" class="option admin-only" id="registrar-empleado">
                <img src="assets/icon-persona.webp" alt="Registrar empleados">
                <p>Registrar empleados</p>
            </a>
           
        </div>
        <br>
        <button id="logout-button" class="btn-gray">Cerrar Sesi√≥n</button>
    </div>

    <script src="/auth.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const userData = await checkAuth();
            if (!userData) {
                console.log('No autenticado, redirigiendo a login');
                window.location.href = '/login.html';
                return;
            }
    
            const isAdmin = userData.user.isAdmin;
            if (!isAdmin) {
                document.querySelectorAll(".admin-only").forEach(option => option.style.display = "none");
            }
    
            document.querySelectorAll(".option").forEach(link => {
                link.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const href = link.getAttribute("data-href");
                    const authData = await checkAuth();
                    if (authData) {
                        const token = localStorage.getItem('token');
                        console.log("Token para cookie:", token);
                        if (!token) {
                            console.error("No se encontr√≥ token en localStorage");
                            window.location.href = '/login.html';
                            return;
                        }
    
                        // Restablecer la cookie solo si no existe
                        if (!document.cookie.includes('authToken')) {
                            document.cookie = `authToken=${token}; path=/; SameSite=Strict;`;
                            console.log("Cookie establecida:", document.cookie);
                        }
                        window.location.href = href;
                    }
                });
            });
    
            document.getElementById("logout-button").addEventListener("click", () => logout());
        });
    </script>
    <script src="chatbot.js"></script>
</body>
</html>

================
File: public/login.html
================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="d-flex justify-content-center align-items-center vh-100 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="card p-4 shadow">
                    
                    <div class="text-center mb-4">
                        <h4 class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span></h4>
                        <span class="small text-secondary d-block mb-2">for</span>
                        <img src="assets/LOGO.webp" alt="Logo" width="200" class="img-fluid">
                    </div>

                    <h2 class="text-center mb-4 fs-5">Iniciar Sesi√≥n</h2>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Contrase√±a</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Ingresar</button>
                    </form>
                    <p class="text-danger text-center mt-2" id="errorMessage" style="display: none;">Usuario o contrase√±a incorrectos</p>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="login.js"></script>
</body>
</html>

================
File: public/login.js
================
document.getElementById("loginForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim(); 
    console.log("Enviando:", { username, password }); // ‚úÖ Depuraci√≥n 

    try {
        const response = await fetch('/api/login',  {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });
        const data = await response.json();
        console.log("Respuesta del servidor:", data); // Depuraci√≥n

        if (data.success) {
            console.log('Token recibido:', data.token); // ‚úÖ Depuraci√≥n
            localStorage.setItem('token', data.token); // ‚úÖ Guardar token
            document.cookie = `authToken=${data.token}; path=/; SameSite=Strict;`;
            console.log('Token guardado en localStorage:', localStorage.getItem('token'));
            console.log('Cookie establecida:', document.cookie);
            Swal.fire({
                icon: "success",
                text: data.message,
                showConfirmButton: false,
                timer: 1000
            }).then(() => {
                window.location.href = "/index.html"; // Redirige al dashboard
            });
        } else {
            document.getElementById("errorMessage").innerText = data.message || "Error al iniciar sesi√≥n";
            document.getElementById("errorMessage").style.display = "block";
        }
    } catch (error) {
        console.error("Error en la solicitud:", error);
        document.getElementById("errorMessage").innerText = "Error de conexi√≥n";
        document.getElementById("errorMessage").style.display = "block";
    }
});

================
File: public/registrar-activo.html
================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Activo</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>
    <div class="container">
        <a href="/" class="back-button"> ‚¨ÖÔ∏è Regresar</a>
        <h1 class="title">üìù REGISTRAR ACTIVO</h1>
        
        <form id="register-form">
            <div class="form-group">
                <label for="ItemCode">Numero de Serie</label>
                <input type="text" id="ItemCode" name="ItemCode" placeholder="Ingresa el UPC" required>
            </div>
            <div class="form-group">
                <label for="ItemName">Tipo de Activo</label>
                <input type="text" id="ItemName" name="ItemName" placeholder="Ingresa el nombre" class="uppercase" required>
            </div>
            <div class="form-group">
                <label for="marca">Marca</label>
                <input type="text" id="marca" name="marca" placeholder="Ingresa la marca" class="uppercase" required>
            </div>
            <div class="form-group">
                <label for="modelo">Modelo</label>
                <input type="text" id="modelo" name="modelo" placeholder="Ingresa el modelo" class="uppercase" required>
            </div>
           
            <div class="form-group">
                <label for="fecha_compra">Fecha de Compra</label>
                <input type="date" id="fecha_compra" name="fecha_compra" required>
            </div>

            <div class="form-group">
                <label for="Price">Precio</label>
                <input type="number" id="Price" name="Price" placeholder="INGRESE EL COSTO" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="Currency">Moneda</label>
                <select id="Currency" name="Currency">
                    <option value="USD">USD</option>
                    <option value="PEN">PEN</option>
                </select>
            </div>
            <div class="button-group">
                <button type="submit" class="btn">üíæ Registrar</button>
            </div>
        </form>
    </div>
    <script src="registrar-activo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="chatbot.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const userData = await checkAuth();
            if (!userData) {
                window.location.href = "/login.html";
            }
        });
    </script>
</body>
</html>

================
File: public/registrar-activo.js
================
const form = document.getElementById("register-form");
const itemNameInput = document.getElementById("ItemName");
const marcaInput = document.getElementById("marca");
const modeloInput = document.getElementById("modelo");

// Convertir a may√∫sculas en tiempo real
[itemNameInput, marcaInput, modeloInput].forEach(input => {
    input.addEventListener("input", () => {
        input.value = input.value.toUpperCase();
    });
});

document.addEventListener('DOMContentLoaded', () => {
  const itemCodeInput = document.getElementById('ItemCode');
  if (itemCodeInput) {
    itemCodeInput.addEventListener('input', () => {
      itemCodeInput.value = itemCodeInput.value.toUpperCase();
    });
  }
});

// Solo un submit listener con todas las validaciones
form.addEventListener("submit", async (event) => {
    event.preventDefault(); // Siempre detener el submit por defecto

    // Obtener valores
    const fechaCompra = document.getElementById("fecha_compra").value;
    const precio = parseFloat(document.getElementById("Price").value);
    const hoy = new Date();
    const fechaSeleccionada = new Date(fechaCompra);

    // Limpiar horas para comparaci√≥n justa
    hoy.setHours(0, 0, 0, 0);
    fechaSeleccionada.setHours(0, 0, 0, 0);

    // Validar que la fecha no sea futura
    if (fechaSeleccionada > hoy) {
        alert("‚ùå La fecha de compra no puede ser posterior a hoy.");
        return; // Detiene todo
    }

    // Validar que el precio no sea negativo
    if (isNaN(precio) || precio < 0) {
        alert("‚ùå El precio no puede ser negativo.");
        return;
    }

    // Armar el objeto data
    const data = {
        ItemCode: document.getElementById("ItemCode").value.trim(),
        ItemName: document.getElementById("ItemName").value.trim(),
        marca: document.getElementById("marca").value.trim() || "No especificada",
        modelo: document.getElementById("modelo").value.trim() || "No especificado",
        fecha_compra: fechaCompra,
        Price: precio,
        Currency: document.getElementById("Currency").value
    };

    console.log("üì§ Enviando datos al backend:", JSON.stringify(data, null, 2));

    // Enviar al backend
    try {
        const response = await fetch("api/activos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
        });

        if (!response.ok) {
            throw new Error("Error al registrar el activo.");
        }

        Swal.fire({
            icon: "success",
            text: "Activo registrado exitosamente",
            showConfirmButton: false,
            timer: 1000
        });
        form.reset();
    } catch (error) {
        console.error("‚ùå Error al registrar el activo:", error);
        alert(error.message);
    }
});

================
File: public/registrar-empleado.html
================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Empleado</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>
    <div class="container">
        <a href="/" class="back-button">‚¨ÖÔ∏è Regresar</a>
        <h1 class="title">üë∑‚Äç‚ôÇÔ∏è Registrar Empleado</h1> 
        <a href="consultar-empleados" class="btn-gray">üë• Consultar Empleados</a>

        <form id="register-employee-form">
            
            <div class="form-row">
                   <div class="form-group">
        <label for="codigo">C√≥digo</label>
        <input type="text" id="codigo" name="codigo" placeholder="C√ìDIGO DE EMPLEADO" class="uppercase" required>
    </div>

                <div class="form-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" id="nombre" name="nombre" placeholder="INGRESE NOMBRE " class="uppercase" required>
                </div>

                <div class="form-group">
                    <label for="correo">Correo</label>
                    <input type="email" id="correo" name="correo" placeholder="INGRESE CORREO" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="area_id">√Årea</label>
                    <select id="area_id" name="area_id" required>
                        <option value="">SELECCIONE UN AREA</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fecha_ingreso">Fecha de Ingreso</label>
                    <input type="date" id="fecha_ingreso" name="fecha_ingreso" required>
                </div>
            </div>

            <div class="button-group">
            <button type="submit" class="btn">üíæ Registrar</button>
            
  </div>
  
        </form>
    </div>
    <script src="registrar-empleado.js"></script>
    <script src="chatbot.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const userData = await checkAuth();
            if (!userData) {
                window.location.href = "/login.html";
            }
        });
    </script>

</body>
</html>

================
File: public/registrar-empleado.js
================
const API_URL_EMPLEADOS = "api/empleados";
const API_URL_AREAS = "api/areas";
const form = document.getElementById("register-employee-form");
const areaSelect = document.getElementById("area_id");
const correoInput = document.getElementById('correo');

// Funci√≥n para convertir a may√∫sculas el valor de un input al escribir
const toUpperCaseOnInput = (element) => {
  if (!element) return;
  element.addEventListener('input', () => {
    element.value = element.value.toUpperCase();
  });
};

// Aplicar may√∫sculas en inputs
toUpperCaseOnInput(document.getElementById("nombre"));
// Si quieres que el correo tambi√©n se convierta a may√∫sculas (opcional):
// toUpperCaseOnInput(document.getElementById("correo"));

if (form && areaSelect) {
  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const data = {
  codigo: document.getElementById("codigo").value.trim(),
  nombre: document.getElementById("nombre").value.trim(),
  correo: document.getElementById("correo").value.trim(),
  area_id: areaSelect.value || null,
  fecha_ingreso: document.getElementById("fecha_ingreso").value,
};


    if (!data.codigo || !data.nombre || !data.correo || !data.area_id || !data.fecha_ingreso) {

      alert("Por favor, complete todos los campos obligatorios.");
      return;
    }

    try {
      const response = await fetch(API_URL_EMPLEADOS, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error("Error al registrar el empleado.");
      }

      alert("‚úÖ Empleado registrado exitosamente");
      form.reset();
      areaSelect.selectedIndex = 0;
    } catch (error) {
      console.error("‚ùå Error al registrar el empleado:", error);
      alert(error.message);
    }
  });
}

const loadAreas = async () => {
  try {
    const response = await fetch(API_URL_AREAS);
    if (!response.ok) throw new Error("Error al cargar las √°reas");
    const data = await response.json();

    areaSelect.innerHTML = `<option value="">Seleccione un √Årea</option>`;
    data.forEach(item => {
      const option = document.createElement("option");
      option.value = item.id;
      option.textContent = item.nombre;
      areaSelect.appendChild(option);
    });
  } catch (error) {
    console.error("‚ùå Error al cargar las √°reas:", error);
    alert("No se pudieron cargar las √°reas");
  }
};

correoInput.addEventListener('blur', () => {
  correoInput.value = correoInput.value.toLowerCase();
});

document.addEventListener("DOMContentLoaded", loadAreas);

================
File: public/registrar-incidencia.html
================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Incidencia</title>
    <link rel="stylesheet" href="assets/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>
    <div class="container">
        <a href="/" class="back-button">‚¨ÖÔ∏è Regresar</a>
        <h1 class="title">üìù Registrar Incidencia</h1>
<a href="/incidencias.html" class="btn-gray">üóÉÔ∏è Ver Incidencias Registradas</a>
        <!-- Secci√≥n de b√∫squeda del activo -->
        <div class="form-group">
            <label for="ItemCode">C√≥digo del Producto</label>
            <select id="ItemCode" name="ItemCode" required>
                <option value="">Seleccione un Activo</option>
            </select>
        </div>

        <div class="form-group">
            <label for="datos-activo">Informaci√≥n del Activo </label>
            <textarea id="datos-activo" name="datos-activo" rows="10" readonly></textarea> 
        </div>

        <!-- Secci√≥n para registrar la incidencia -->
        <form id="register-incident-form">
            <div class="form-group">
                <label for="activo_id">Activo</label>
                <input type="text" id="activo_id" name="activo_id" readonly>
                <input type="hidden" id="activo_real_id" name="activo_real_id">

                <label for="empleado">Empleado que presenta la incidencia</label>
                <input type="text" id="empleado" name="empleado" readonly placeholder="Seleccione un activo primero">
                <input type="hidden" id="empleado-id" name="empleado-id">

                <label for="usuario_id">Usuario que registra la incidencia</label>
                <select id="usuario_id" name="usuario_id" required></select>
            </div>

            <div class="form-group">
                <label for="descripcion">Descripci√≥n de la Incidencia</label>
                <textarea id="descripcion" name="descripcion" placeholder="Describa la incidencia" required></textarea>
            </div>

            <div class="button-group">
                <button type="submit" class="btn">üíæ Registrar</button>
                
            </div>
        </form>
    </div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="/auth.js"></script>
<script src="chatbot.js"></script>
<script src="/registrar-incidencia.js"></script>   
</body>
</html>

================
File: public/registrar-incidencia.js
================
const API_URL_ACTIVOS = "api/activos/numero-serie"; // Endpoint para buscar activo por ItemCode
const API_URL_LISTAR_ACTIVOS = "api/activos"; // Endpoint para listar activos
const API_URL_INCIDENCIAS = "api/incidencias";
const API_URL_EMPLEADOS = "api/empleados";
const API_URL_USUARIOS = "api/usuarios"; // Ruta para todos los usuarios
const API_URL_USUARIOS_NO_ADMIN = "api/usuarios/noadmin";
const API_URL_EMPLEADO_POR_ACTIVO = "api/activos";


const itemCodeSelect = document.getElementById("ItemCode");
const activoInput = document.getElementById("activo_id"); // Input de texto (readonly)
const activoRealIdInput = document.getElementById("activo_real_id"); // Input oculto para ID
const textareaActivo = document.getElementById("datos-activo");
const empleadoInput = document.getElementById("empleado"); // Input readonly para empleado
const empleadoIdInput = document.getElementById("empleado-id"); // Input oculto para empleado_id
const usuarioSelect = document.getElementById("usuario_id");
const descripcionInput = document.getElementById("descripcion");
const form = document.getElementById("register-incident-form");

// Funci√≥n para llenar el dropdown de activos
const loadActivosDropdown = async () => {
    try {
        const response = await fetch(API_URL_LISTAR_ACTIVOS, {
            headers: setAuthHeader()
        });
        if (!response.ok) {
            throw new Error(`Error ${response.status}: No se pudieron cargar los activos`);
        }
        const data = await response.json();
        console.log("üì• Activos cargados:", data);

        itemCodeSelect.innerHTML = `<option value="">Seleccione un Activo</option>`;
        data.forEach(item => {
            const option = document.createElement("option");
            option.value = item.id; 
            option.textContent = `${item.ItemCode} - ${item.ItemName}`;
            option.dataset.itemCode = item.ItemCode; 
            itemCodeSelect.appendChild(option);
        });

        // --- INICIALIZAR SELECT2 AQU√ç ---
        // Esto convierte el select normal en uno con b√∫squeda
        $('#ItemCode').select2({
            placeholder: "Escriba para buscar...",
            allowClear: true,
            width: '100%' // Asegura que ocupe todo el ancho
        });

        // --- IMPORTANTE: RE-VINCULAR EL EVENTO CHANGE ---
        // Select2 usa eventos de jQuery, as√≠ que escuchamos el cambio aqu√≠
        $('#ItemCode').on('select2:select', function (e) {
            // Simulamos el evento "change" nativo para que tu l√≥gica actual funcione
            itemCodeSelect.dispatchEvent(new Event('change'));
        });
        
    } catch (error) {
        console.error("‚ùå Error al cargar los activos:", error);
        Swal.fire("Error", "No se pudieron cargar los activos", "error");
    }
};

// Funci√≥n para cargar el empleado asignado a un activo
const loadEmpleadoPorActivo = async (activoId) => {
    try {
        const response = await fetch(`${API_URL_EMPLEADO_POR_ACTIVO}/${activoId}/empleado`, {
            headers: setAuthHeader()
        });
        if (!response.ok) {
            if (response.status === 404) {
                empleadoInput.value = "Sin asignaci√≥n";
                empleadoIdInput.value = "";
                return;
            }
            throw new Error("No se pudo obtener el empleado asignado");
        }
        const empleado = await response.json();
        empleadoInput.value = empleado.nombre || "Sin asignaci√≥n";
        empleadoIdInput.value = empleado.id || "";
        console.log("‚úÖ Empleado cargado:", empleado);
    } catch (error) {
        console.error("‚ùå Error al cargar empleado:", error);
        empleadoInput.value = "Sin asignaci√≥n";
        empleadoIdInput.value = "";
    }
};

// Funci√≥n para cargar informaci√≥n del activo seleccionado
const loadActivoInfo = async (itemCode) => {
    if (!itemCode) {
        textareaActivo.value = "";
        activoInput.value = "";
        activoRealIdInput.value = "";
        empleadoInput.value = "Seleccione un activo primero";
        empleadoIdInput.value = "";
        return;
    }

    try {
        const response = await fetch(`${API_URL_ACTIVOS}/${itemCode}`, {
            headers: setAuthHeader()
        });
        if (!response.ok) {
            throw new Error("Activo no encontrado");
        }
        const data = await response.json();
        console.log("‚úÖ Datos del activo encontrados:", data);

        // CORRECCI√ìN AQU√ç: Usamos parseFloat() para asegurar que el precio sea un n√∫mero
        const precioFormateado = data.Price ? `$${parseFloat(data.Price).toFixed(2)}` : "No disponible";

        // Mostrar informaci√≥n en el textarea
        const infoActivo = `
üìå C√≥digo del Producto: ${data.ItemCode || "No disponible"}
üè∑Ô∏è Nombre: ${data.ItemName || "No disponible"}
üè¢ Marca: ${data.marca || "No especificada"}
üè∑Ô∏è Modelo: ${data.modelo || "No especificado"}
üìÖ Fecha de Compra: ${data.fecha_compra ? data.fecha_compra.split("T")[0] : "No disponible"}
üí∞ Precio: ${precioFormateado}
üí≤ Moneda: ${data.Currency || "USD"}
üÜî ID del Activo: ${data.id || "No disponible"}
        `.trim();
        
        textareaActivo.value = infoActivo;
        
        // Actualizar inputs
        activoInput.value = `${data.ItemCode} - ${data.ItemName}`;
        activoRealIdInput.value = data.id;
        console.log(`‚úÖ activo_real_id actualizado a: ${data.id}`);

    } catch (error) {
        console.error("‚ùå Error al buscar el activo:", error);
        Swal.fire("Error", error.message, "error");
        textareaActivo.value = "";
        activoInput.value = "";
        activoRealIdInput.value = "";
        empleadoInput.value = "Seleccione un activo primero";
        empleadoIdInput.value = "";
    }
};

// Funci√≥n para cargar opciones en dropdown de usuarios
const loadDropdownOptions = async (url, selectElement, placeholder, keyName) => {
    try {
        const response = await fetch(url, {
            headers: setAuthHeader()
        });
        if (!response.ok) {
            throw new Error(`Error ${response.status}: No se pudieron cargar los ${placeholder}`);
        }
        const data = await response.json();
        console.log(`üì• Datos recibidos de ${placeholder}:`, data);

        selectElement.innerHTML = `<option value="">Seleccione ${placeholder}</option>`;
        data.forEach(item => {
            const option = document.createElement("option");
            option.value = item.id;
            option.textContent = keyName === "nombre" ? item.nombre : item.username;
            selectElement.appendChild(option);
        });
    } catch (error) {
        console.error(`‚ùå Error al cargar ${placeholder}:`, error);
        Swal.fire("Error", `No se pudieron cargar los ${placeholder}`, "error");
    }
};

// Manejo del formulario de registro (MODIFICADO PARA EVITAR DOBLE CLICK)
const registrarIncidencia = async (event) => {
    console.log("üìç Ejecutando registrarIncidencia");

    event.preventDefault();

    // 1. OBTENER EL BOT√ìN Y DESACTIVARLO
    // Intentamos obtener el bot√≥n que dispar√≥ el evento (moderno) o buscamos el bot√≥n submit
    const submitButton = event.submitter || form.querySelector('button[type="submit"]');
    let originalText = "";

    if (submitButton) {
        originalText = submitButton.textContent; // Guardamos texto original
        submitButton.disabled = true;            // Bloqueamos
        submitButton.textContent = "Procesando..."; // Feedback visual
        submitButton.style.cursor = "wait";
    }

    const data = {
        empleado_id: empleadoIdInput.value || null,
        usuario_id: usuarioSelect.value || null,
        descripcion: descripcionInput.value.trim(),
        activo_id: activoRealIdInput.value || null
    };

    console.log("üì§ Enviando incidencia:", JSON.stringify(data, null, 2));

    try {
        const response = await fetch(API_URL_INCIDENCIAS, {
            method: "POST",
            headers: setAuthHeader({ "Content-Type": "application/json" }),
            body: JSON.stringify(data),
        });
        const result = await response.json();
        console.log("üì• Respuesta del servidor:", result);

        if (!response.ok) {
            throw new Error(result.error || "Error al registrar la incidencia");
        }

        // Si todo sale bien, mantenemos el bot√≥n desactivado mientras redirigimos
        Swal.fire({
            title: "√âxito",
            text: "Incidencia registrada exitosamente",
            icon: "success"
        }).then(() => {
            form.reset();
            textareaActivo.value = "";
            activoInput.value = "";
            activoRealIdInput.value = "";
            itemCodeSelect.value = "";
            empleadoInput.value = "Seleccione un activo primero";
            empleadoIdInput.value = "";
            window.location.href = "/incidencias.html";
        });

    } catch (error) {
        console.error("‚ùå Error al registrar la incidencia:", error);
        Swal.fire("Error", error.message || "No se pudo registrar la incidencia", "error");

        // 2. EN CASO DE ERROR, REACTIVAR BOT√ìN
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || "Registrar"; // Restauramos texto
            submitButton.style.cursor = "pointer";
        }
    }
};

// Inicializar la p√°gina
document.addEventListener("DOMContentLoaded", async () => {
    const userData = await checkAuth();
    if (!userData) {
        window.location.href = "/login.html";
        return;
    }

  
    // Cargar datos iniciales
    await loadActivosDropdown();
    
    await loadDropdownOptions(API_URL_USUARIOS, usuarioSelect, "un Usuario", "username");

    // Evento para actualizar la informaci√≥n del activo y el empleado
    itemCodeSelect.addEventListener("change", async () => {
        const activoId = itemCodeSelect.value;
        const selectedOption = itemCodeSelect.options[itemCodeSelect.selectedIndex];
        const itemCode = selectedOption ? selectedOption.dataset.itemCode : "";
        if (activoId && itemCode) {
            await loadActivoInfo(itemCode);
            await loadEmpleadoPorActivo(activoId);
        } else {
            await loadActivoInfo("");
        }
    });

    form.addEventListener("submit", registrarIncidencia);
});

================
File: public/registrar-usuario.html
================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Usuario</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>
    <div class="container">
        <a href="/" class="back-button">‚¨ÖÔ∏è Regresar</a>
        <h1 class="title">üë©üèª‚Äçüíª Registrar Usuario </h1>
        <form id="userForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Ej. user123" maxlength="10" required>
            </div>
            <div class="form-group">
                <label for="correo">Correo</label>
                <input type="email" id="correo" class="form-control" placeholder="Ej. user123@example.com" required>
            </div>
            <div class="form-group">
                <label for="contrasena">Contrase√±a</label>
                <input type="password" id="contrasena" class="form-control" placeholder="Ej. MiClave123" required>
            </div>
            <div class="form-group">
                <label for="administrador">Administrador</label>
                <select id="administrador" class="form-control">
                    <option value="false">No</option>
                    <option value="true">S√≠</option>
                </select>
            </div>
            <div class="button-group">
                <button type="submit" class="btn">üíæ Registrar</button>
            </div>
        </form>
    </div>
    <script src="/auth.js"></script>
    <script src="registrar-usuario.js"></script>
    <script src="chatbot.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const userData = await checkAuth();
            if (!userData) {
                window.location.href = "/login.html";
            }
        });
    </script>
</body>
</html>

================
File: public/registrar-usuario.js
================
const API_URL = "api/usuarios";

document.getElementById("userForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const username = document.getElementById("username").value.trim();
    const correo = document.getElementById("correo").value.trim();
    const contrasena = document.getElementById("contrasena").value;
    
    // CORRECCI√ìN: Captura expl√≠cita del valor del select
    const adminSelect = document.getElementById("administrador");
    const adminValue = adminSelect.options[adminSelect.selectedIndex].value;
    
    // Convertimos a booleano real
    const esAdmin = (adminValue === "true" || adminValue === "1");

    if (!username || !correo || !contrasena) {
        alert("Todos los campos son obligatorios.");
        return;
    }

    const newUser = { 
        username, 
        correo, 
        contrasena, 
        administrador: esAdmin // Enviamos booleano puro (true/false)
    };

    console.log("üì§ Enviando datos:", newUser); // Para depurar en el navegador

    try {
        const res = await fetch("api/usuarios", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newUser),
        });
        const data = await res.json();
        
        if (res.ok) {
            Swal.fire({
                icon: "success",
                text: data.message,
                showConfirmButton: false,
                timer: 1000
            });
            document.getElementById("userForm").reset();
        } else {
            alert(data.error || "Error al registrar usuario");
        }
    } catch (error) {
        console.error("Error al registrar usuario:", error);
        alert("Error en la solicitud");
    }
});

================
File: public/ver-activos.html
================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activos Disponibles</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
    <a class="navbar-brand" href="/">
        <div class="navbar-brand"> üñ•Ô∏è CIaMS GESTOR <span class="version">V1</span> </div>
    </a>
    <div class="navbar-links">
        <a href="/ver-activos" class="nav-link">
            üì¶ <span>Activos</span>
        </a>
        <a href="/consultar-empleados" class="nav-link">
            üë• <span>Empleados</span>
        </a>
        <a href="/incidencias.html" class="nav-link">
            ‚ö†Ô∏è <span>Incidencias</span>
        </a>
        <a href="/configuracion.html" class="nav-link">
            ‚öôÔ∏è <span>Configuraci√≥n</span>
        </a>
    </div>
</nav>
    <div class="container">
        <a href="/" class="back-button">‚¨ÖÔ∏è Regresar</a>
        <h1 class="title">üñ•Ô∏è ACTIVOS DISPONIBLES</h1>

        <div class="search-bar">
            <label for="search">Buscar:</label>
            <input type="text" id="search" placeholder="Escriba aqu√≠...">
            <button id="search-button">üîé</button>
            <button id="btn-exportar-todo">üì• Exportar PDF o Excel</button>
        </div>

        <select id="filtro-area">
            <option value="">Todas las √°reas</option>
        </select>
        
        <select id="filtro-estado">
            <option value="">Todos los estados</option>
            <option value="Disponible">Disponible</option>
            <option value="P√©rdida">P√©rdida</option>
        </select>

        <select id="filtro-asignado">
            <option value="">Todos</option>
            <option value="asignado">Solo asignados</option>
            <option value="no_asignado">Solo no asignados</option>
        </select>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>C√≥digo del Producto</th>
                        <th>Nombre del Activo</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Fecha de Compra</th>
                        <th>Precio</th>
                        <th>Moneda</th>
                        <th>√Årea</th>
                        <th>N¬∞ Incidencias</th>
                        <th>Estado</th>
                        <th>Asignado a</th>
                        
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="10" style="text-align: center;">Cargando activos...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div id="pagination-controls" class="pagination-controls"></div>
    </div>
<div id="exportModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" id="modal-close">&times;</span>
        <h3>üì• Exportar Datos</h3>
        <p>Selecciona el formato:</p>
        <div class="export-options">
            <button id="btn-confirm-pdf" class="btn-export-option btn-pdf">
                üìÑ Descargar PDF
            </button>
            <button id="btn-confirm-excel" class="btn-export-option btn-excel">
                üìä Descargar Excel
            </button>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="auth.js"></script>
    <script src="ver-activos.js"></script>
    <script src="chatbot.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            if (typeof checkAuth === 'function') {
                const userData = await checkAuth();
                if (!userData) {
                    window.location.href = "login.html";
                }
            }
        });
    </script>
</body>
</html>

================
File: public/ver-activos.js
================
const API_URL = "api/activos";
const API_URL_EMPLEADOS = "api/empleados";
const API_URL_ASIGNACIONES = "api/asignaciones";

const tbody = document.querySelector(".data-table tbody");
const searchInput = document.getElementById("search");
const searchButton = document.getElementById("search-button");
const estadoFilter = document.getElementById("filtro-estado");
const asignadoFilter = document.getElementById("filtro-asignado");
const areaFilter = document.getElementById("filtro-area"); 

// --- VARIABLES DE PAGINACI√ìN ---
let currentPage = 1;
const itemsPerPage = 10;
let totalPages = 1;

// Obtener empleados
const getEmpleados = async () => {
    try {
        const response = await fetch(API_URL_EMPLEADOS, { credentials: 'include' });
        if (!response.ok) throw new Error(`Error ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error("‚ùå Error al obtener empleados:", error);
        return [];
    }
};

// Actualizar estado
const actualizarEstado = async (activoId, estado) => {
    try {
        const response = await fetch(`${API_URL}/${activoId}/estado`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ estado: estado }),
        });
        if (!response.ok) throw new Error(`‚ùå Error al actualizar estado. C√≥digo: ${response.status}`);
        
        alert("‚úÖ Estado actualizado correctamente.");
        loadActivos(searchInput ? searchInput.value.trim() : "");
    } catch (error) {
        console.error("‚ùå Error al actualizar estado:", error);
    }
};

// Asignar nuevo activo
const asignarNuevoActivo = async (activoId, empleadoId) => {
  try {
    const fechaAsignacion = new Date().toISOString().split("T")[0];
    const response = await fetch(`${API_URL}/${activoId}/asignar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        empleado_id: empleadoId,
        fecha_asignacion: fechaAsignacion
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Error al asignar el activo");

    alert("‚úÖ Activo asignado correctamente.");
    loadActivos(searchInput ? searchInput.value.trim() : "");
  } catch (error) {
    console.error("‚ùå Error al asignar activo:", error);
  }
};

// Cargar activos
const loadActivos = async (filter = "") => {
    try {
        const response = await fetch(API_URL, { credentials: 'include' });
        if (!response.ok) throw new Error(`Error ${response.status}`);
        
        const data = await response.json();
        const empleados = await getEmpleados();

        // Procesar empleados √∫nicos
        const empleadosUnicos = [];
        const idsVistos = new Set();
        empleados.forEach(emp => {
            if (!idsVistos.has(emp.id)) {
                empleadosUnicos.push(emp);
                idsVistos.add(emp.id);
            }
        });

        const empleadosMap = empleadosUnicos.reduce((map, emp) => {
            map[emp.id] = { nombre: emp.nombre, area_id: emp.area_id };
            return map;
        }, {});

        const activosConEmpleados = data.map(item => ({
            ...item,
            nombre_empleado: item.empleado_id_asignado
            ? (empleadosMap[item.empleado_id_asignado]?.nombre || "Desconocido")
            : "No asignado",
            area: item.area || "Sin √°rea"
        }));

        // Llenar filtro de √°reas si est√° vac√≠o
        if (areaFilter && areaFilter.options.length <= 1) { 
            const currentArea = areaFilter.value; 
            const areasUnicas = [...new Set(activosConEmpleados.map(i => i.area).filter(Boolean))];
            areaFilter.innerHTML = '<option value="">Todas las √°reas</option>';
            areasUnicas.forEach(area => {
                const option = document.createElement("option");
                option.value = area;
                option.textContent = area;
                if (area === currentArea) option.selected = true; 
                areaFilter.appendChild(option);
            });
        }

        // Filtros actuales
        const estadoSeleccionado = estadoFilter ? estadoFilter.value : "";
        const asignadoSeleccionado = asignadoFilter ? asignadoFilter.value : "";
        const areaSeleccionada = areaFilter ? areaFilter.value : "";
  
        const filteredData = activosConEmpleados.filter(item => {
            const searchTerm = filter.toLowerCase();
            const coincideBusqueda =
            (item.ItemCode && item.ItemCode.toLowerCase().includes(searchTerm)) ||
            (item.ItemName && item.ItemName.toLowerCase().includes(searchTerm)) ||
            (item.marca && item.marca.toLowerCase().includes(searchTerm)) ||
            (item.modelo && item.modelo.toLowerCase().includes(searchTerm)) ||
            (item.area && item.area.toLowerCase().includes(searchTerm));

            const coincideEstado = !estadoSeleccionado || item.estado === estadoSeleccionado;
            const coincideAsignado =
                !asignadoSeleccionado ||
                (asignadoSeleccionado === "asignado" && item.empleado_id_asignado && item.estado !== "P√©rdida") ||
                (asignadoSeleccionado === "no_asignado" && !item.empleado_id_asignado);

            const coincideArea = !areaSeleccionada || item.area === areaSeleccionada;

            return coincideBusqueda && coincideEstado && coincideAsignado && coincideArea;
        });

        // Paginaci√≥n
        totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (currentPage > totalPages) currentPage = 1;
        if (currentPage < 1) currentPage = 1;

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedItems = filteredData.slice(startIndex, endIndex);
        
        renderPaginationControls(); 

        if (!paginatedItems.length) {
            tbody.innerHTML = `<tr><td colspan="11" style="text-align: center;">
                ${filter ? "No se encontraron activos." : "No hay activos disponibles."}
            </td></tr>`;
            return;
        }

        tbody.innerHTML = "";

        paginatedItems.forEach(item => {
            const fechaCompra = item.fecha_compra ? item.fecha_compra.split("T")[0] : "No disponible";
            const marca = item.marca && item.marca.trim() ? item.marca : "No especificada";
            const modelo = item.modelo && item.modelo.trim() ? item.modelo : "No especificado";

            // L√≥gica Incidencias (ROJO)
            let incidenciasHtml = `<span style="color: #ccc;">0</span>`;
            if (item.total_incidencias > 0) {
                incidenciasHtml = `<span style="color: red; font-weight: bold; font-size: 1.2em;">${item.total_incidencias} üõ†Ô∏è</span>`;
            }

            // Selectores de tabla
            const estadoSelect = document.createElement("select");
            estadoSelect.classList.add("estado-select");
            ["Disponible", "P√©rdida"].forEach(estado => {
                const option = document.createElement("option");
                option.value = estado;
                option.textContent = estado;
                if (item.estado === estado) option.selected = true;
                estadoSelect.appendChild(option);
            });

            const actualizarEstadoButton = document.createElement("button");
            actualizarEstadoButton.textContent = "Guardar";
            actualizarEstadoButton.classList.add("btn-update");
            actualizarEstadoButton.addEventListener("click", () => actualizarEstado(item.id, estadoSelect.value));

            const propietarioSelect = document.createElement("select");
            propietarioSelect.classList.add("propietario-select");
            const placeholderOption = document.createElement("option");
            placeholderOption.value = "";
            placeholderOption.disabled = true;
            placeholderOption.textContent = "Seleccione un empleado";
            placeholderOption.selected = !item.empleado_id_asignado;
            propietarioSelect.appendChild(placeholderOption);

            empleadosUnicos.forEach(emp => {
                const option = document.createElement("option");
                option.value = emp.id;
                option.textContent = empleadosMap[emp.id]?.nombre || "Empleado sin nombre";
                if (item.empleado_id_asignado === emp.id) option.selected = true;
                propietarioSelect.appendChild(option);
            });

            const actualizarPropietarioButton = document.createElement("button");
            actualizarPropietarioButton.textContent = "Guardar";
            actualizarPropietarioButton.classList.add("btn-update");
            actualizarPropietarioButton.addEventListener("click", () => {
                const empleadoId = propietarioSelect.value;
                if (!empleadoId) return alert("Por favor, seleccione un empleado.");
                asignarNuevoActivo(item.id, empleadoId);
            });

            // Construcci√≥n Fila
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.ItemCode || "N/A"}</td>
                <td>${item.ItemName || "N/A"}</td>
                <td>${marca}</td>
                <td>${modelo}</td>
                <td>${fechaCompra}</td>
                <td>${item.Price ? `$${parseFloat(item.Price).toFixed(2)}` : "No disponible"}</td>
                <td>${item.Currency || "USD"}</td>
                <td>${item.area || "Sin √°rea"}</td>
                <td style="text-align: center;">${incidenciasHtml}</td>
            `;

            const estadoCell = document.createElement("td");
            estadoCell.appendChild(estadoSelect);
            estadoCell.appendChild(actualizarEstadoButton);
            row.appendChild(estadoCell);

            const propietarioCell = document.createElement("td");
            if (item.estado === "P√©rdida") {
                propietarioCell.textContent = "No asignable";
                propietarioCell.style.color = "gray";
                propietarioCell.style.textAlign = "center";
            } else {
                propietarioCell.appendChild(propietarioSelect);
                propietarioCell.appendChild(actualizarPropietarioButton);
            }
            row.appendChild(propietarioCell);

            tbody.appendChild(row);
        });

    } catch (error) {
        console.error("‚ùå Error al cargar activos:", error);
        tbody.innerHTML = `<tr><td colspan="11" style="text-align: center;">Error al cargar activos.</td></tr>`;
    }   
};

// --- RENDER PAGINATION ---
const renderPaginationControls = () => {
    let paginationContainer = document.getElementById("pagination-controls");
    if (!paginationContainer) {
        const tableContainer = document.querySelector(".table-container") || document.querySelector(".data-table");
        if (tableContainer) {
            paginationContainer = document.createElement("div");
            paginationContainer.id = "pagination-controls";
            paginationContainer.className = "pagination-controls";
            tableContainer.parentNode.insertBefore(paginationContainer, tableContainer.nextSibling);
        } else { return; }
    }

    paginationContainer.innerHTML = "";

    const prevButton = document.createElement("button");
    prevButton.textContent = "‚¨Ö Anterior";
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            loadActivos(searchInput ? searchInput.value.trim() : "");
        }
    };

    const nextButton = document.createElement("button");
    nextButton.textContent = "Siguiente ‚û°";
    nextButton.disabled = currentPage >= totalPages;
    nextButton.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            loadActivos(searchInput ? searchInput.value.trim() : "");
        }
    };
    
    const pageInfo = document.createElement("span");
    pageInfo.textContent = ` P√°gina ${currentPage} de ${totalPages > 0 ? totalPages : 1} `;

    paginationContainer.appendChild(prevButton);
    paginationContainer.appendChild(pageInfo);
    paginationContainer.appendChild(nextButton);
};

// --- FUNCIONES EXPORTAR (Sin modal ni listeners aqu√≠, solo l√≥gica) ---
async function exportarPDF() {
    const [activosRes, empleadosRes] = await Promise.all([
        fetch(API_URL, { credentials: "include" }),
        fetch(API_URL_EMPLEADOS, { credentials: "include" }),
    ]);

    const activos = await activosRes.json();
    const empleados = await empleadosRes.json();

    const estadoFiltro = document.getElementById("filtro-estado") ? document.getElementById("filtro-estado").value : "";
    const asignadoFiltro = document.getElementById("filtro-asignado") ? document.getElementById("filtro-asignado").value : "";
    const areaFiltro = document.getElementById("filtro-area") ? document.getElementById("filtro-area").value : "";

    let activosFiltrados = activos;

    if (estadoFiltro) activosFiltrados = activosFiltrados.filter(a => a.estado === estadoFiltro);
    if (asignadoFiltro === "asignado") activosFiltrados = activosFiltrados.filter(a => a.empleado_id_asignado && a.estado !== "P√©rdida");
    else if (asignadoFiltro === "no_asignado") activosFiltrados = activosFiltrados.filter(a => !a.empleado_id_asignado);
    if (areaFiltro) activosFiltrados = activosFiltrados.filter(a => a.area === areaFiltro);

    const empleadoMap = {};
    empleados.forEach(e => { empleadoMap[e.id] = e.nombre; });

    const fechaReporte = new Date().toLocaleString();
    const jspdfLib = window.jspdf || window.jsPDF;
    if (!jspdfLib) return alert("Error: La librer√≠a jsPDF no se encontr√≥.");
    
    const { jsPDF } = jspdfLib.umd ? jspdfLib.umd : (typeof jspdfLib === 'function' ? { jsPDF: jspdfLib } : jspdfLib);
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("Reporte de Activos", 14, 20);
    doc.setFontSize(10);
    doc.text(`Fecha del reporte: ${fechaReporte}`, 14, 28);

    const rowsPDF = activosFiltrados.map(activo => [
        activo.ItemCode || "N/A",
        activo.ItemName || "N/A",
        activo.marca || "No especificada",
        activo.modelo || "No especificado",
        activo.fecha_compra ? activo.fecha_compra.split("T")[0] : "No disponible",
        activo.Price ? `$${activo.Price.toFixed(2)}` : "No disponible",
        activo.Currency || "USD",
        activo.estado || "No especificado",
        empleadoMap[activo.empleado_id_asignado] || "No asignado",
        activo.area || "Sin √°rea",
        activo.total_incidencias || 0 
    ]);

    doc.autoTable({
        head: [["C√≥digo", "Nombre", "Marca", "Modelo", "Fecha Compra", "Precio", "Moneda", "Estado", "Asignado a", "√Årea", "N¬∞ Incidencias"]],
        body: rowsPDF,
        startY: 35
    });

    doc.save("reporte_activos.pdf");
}

async function exportarExcel() {
  const [activosRes, empleadosRes] = await Promise.all([
    fetch(API_URL, { credentials: "include" }),
    fetch(API_URL_EMPLEADOS, { credentials: "include" }),
  ]);

  const activos = await activosRes.json();
  const empleados = await empleadosRes.json();

  const empleadoMap = {};
  empleados.forEach(e => { empleadoMap[e.id] = e.nombre; });

  const estadoFiltro = document.getElementById("filtro-estado") ? document.getElementById("filtro-estado").value : "";
  const asignadoFiltro = document.getElementById("filtro-asignado") ? document.getElementById("filtro-asignado").value : "";
  const areaFiltro = document.getElementById("filtro-area") ? document.getElementById("filtro-area").value : "";

  let activosFiltrados = activos;

  if (estadoFiltro) activosFiltrados = activosFiltrados.filter(a => a.estado === estadoFiltro);
  if (asignadoFiltro === "asignado") activosFiltrados = activosFiltrados.filter(a => a.empleado_id_asignado && a.estado !== "P√©rdida");
  else if (asignadoFiltro === "no_asignado") activosFiltrados = activosFiltrados.filter(a => !a.empleado_id_asignado);
  if (areaFiltro) activosFiltrados = activosFiltrados.filter(a => a.area === areaFiltro);

  const rows = [
    ["C√≥digo", "Nombre", "Marca", "Modelo", "Fecha Compra", "Precio", "Moneda", "Estado", "Asignado a", "√Årea", "N¬∞ Incidencias"],
    ...activosFiltrados.map(activo => [
      activo.ItemCode || "N/A",
      activo.ItemName || "N/A",
      activo.marca || "No especificada",
      activo.modelo || "No especificado",
      activo.fecha_compra ? activo.fecha_compra.split("T")[0] : "No disponible",
      activo.Price ? `$${activo.Price.toFixed(2)}` : "No disponible",
      activo.Currency || "USD",
      activo.estado || "No especificado",
      empleadoMap[activo.empleado_id_asignado] || "No asignado",
      activo.area || "Sin √°rea",
      activo.total_incidencias || 0
    ])
  ];

  if (typeof XLSX === 'undefined') return alert("La librer√≠a de Excel a√∫n no ha cargado.");
  
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Activos");
  XLSX.writeFile(wb, "reporte_activos.xlsx");
}

// --- EVENT LISTENERS (DOM LOADED) ---
document.addEventListener("DOMContentLoaded", () => {
    // 1. Cargar Datos
    loadActivos();

    // 2. Filtros y B√∫squeda
    if (searchButton) searchButton.addEventListener("click", () => { currentPage = 1; loadActivos(searchInput.value.trim()); });
    if (searchInput) searchInput.addEventListener("input", () => { currentPage = 1; loadActivos(searchInput.value.trim()); });
    if (estadoFilter) estadoFilter.addEventListener("change", () => {
        currentPage = 1;
        if (estadoFilter.value === "P√©rdida" && asignadoFilter) { asignadoFilter.disabled = true; asignadoFilter.value = ""; } 
        else if (asignadoFilter) { asignadoFilter.disabled = false; }
        loadActivos(searchInput ? searchInput.value.trim() : "");
    });
    if (asignadoFilter) asignadoFilter.addEventListener("change", () => { currentPage = 1; loadActivos(searchInput ? searchInput.value.trim() : ""); });
    if (areaFilter) areaFilter.addEventListener("change", () => { currentPage = 1; loadActivos(searchInput ? searchInput.value.trim() : ""); });

    // 3. L√ìGICA DEL MODAL DE EXPORTACI√ìN (SEGURA)
    const exportModal = document.getElementById("exportModal");
    const btnOpen = document.getElementById("btn-exportar-todo");
    const btnClose = document.getElementById("modal-close");
    const btnPdf = document.getElementById("btn-confirm-pdf");
    const btnExcel = document.getElementById("btn-confirm-excel");

    // Abrir Modal
    if (btnOpen) {
        btnOpen.addEventListener("click", () => {
            if (exportModal) exportModal.style.display = "flex";
        });
    }

    // Cerrar Modal
    const cerrarModal = () => {
        if (exportModal) exportModal.style.display = "none";
    };

    if (btnClose) btnClose.addEventListener("click", cerrarModal);

    // Cerrar si clic fuera
    window.addEventListener("click", (event) => {
        if (event.target === exportModal) cerrarModal();
    });

    // Acci√≥n PDF
    if (btnPdf) {
        btnPdf.addEventListener("click", async () => {
            cerrarModal();
            Swal.fire({ title: 'Generando PDF...', didOpen: () => Swal.showLoading() });
            await exportarPDF();
            Swal.close();
        });
    }

    // Acci√≥n Excel
    if (btnExcel) {
        btnExcel.addEventListener("click", async () => {
            cerrarModal();
            Swal.fire({ title: 'Generando Excel...', didOpen: () => Swal.showLoading() });
            await exportarExcel();
            Swal.close();
        });
    }
});

================
File: public/ver-incidencias.js
================
const API_URL_INCIDENCIAS = "api/incidencias";
const API_URL_MANTENIMIENTO = "api/mantenimientos";

const tbody = document.querySelector(".data-table tbody");
const searchInput = document.getElementById("search");
const searchButton = document.getElementById("search-button");

const getIncidencias = async () => {
    try {
        const response = await fetch(API_URL_INCIDENCIAS, {
            headers: setAuthHeader()
        });

        if (!response.ok) throw new Error("‚ùå No se pudieron obtener las incidencias.");

        const incidencias = await response.json();
        console.log("Datos crudos recibidos:", incidencias);

        return incidencias.map(incidencia => ({
            id: incidencia.id,
            nombre_activo: incidencia.nombre_activo || "Desconocido",
            nombre_empleado: incidencia.nombre_empleado || "No asignado",
            descripcion: incidencia.descripcion || "Sin descripci√≥n",
            fecha_reporte: incidencia.fecha_reporte
                ? incidencia.fecha_reporte.split("T")[0]
                : "No disponible",
            estado_equipo: incidencia.estado_equipo ?? null,
            fin_mantenimiento: incidencia.fin_mantenimiento || null
        }));
    } catch (error) {
        console.error("‚ùå Error al obtener incidencias:", error);
        return [];
    }
};

const iniciarMantenimiento = async (incidenciaId, iniciarBtn, finalizarBtn) => {
    const fechaActual = new Date().toISOString().split("T")[0];

    try {
        const response = await fetch(`${API_URL_MANTENIMIENTO}/iniciar`, {
            method: "POST",
            headers: setAuthHeader({ "Content-Type": "application/json" }),
            body: JSON.stringify({
                incidencia_id: incidenciaId,
                init_mantenimiento: fechaActual
            }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Error al iniciar mantenimiento");

        alert("‚úÖ Mantenimiento iniciado");
        window.location.reload();
    } catch (error) {
        console.error("‚ùå Error al iniciar mantenimiento:", error);
    }
};

const finalizarMantenimiento = async (incidenciaId, finalizarBtn, finalizadoSpan) => {
    const fechaActual = new Date().toISOString().split("T")[0];

    try {
        const response = await fetch(`${API_URL_MANTENIMIENTO}/finalizar`, {
            method: "POST",
            headers: setAuthHeader({ "Content-Type": "application/json" }),
            body: JSON.stringify({
                id: incidenciaId,
                fin_mantenimiento: fechaActual
            }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Error al finalizar mantenimiento");

        alert("‚úÖ Mantenimiento finalizado");
        window.location.reload();
    } catch (error) {
        console.error("‚ùå Error al finalizar mantenimiento:", error);
    }
};

const loadIncidencias = async (filter = "") => {
    tbody.innerHTML = "";

    const incidencias = await getIncidencias();
    const incidenciasFiltradas = incidencias.filter(i =>
        i.nombre_activo?.toLowerCase().includes(filter.toLowerCase()) ||
        i.nombre_empleado?.toLowerCase().includes(filter.toLowerCase())
    );

    if (incidenciasFiltradas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No hay incidencias registradas.</td></tr>`;
        return;
    }

    incidenciasFiltradas.forEach(incidencia => {
        const esFinalizado = !!incidencia.fin_mantenimiento;


        const row = document.createElement("tr");

        // Celdas b√°sicas
        row.appendChild(createCell(incidencia.nombre_activo));
        row.appendChild(createCell(incidencia.nombre_empleado));
        row.appendChild(createCell(incidencia.descripcion));
        row.appendChild(createCell(incidencia.fecha_reporte));

        // Celda de estado
        const estadoCell = document.createElement("td");
        const estadoSpan = document.createElement("span");
        const color = esFinalizado ? "verde" : "amarillo";
        estadoSpan.className = "estado-equipo " + (esFinalizado ? "verde" : "amarillo");
estadoSpan.textContent = esFinalizado ? "verde" : "amarillo";

        estadoCell.appendChild(estadoSpan);
        row.appendChild(estadoCell);

        // Celda de acciones
        const accionesCell = document.createElement("td");

        const iniciarBtn = document.createElement("button");
        iniciarBtn.textContent = "Iniciar";
        iniciarBtn.className = "btn-iniciar";

        const finalizarBtn = document.createElement("button");
        finalizarBtn.textContent = "Finalizar";
        finalizarBtn.className = "btn-finalizar";

        const finalizadoSpan = document.createElement("span");
        finalizadoSpan.textContent = "‚úÖ Solucionado";
        finalizadoSpan.style.fontWeight = "bold";
        finalizadoSpan.style.color = "green";

        // Estado visual de botones y texto
        if (esFinalizado) {
            iniciarBtn.style.display = "none";
            finalizarBtn.style.display = "none";
            finalizadoSpan.style.display = "inline-block";
        } else {
            iniciarBtn.style.display = "inline-block";
            finalizarBtn.style.display = "none";
            finalizadoSpan.style.display = "none";

            // Si es amarillo, se muestra el bot√≥n de finalizar
            if (incidencia.estado_equipo === "amarillo" || incidencia.estado_equipo === null) {
                iniciarBtn.style.display = "none";
                finalizarBtn.style.display = "inline-block";
            }
        }

        iniciarBtn.addEventListener("click", () => {
            iniciarMantenimiento(incidencia.id, iniciarBtn, finalizarBtn);
        });

        finalizarBtn.addEventListener("click", () => {
            finalizarMantenimiento(incidencia.id, finalizarBtn, finalizadoSpan);
        });

        accionesCell.appendChild(iniciarBtn);
        accionesCell.appendChild(finalizarBtn);
        accionesCell.appendChild(finalizadoSpan);
        row.appendChild(accionesCell);

        tbody.appendChild(row);
    });
};

// Funci√≥n auxiliar
function createCell(text) {
    const td = document.createElement("td");
    td.textContent = text || "";
    return td;
}

================
File: README.md
================
# üñ•Ô∏è CIaMS GESTOR V1.2

Sistema integral para la gesti√≥n de activos de TI, control de inventario, incidencias y mantenimiento, potenciado por Inteligencia Artificial.

![Estado del Proyecto](https://img.shields.io/badge/Estado-Producci√≥n-success)
![Versi√≥n](https://img.shields.io/badge/Versi√≥n-1.0.0-blue)
![Tech Stack](https://img.shields.io/badge/Stack-Node.js%20|%20MySQL%20|%20Groq%20AI-blueviolet)

## üöÄ Nuevas Caracter√≠sticas (v1.0)

### ü§ñ Integraci√≥n de Inteligencia Artificial
- **Chatbot Gu√≠a ("CIaMS-BOT")**: Asistente virtual flotante disponible 24/7 que responde dudas sobre el funcionamiento del sistema, flujos de trabajo y significados de iconos/colores.
- **Diagn√≥stico Inteligente**: M√≥dulo en la gesti√≥n de incidencias que analiza la descripci√≥n del problema y sugiere:
  - ü©∫ Diagn√≥stico t√©cnico probable.
  - üõ†Ô∏è Pasos de soluci√≥n recomendados.
  - üìâ Nivel de riesgo (Bajo/Medio/Alto).

### üìä Gesti√≥n Visual de Activos
- **Alertas de Desgaste**: La tabla de activos ahora incluye una columna **"N¬∞ Incidencias"**.
  - üî¥ **Icono Rojo üõ†Ô∏è**: Indica activos problem√°ticos con historial de fallas reportadas.
  - ‚ö™ **Gris**: Indica equipos estables sin reportes previos.
- **Filtros Avanzados**: B√∫squeda por √°rea, estado y asignaci√≥n en tiempo real.

### üõ°Ô∏è Auditor√≠a y Seguridad
- **Manejo de Errores Centralizado**: Sistema robusto que captura y estandariza errores de validaci√≥n, base de datos y autenticaci√≥n.
- **Protecci√≥n**: Implementaci√≥n de Rate Limiting, Helmet (Headers seguros) y prevenci√≥n de contaminaci√≥n de par√°metros (HPP).

---

## üìã M√≥dulos Principales

1. **Gesti√≥n de Activos**: CRUD completo, asignaci√≥n a empleados, control de estados (Disponible, P√©rdida, Mantenimiento).
2. **Gesti√≥n de Empleados**: Registro con validaci√≥n de datos y asignaci√≥n autom√°tica de √°reas.
3. **Mesa de Ayuda (Incidencias)**: 
   - Ciclo de vida completo: Reporte ‚ûù Diagn√≥stico IA ‚ûù Mantenimiento ‚ûù Soluci√≥n.
   - Control de tiempos (Fecha reporte vs. Fecha soluci√≥n).
4. **Usuarios y Roles**: Sistema de login seguro (JWT) con roles de Administrador y Usuario Est√°ndar.

## üõ†Ô∏è Tecnolog√≠as

- **Backend**: Node.js, Express.
- **Base de Datos**: MySQL (Uso intensivo de Stored Procedures).
- **IA**: OpenAI SDK conectado a **Groq (Llama-3.3-70b)** para inferencia de alta velocidad.
- **Frontend**: HTML5, CSS3 (Dise√±o Responsive), JavaScript Vanilla.
- **Seguridad**: BCrypt, JWT, Helmet, Express-Rate-Limit.

## ‚öôÔ∏è Instalaci√≥n y Configuraci√≥n

1. **Clonar el repositorio**:
   ```bash
   git clone <url-del-repo>
   cd cims-gestor
Instalar dependencias:

Bash
npm install
Configurar Variables de Entorno (.env): Crea un archivo .env en la ra√≠z con lo siguiente:

Fragmento de c√≥digo
# Base de Datos
DB_HOST=tu_host
DB_USER=tu_usuario
DB_PASSWORD=tu_password
DB_NAME=gestcims_gestionactivosti

# Servidor
PORT=3000
NODE_ENV=production

# Seguridad
JWT_SECRET=tu_clave_secreta_super_segura

# Inteligencia Artificial (Groq Cloud)
OPENAI_API_KEY=gsk_tu_api_key_de_groq_aqui
Iniciar:

Bash
npm start
üìÑ Estructura de Directorios Clave
‚îú‚îÄ‚îÄ middleware/         # üõ°Ô∏è L√≥gica de seguridad y manejo de errores
‚îú‚îÄ‚îÄ public/             # üé® Frontend (HTML/JS/CSS)
‚îÇ   ‚îú‚îÄ‚îÄ chatbot.js      # L√≥gica del asistente virtual
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ routes/             # üõ£Ô∏è Rutas de la API
‚îÇ   ‚îú‚îÄ‚îÄ iaRoutes.js     # Conexi√≥n con el servicio de IA
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ utils/              # üîß Utilidades y clases de error personalizadas
‚îî‚îÄ‚îÄ server.js           # Punto de entrada
üë®‚Äçüíª Autor
Sistema desarrollado para optimizar la gesti√≥n de infraestructura TI empresarial.


---

### üìÑ Archivo 2: `DEPLOY.md`
*(Actualiza la secci√≥n "C. Crear Archivo .env" para incluir la IA)*

```markdown
#### C. Crear Archivo .env
Crea un archivo `.env` en la ra√≠z del proyecto. **¬°IMPORTANTE!** Ahora se requiere la clave de API para la IA.

```env
# Configuraci√≥n de Base de Datos
DB_HOST=tu_host_de_mysql
DB_USER=tu_usuario_mysql
DB_PASSWORD=tu_contrase√±a_mysql
DB_NAME=nombre_de_tu_base_de_datos
DB_PORT=3306

# Configuraci√≥n del Servidor
PORT=3000
NODE_ENV=production
ALLOWED_ORIGINS=[https://tu-dominio.com](https://tu-dominio.com)

# Seguridad (‚ö†Ô∏è CAMBIAR por una clave √∫nica)
JWT_SECRET=tu_clave_secreta_super_segura_aqui

# Inteligencia Artificial (Groq)
# Requerido para el Chatbot y el Diagn√≥stico de Incidencias
OPENAI_API_KEY=gsk_tu_clave_api_de_groq
üìÑ Archivo 3: ERROR_HANDLING.md
(A√±ade esto al final de la secci√≥n "Componentes" para documentar la IA)

Markdown
### 4. Manejo de Errores en Servicios Externos (IA)

Para las integraciones con APIs externas (como Groq/OpenAI en `iaRoutes.js`), el sistema implementa:
- **Bloques Try-Catch**: Capturan fallos de red o de la API externa.
- **Fallbacks**: Si la IA falla, el sistema devuelve un mensaje amigable al usuario (`500: El asistente est√° en mantenimiento`) sin tumbar el servidor.
- **Logging**: Se registra el error espec√≠fico de la API en la consola del servidor para depuraci√≥n, pero no se expone al cliente.

================
File: routes/activoRoutes.js
================
// actualizado para trabajar con la nueva estructura del SQL
const express = require('express');
const router = express.Router();
const db = require('../config/database');

// Crear un activo (POST)
router.post('/activos', (req, res, next) => {
    
    let activos = req.body;

    if (!Array.isArray(activos)) {
        activos = [activos];
    }

    if (activos.length === 0) {
        return res.status(400).json({ error: 'Se requiere al menos un activo' });
    }

    const query = `CALL InsertarActivo(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`;

    let errores = 0;
    let insertados = 0;

    activos.forEach((activo, index) => {
        const values = [
            activo.ItemCode,
            activo.ItemName ? activo.ItemName.toUpperCase() : "NO ESPECIFICADO",
            activo.marca && activo.marca.trim() ? activo.marca.toUpperCase() : "NO ESPECIFICADA",
            activo.modelo && activo.modelo.trim() ? activo.modelo.toUpperCase() : "NO ESPECIFICADO",
            activo.fecha_compra || new Date().toISOString().split('T')[0],
            activo.Price || 0.00,
            activo.Currency || "USD",
            activo.BarCode || null,
            activo.QuantityOnStock || 0,
            activo.ItemsGroupCode || null,
            activo.FechaBaja || null,
            activo.MotivoBaja || null
        ];

        db.query(query, values, (err, result) => {
            if (err) {
                console.error(`‚ùå Error al registrar activo ${index + 1}:`, err);
                errores++;
            } else {
                insertados++;
            }

            // Cuando termina de procesar todos
            if (index === activos.length - 1) {
                if (errores > 0) {
                    return res.status(500).json({ 
                        message: `Activos procesados: ${activos.length}. Insertados: ${insertados}. Errores: ${errores}` 
                    });
                } else {
                    return res.status(201).json({ 
                        message: `‚úÖ Todos los activos (${insertados}) registrados exitosamente.` 
                    });
                }
            }
        });
    });
});


// Ruta para buscar un activo por ItemCode (N√∫mero de serie)
router.get('/activos/numero-serie/:ItemCode', (req, res, next) => {

  const { ItemCode } = req.params;
  const query = 'CALL BuscarActivoPorItemCode(?)';

  db.query(query, [ItemCode], (err, results) => {
    if (err) {
      console.error('‚ùå Error al buscar el activo:', err);
      return res.status(500).json({ error: 'Error al buscar el activo' });
    }
    const activo = results[0];
    if (activo.length === 0) {
      return res.status(404).json({ error: 'Activo no encontrado' });
    }
    res.status(200).json(activo[0]);
  });
});


router.get('/activos', (req, res, next) => {
    // CAMBIO: Renombramos el alias a 'total_incidencias' para reflejar "Problemas reportados"
    const query = `
        SELECT 
            a.*, 
            (SELECT COUNT(*) FROM mantenimiento WHERE activo_id = a.id) AS total_incidencias,
            aea.empleado_id AS empleado_id_asignado,
            emp.nombre AS nombre_empleado,
            ar.nombre AS area
        FROM activo a
        LEFT JOIN activo_empleado_area aea ON aea.activo_id = a.id AND aea.fecha_retiro IS NULL
        LEFT JOIN empleado emp ON emp.id = aea.empleado_id
        LEFT JOIN area ar ON ar.id = aea.area_id
    `;

    db.query(query, (err, results) => {
        if (err) {
            console.error('‚ùå Error al obtener activos:', err);
            return res.status(500).json({ error: 'Error al obtener activos' });
        }
        res.status(200).json(results);
    });
});


// Obtener un activo por ID (GET)
router.get('/activos/:id', (req, res, next) => {

  const { id } = req.params;
  const query = 'CALL BuscarActivoPorID(?)';

  db.query(query, [id], (err, results) => {
    if (err) {
      console.error('‚ùå Error al obtener el activo:', err);
      return res.status(500).json({ error: 'Error al obtener el activo' });
    }
    const activo = results[0];
    if (activo.length === 0) {
      return res.status(404).json({ error: 'Activo no encontrado' });
    }
    res.status(200).json(activo[0]);
  });
});


// Nueva ruta para obtener el empleado asignado a un activo
router.get('/activos/:activo_id/empleado', (req, res) => {
    const { activo_id } = req.params;
    const query = 'CALL ObtenerEmpleadoDeActivo(?)';

    db.query(query, [activo_id], (err, results) => {
        if (err) {
            console.error('‚ùå Error al obtener el empleado asignado:', err);
            return res.status(500).json({ error: 'Error al obtener el empleado asignado' });
        }

        if (results[0].length === 0) {
            return res.status(404).json({ error: 'No hay empleado asignado a este activo' });
        }

        res.status(200).json(results[0][0]);
    });
});


// Actualizar un activo (PUT)
router.put('/activos/:id', (req, res, next) => {

  const { id } = req.params;
  const { ItemCode, ItemName, marca, modelo, fecha_compra, Price, Currency, BarCode, QuantityOnStock, ItemsGroupCode, FechaBaja, MotivoBaja } = req.body;

  const query = 'CALL ActualizarActivo(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)';

  db.query(query, [
    id,
    ItemCode,
    ItemName ? ItemName.toUpperCase() : "NO ESPECIFICADO",
    marca && marca.trim() ? marca.toUpperCase() : "NO ESPECIFICADA",
    modelo && modelo.trim() ? modelo.toUpperCase() : "NO ESPECIFICADO",
    fecha_compra,
    Price,
    Currency,
    BarCode,
    QuantityOnStock,
    ItemsGroupCode,
    FechaBaja,
    MotivoBaja
  ], (err, result) => {
    if (err) {
      console.error('‚ùå Error al actualizar el activo:', err);
      return res.status(500).json({ error: 'Error al actualizar el activo' });
    }
    if (result.affectedRows === 0) {
      return res.status(404).json({ error: 'Activo no encontrado' });
    }
    res.status(200).json({ message: '‚úÖ Activo actualizado exitosamente' });
  });
});


// Actualizar el estado de un activo (PUT)
router.put('/activos/:id/estado', (req, res, next) => {

    const { id } = req.params;
    const { estado } = req.body;

    if (!['Disponible', 'P√©rdida'].includes(estado)) {
        return res.status(400).json({ error: 'Estado inv√°lido. Debe ser "Disponible" o "P√©rdida".' });
    }

    const query = 'CALL ActualizarEstadoActivo(?, ?)';

    db.query(query, [id, estado], (err, result) => {
        if (err) {
            console.error('‚ùå Error al actualizar el estado del activo:', err);
            return res.status(500).json({ error: 'Error al actualizar el estado del activo' });
        }

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'Activo no encontrado' });
        }

        res.status(200).json({ message: '‚úÖ Estado del activo actualizado exitosamente' });
    });
});


// Nuevo: Asignar activo a empleado y √°rea
router.post('/activos/:id/asignar', (req, res, next) => {

    const { id } = req.params;
    const { empleado_id, fecha_asignacion } = req.body;

    if (!empleado_id || !fecha_asignacion) {
        return res.status(400).json({ error: 'empleado_id y fecha_asignacion son requeridos' });
    }

    const query = `CALL AsignarActivo(?, ?, ?)`;
    db.query(query, [id, empleado_id, fecha_asignacion], (err) => {
        if (err) {
            console.error('‚ùå Error al asignar activo:', err);
            return res.status(500).json({ error: 'Error al asignar activo' });
        }
        res.status(201).json({ message: '‚úÖ Activo asignado exitosamente' });
    });
});



// Eliminar un activo (DELETE)
// router.delete('/activos/:id', (req, res) => {
//     const { id } = req.params;

//     const query = 'DELETE FROM activo WHERE id = ?';

//     db.query(query, [id], (err, result) => {
//         if (err) {
//             console.error('‚ùå Error al eliminar el activo:', err);
//             return res.status(500).json({ error: 'Error al eliminar el activo' });
//         }
//         if (result.affectedRows === 0) {
//             return res.status(404).json({ error: 'Activo no encontrado' });
//         }
//         res.status(200).json({ message: '‚úÖ Activo eliminado exitosamente' });
//     });
// });

router.get('/activos/por-empleado/:empleado_id', (req, res, next) => {

  const { empleado_id } = req.params;

  const query = 'CALL ObtenerActivoPorEmpleado(?)';

  db.query(query, [empleado_id], (err, results) => {
    if (err) {
      console.error('‚ùå Error al buscar activo:', err);
      return res.status(500).json({ error: 'Error al buscar activo' });
    }

    const activoResults = results[0];

    if (activoResults.length === 0) {
      return res.json({ nombre_activo: "Desconocido" });
    }

    res.json(activoResults[0]);
  });
});


module.exports = router;

================
File: routes/administradorRoutes.js
================
const express = require('express');
const router = express.Router();
const db = require('../config/database');



// Crear un administrador (POST)
router.post('/administradores', (req, res) => {
    const { nombre, correo, contrasena } = req.body;

    // Validaci√≥n b√°sica
    if (!nombre || !correo || !contrasena) {
        return res.status(400).json({ error: 'Todos los campos son obligatorios (nombre, correo, contrasena)' });
    }

    const query = `
        INSERT INTO administrador (nombre, correo, contrasena, fecha_creacion) 
        VALUES (?, ?, ?, DEFAULT)
    `;
    db.query(query, [nombre, correo, contrasena], (err, result) => {
        if (err) {
            console.error('Error al insertar administrador:', err.sqlMessage || err);
            return res.status(500).json({ error: 'Error al crear el administrador' });
        }
        res.status(201).json({ message: 'Administrador creado exitosamente', id: result.insertId });
    });
});
// Obtener todos los administradores por id (GET)
// Obtener un administrador por ID
router.get('/administradores/:id', (req, res) => {
    const { id } = req.params; // Obt√©n el ID de los par√°metros de la URL
    const query = 'SELECT * FROM administrador WHERE id = ?';

    db.query(query, [id], (err, results) => {
        if (err) {
            console.error('Error al obtener el administrador:', err.sqlMessage || err);
            return res.status(500).json({ error: 'Error al obtener el administrador' });
        }

        if (results.length === 0) {
            return res.status(404).json({ error: 'Administrador no encontrado' });
        }

        res.status(200).json(results[0]); // Env√≠a el administrador encontrado
    });
});
// Obtener todos los administradores (GET)
router.get('/administradores', (req, res) => {
    const query = 'SELECT * FROM administrador'; // Consulta para obtener todos los registros

    db.query(query, (err, results) => {
        if (err) {
            console.error('Error al obtener los administradores:', err.sqlMessage || err);
            return res.status(500).json({ error: 'Error al obtener los administradores' });
        }

        res.status(200).json(results); // Devuelve todos los registros como un arreglo
    });
});


// Actualizar un administrador (PUT)
router.put('/administradores/:id', (req, res) => {
    const { id } = req.params; // ID del administrador a actualizar
    const { nombre, correo, contrasena } = req.body;

    const query = `
        UPDATE administrador 
        SET nombre = ?, correo = ?, contrasena = ? 
        WHERE id = ?
    `;

    db.query(query, [nombre, correo, contrasena, id], (err, result) => {
        if (err) {
            console.error('Error al actualizar el administrador:', err.sqlMessage || err);
            return res.status(500).json({ error: 'Error al actualizar el administrador' });
        }
        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'Administrador no encontrado' });
        }
        res.status(200).json({ message: 'Administrador actualizado exitosamente' });
    });
});
// Eliminar un administrador (DELETE)
router.delete('/administradores/:id', (req, res) => {
    const { id } = req.params; // ID del administrador a eliminar

    const query = `DELETE FROM administrador WHERE id = ?`;

    db.query(query, [id], (err, result) => {
        if (err) {
            console.error('Error al eliminar el administrador:', err.sqlMessage || err);
            return res.status(500).json({ error: 'Error al eliminar el administrador' });
        }
        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'Administrador no encontrado' });
        }
        res.status(200).json({ message: 'Administrador eliminado exitosamente' });
    });
});



module.exports = router;

================
File: routes/areaRoutes.js
================
const express = require('express');
const router = express.Router();
const db = require('../config/database');

router.post('/areas', (req, res) => {
  const { nombre } = req.body;
  if (!nombre) {
    return res.status(400).json({ error: 'El nombre del √°rea es obligatorio' });
  }

  const query = 'CALL CrearArea(?)';

  db.query(query, [nombre], (err, result) => {
    if (err) {
      console.error('‚ùå Error al crear el √°rea:', err);
      return res.status(500).json({ error: 'Error al crear el √°rea' });
    }
    res.status(201).json({ message: '‚úÖ √Årea creada exitosamente', id: result[0].insertId });
  });
});


// Obtener todas las √°reas (GET)
router.get('/areas', (req, res) => {
    const query = 'CALL ObtenerAreas()';
    db.query(query, (err, results) => {
        if (err) {
            console.error('‚ùå Error al obtener √°reas:', err);
            return res.status(500).json({ error: 'Error al obtener √°reas' });
        }
        res.status(200).json(results[0]);  // results[0] porque CALL devuelve un array de arrays
    });
});

// Obtener un √°rea por ID (GET)
router.get('/areas/:id', (req, res) => {
  const { id } = req.params;
  const query = 'CALL ObtenerAreaPorID(?)';

  db.query(query, [id], (err, results) => {
    if (err) {
      console.error('‚ùå Error al obtener el √°rea:', err);
      return res.status(500).json({ error: 'Error al obtener el √°rea' });
    }
    const area = results[0];
    if (area.length === 0) {
      return res.status(404).json({ error: '√Årea no encontrada' });
    }
    res.status(200).json(area[0]);
  });
});


// Actualizar un √°rea (PUT)
router.put('/areas/:id', (req, res) => {
  const { id } = req.params;
  const { nombre } = req.body;

  if (!nombre) {
    return res.status(400).json({ error: 'El nombre del √°rea es obligatorio' });
  }

  const query = 'CALL ActualizarArea(?, ?)';

  db.query(query, [id, nombre], (err, result) => {
    if (err) {
      console.error('‚ùå Error al actualizar el √°rea:', err);
      return res.status(500).json({ error: 'Error al actualizar el √°rea' });
    }
    if (result && result.affectedRows === 0)
{
      return res.status(404).json({ error: '√Årea no encontrada' });
    }
    res.status(200).json({ message: '‚úÖ √Årea actualizada exitosamente' });
  });
});


// // Eliminar un √°rea (DELETE)
// router.delete('/areas/:id', (req, res) => {
//     const { id } = req.params;
//     const query = 'DELETE FROM area WHERE id = ?';
//     db.query(query, [id], (err, result) => {
//         if (err) {
//             console.error('‚ùå Error al eliminar el √°rea:', err);
//             return res.status(500).json({ error: 'Error al eliminar el √°rea' });
//         }
//         if (result.affectedRows === 0) {
//             return res.status(404).json({ error: '√Årea no encontrada' });
//         }
//         res.status(200).json({ message: '‚úÖ √Årea eliminada exitosamente' });
//     });
// });

module.exports = router;

================
File: routes/asignacionesRoutes.js
================
const express = require('express');
const router = express.Router();
const db = require('../config/database');

// üîÅ Reasignar activo: cierra asignaci√≥n anterior y crea una nueva
router.post('/asignaciones', (req, res) => {
    const { activo_id, empleado_id, area_id } = req.body;

    if (!activo_id || !empleado_id || !area_id) {
        return res.status(400).json({ error: 'activo_id, empleado_id y area_id son requeridos' });
    }

    const fechaHoy = new Date().toISOString().split("T")[0];

    const query = `CALL ReasignarActivo(?, ?, ?, ?)`;

    db.query(query, [activo_id, empleado_id, area_id, fechaHoy], (err) => {
        if (err) {
            console.error("‚ùå Error al reasignar activo:", err);
            return res.status(500).json({ error: "Error al reasignar activo" });
        }

        res.status(201).json({ message: "‚úÖ Activo asignado o reasignado correctamente" });
    });
});



// üßæ Asignar empleado a un √°rea al momento de registrarlo (sin activo)
router.post('/asignaciones/empleado-area', (req, res) => {
  const { empleado_id, area_id } = req.body;

  if (!empleado_id || !area_id) {
    return res.status(400).json({ error: 'empleado_id y area_id son requeridos' });
  }

  const fechaHoy = new Date().toISOString().split("T")[0];
  const query = 'CALL AsignarEmpleadoArea(?, ?, ?)';

  db.query(query, [empleado_id, area_id, fechaHoy], (err) => {
    if (err) {
      console.error("‚ùå Error al asignar √°rea:", err);
      return res.status(500).json({ error: 'Error al asignar el √°rea al empleado' });
    }
    res.status(200).json({ message: "‚úÖ Asignaci√≥n procesada correctamente" });
  });
});


// ‚úÖ NUEVA ruta para actualizar activo_id en asignaci√≥n existente
router.put('/asignaciones/actualizar-activo', (req, res) => {
    const { empleado_id, activo_id } = req.body;

    if (!empleado_id || !activo_id) {
        return res.status(400).json({ error: 'empleado_id y activo_id son requeridos' });
    }

    const query = `CALL ActualizarActivoDeAsignacion(?, ?)`;

    db.query(query, [empleado_id, activo_id], (err, result) => {
        if (err) {
            console.error("‚ùå Error al actualizar activo_id:", err);
            return res.status(500).json({ error: 'Error al actualizar activo en la asignaci√≥n' });
        }

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'No se encontr√≥ una asignaci√≥n v√°lida para actualizar' });
        }

        res.status(200).json({ message: '‚úÖ activo_id actualizado correctamente' });
    });
});



module.exports = router;

================
File: routes/empleadoRoutes.js
================
const express = require('express');
const router = express.Router();
const db = require('../config/database');
const { requireAdmin } = require('../middleware/auth');

// Obtener todos los empleados
router.get('/empleados', (req, res) => {
    db.query('CALL sp_obtener_empleados()', (err, results) => {
        if (err) {
            console.error('‚ùå Error:', err);
            return res.status(500).json({ error: 'Error al obtener empleados' });
        }
        res.status(200).json(results[0]);
    });
});

// Obtener un empleado por ID
router.get('/empleados/:id', (req, res) => {
    const { id } = req.params;
    db.query('CALL sp_obtener_empleado_por_id(?)', [id], (err, results) => {
        if (err) {
            console.error('‚ùå Error al obtener empleado:', err);
            return res.status(500).json({ error: 'Error al obtener empleado' });
        }
        if (results[0].length === 0) {
            return res.status(404).json({ error: 'Empleado no encontrado' });
        }
        res.status(200).json(results[0][0]);
    });
});

// Crear un empleado
router.post('/empleados', requireAdmin, (req, res) => {
    const { nombre, correo, fecha_ingreso, area_id, codigo } = req.body;
    if (!nombre || !area_id || !codigo) {
        return res.status(400).json({ error: 'El nombre, c√≥digo y √°rea_id son obligatorios' });
    }
    const query = `CALL CrearEmpleadoConArea(?, ?, ?, ?, ?)`;
    const values = [
        codigo.toUpperCase(),
        nombre.toUpperCase(),
        correo || null,
        fecha_ingreso || new Date().toISOString().split('T')[0],
        area_id
    ];
    db.query(query, values, (err, result) => {
        if (err) {
            console.error('‚ùå Error al registrar empleado:', err);
            return res.status(500).json({ error: 'Error al registrar el empleado' });
        }
        const empleado_id = result[0][0].empleado_id;
        res.status(201).json({
            message: '‚úÖ Empleado y asignaci√≥n registrados correctamente.',
            empleado_id
        });
    });
});

// ‚úÖ RUTA ACTUALIZADA Y CORREGIDA PARA LA ESTRUCTURA REAL
router.put('/empleados/:id', (req, res) => {
    const { id } = req.params;
    const { nombre, correo, fecha_ingreso, area_id } = req.body;

    // 1. Actualizar datos b√°sicos en tabla 'empleado'
    const queryEmpleado = `
        UPDATE empleado 
        SET nombre = ?, correo = ?, fecha_ingreso = ? 
        WHERE id = ?
    `;

    db.query(queryEmpleado, [nombre, correo, fecha_ingreso, id], (err, result) => {
        if (err) {
            console.error("‚ùå Error al actualizar datos del empleado:", err);
            return res.status(500).json({ error: "Error al actualizar datos personales" });
        }

        // 2. Actualizar la relaci√≥n en 'activo_empleado_area'
        // Buscamos la asignaci√≥n activa (fecha_retiro IS NULL) y actualizamos el area_id
        const queryArea = `
            UPDATE activo_empleado_area 
            SET area_id = ? 
            WHERE empleado_id = ? AND fecha_retiro IS NULL
        `;

        db.query(queryArea, [area_id, id], (errArea, resultArea) => {
            if (errArea) {
                console.error("‚ùå Error al actualizar √°rea del empleado:", errArea);
                // No fallamos toda la petici√≥n, pero avisamos en consola.
                // Idealmente usar√≠amos transacciones, pero esto funciona para este caso.
            }
            
            // Si no se actualiz√≥ ninguna fila (ej: el empleado no ten√≠a asignaci√≥n),
            // podr√≠amos insertar una nueva, pero 'CrearEmpleadoConArea' garantiza que tenga una.
            
            res.json({ message: "‚úÖ Empleado y √°rea actualizados correctamente" });
        });
    });
});

module.exports = router;

================
File: routes/iaRoutes.js
================
const express = require('express');
const router = express.Router();
const OpenAI = require('openai');

// üîå CONFIGURACI√ìN DE GROQ
const openai = new OpenAI({ 
    apiKey: process.env.OPENAI_API_KEY, 
    baseURL: "https://api.groq.com/openai/v1" 
});

// üß† RUTA IA: DIAGN√ìSTICO INTELIGENTE
router.post('/sugerir-solucion', async (req, res) => {
    const { descripcion, activo_modelo } = req.body;

    if (!descripcion) {
        return res.status(400).json({ error: 'Por favor, describe el problema.' });
    }

    try {
        const completion = await openai.chat.completions.create({
            // ‚úÖ CAMBIO IMPORTANTE: Usamos el modelo nuevo (Llama 3.3)
            model: "llama-3.3-70b-versatile", 
            messages: [
                { 
                    role: "system", 
                    content: `Eres un T√©cnico Senior de Soporte TI (Nivel 3).
                    Tu trabajo es analizar fallas de equipos y dar diagn√≥sticos precisos.
                    
                    REGLAS DE RESPUESTA:
                    1. Responde SIEMPRE en formato JSON v√°lido.
                    2. El JSON debe tener esta estructura exacta:
                       {
                         "diagnostico": "Explica qu√© est√° fallando probablemente (m√°x 20 palabras)",
                         "pasos": ["Paso 1 t√©cnico", "Paso 2 t√©cnico", "Paso 3 t√©cnico"],
                         "riesgo": "bajo" o "medio" o "alto"
                       }
                    3. S√© directo y t√©cnico.` 
                },
                { 
                    role: "user", 
                    content: `Equipo: ${activo_modelo || "No especificado"}. 
                    Falla reportada: "${descripcion}". 
                    Dame el diagn√≥stico en JSON.` 
                }
            ],
            response_format: { type: "json_object" },
            temperature: 0.3
        });

        const respuestaIA = JSON.parse(completion.choices[0].message.content);
        res.json(respuestaIA);

    } catch (error) {
        console.error("‚ùå Error conectando con Groq:", error);
        res.status(500).json({ error: "El asistente virtual no pudo procesar la solicitud." });
    }
});
// ü§ñ RUTA CHATBOT GU√çA: Asistente experto en CIaMS GESTOR (Versi√≥n Corregida)
router.post('/chat-guia', async (req, res) => {
    const { mensaje } = req.body;

    if (!mensaje) return res.status(400).json({ error: 'Mensaje vac√≠o' });

    // üìñ MANUAL EXACTO DEL SISTEMA (Basado en tu descripci√≥n)
    const manualSistema = `
    Eres "CIaMS-BOT", el Asistente T√©cnico del sistema "CIaMS GESTOR".
    Tu conocimiento se basa ESTRICTAMENTE en la siguiente estructura funcional:

    1. üè† NAVEGACI√ìN Y ESTRUCTURA GENERAL:
       - **Index (Inicio)**: Contiene 4 m√≥dulos fijos: "Ver Activos", "Registrar Activos", "Registrar Incidencia" y "Registrar Empleados".
       - **Navbar**: Visible en todas las p√°ginas. Tiene accesos r√°pidos (Ver Activos, Ver Incidencias, Ver Empleados) y un bot√≥n de engranaje ‚öôÔ∏è para Configuraciones.

    2. üë• GESTI√ìN DE EMPLEADOS:
       - **Registro**: Se requieren obligatoriamente: C√≥digo (Documento de Identidad), Nombre, Correo, Selecci√≥n de √Årea (pre-cargada en BD) y Fecha de Ingreso.
       - **Gesti√≥n**: Se puede consultar la lista y modificar los datos de cualquier empleado existente.

    3. üñ•Ô∏è M√ìDULO DE ACTIVOS DISPONIBLES ("Ver Activos"):
       - **Tabla de Datos**: Muestra C√≥digo Producto (Barcode), Nombre, Marca, Modelo, Fecha Compra, Precio, Moneda, √Årea y **N¬∞ Incidencias** (conteo hist√≥rico de fallas).
       - **L√≥gica de √Årea**: ¬°Importante! El √Årea del activo cambia autom√°ticamente cuando se asigna a un empleado diferente (hereda el √°rea del empleado).
       - **Estados**:
         * "Disponible": Equipo operativo.
         * "P√©rdida": Abarca Robado, Extraviado o No Operativo.
       - **Herramientas**: Filtros (por √Årea, Estado, Asignado/No Asignado), Barra de b√∫squeda y Exportaci√≥n (PDF y XLSX).

    4. ‚ö†Ô∏è REGISTRO DE INCIDENCIAS:
       - **Flujo**:
         1. Buscas/Seleccionas el activo (lista autom√°tica).
         2. **Autom√°tico**: El sistema carga la info del activo y del empleado que lo usa actualmente.
         3. **Manual**: Debes seleccionar el "Usuario que registra" y escribir la "Descripci√≥n" (Resumen del fallo).

    5. üìã CONSULTA DE INCIDENCIAS ("Ver Incidencias"):
       - **Tabla**: Activo, √Årea, Empleado, Descripci√≥n, Fecha Reporte, Fecha Soluci√≥n, **Diagn√≥stico IA**, Estado y Acciones.
       - **Estados y Colores**:
         * üü° **Amarillo**: Pendiente de Mantenci√≥n.
         * üü¢ **Verde**: Incidencia Solucionada (Se logra pulsando el bot√≥n "Solucionar").
       - **Interacciones**:
         * Clic en Nombre Activo: Abre popup con detalles t√©cnicos del equipo.
         * Clic en "Ver m√°s" (descripci√≥n): Muestra el texto completo del reporte.
         * **Diagn√≥stico IA**: Columna que ofrece an√°lisis inteligente de la falla.
       - **Herramientas**: Filtros (√Årea, Estado), B√∫squeda y Exportaci√≥n (PDF y XLSX).

    REGLAS DE RESPUESTA:
    - S√© directo y t√©cnico.
    - Si preguntan c√≥mo cambiar el √°rea de un activo, explica que se hace reasignando al empleado.
    - Si preguntan qu√© es "P√©rdida", aclara que incluye robos o equipos inoperativos.
    `;

    try {
        const completion = await openai.chat.completions.create({
            model: "llama-3.3-70b-versatile", 
            messages: [
                { role: "system", content: manualSistema },
                { role: "user", content: mensaje }
            ],
            temperature: 0.3, 
            max_tokens: 350
        });

        const respuesta = completion.choices[0].message.content;
        res.json({ respuesta });

    } catch (error) {
        console.error("‚ùå Error Chatbot:", error);
        res.status(500).json({ error: "El asistente est√° reiniciando sus sistemas. Intenta en un momento." });
    }
});
module.exports = router;

================
File: routes/incidenciaRoutes.js
================
const express = require('express');
const router = express.Router();
const db = require('../config/database');

// Crear una nueva incidencia (POST)
router.post('/incidencias', (req, res) => {
  // 1. Recibir los 4 datos que env√≠a el frontend
  const { empleado_id, descripcion, usuario_id, activo_id } = req.body;

  // Validaci√≥n b√°sica
  if (!descripcion || !empleado_id || !activo_id) {
    return res.status(400).json({ error: 'Faltan datos obligatorios (empleado, descripci√≥n o activo)' });
  }

  // 2. Llamar al procedimiento con 4 par√°metros (?, ?, ?, ?)
  const query = `CALL CrearIncidencia(?, ?, ?, ?)`;
  
  // 3. Pasar los 4 valores en el array
  db.query(query, [empleado_id, descripcion, usuario_id, activo_id], (err, result) => {
    if (err) {
      console.error("‚ùå Error al insertar incidencia:", err);
      return res.status(500).json({ error: "Error al crear la incidencia en base de datos" });
    }

    // Obtener el ID generado (ajuste seguro para obtener el ID devuelto por el SP)
    const incidencia_id = result[0][0].incidencia_id;
    res.status(201).json({ message: "‚úÖ Incidencia creada exitosamente", id: incidencia_id });
  });
});

// Obtener incidencias activas
router.get('/incidencias', (req, res) => {
  const query = `CALL ObtenerIncidencias()`;

  db.query(query, (err, results) => {
    if (err) {
      console.error('‚ùå Error al obtener incidencias:', err.sqlMessage || err);
      return res.status(500).json({ error: 'Error al obtener incidencias' });
    }

    // Como CALL devuelve un array de arrays, el resultado √∫til est√° en results[0]
    res.status(200).json(results[0]);
  });
});

// Obtener historial completo
router.get('/incidencias/historico', (req, res) => {
  const query = `
    SELECT 
      i.id AS id,
      i.descripcion,
      DATE(i.fecha_reporte) AS fecha_reporte,
      i.estado_equipo,
      m.itemcode AS itemcode_popup,
      m.itemname AS nombre_activo,
      m.nombre_empleado,
      m.nombre_area,
      m.fin_mantenimiento
    FROM mantenimiento m
    JOIN incidencia i ON i.id = m.incidencia_id
    ORDER BY i.fecha_reporte DESC
  `;

  db.query(query, (err, results) => {
    if (err) {
      console.error('‚ùå Error al obtener incidencias hist√≥ricas:', err);
      return res.status(500).json({ error: 'Error al obtener los datos' });
    }
    res.status(200).json(results);
  });
});

module.exports = router;

================
File: routes/loginRoutes.js
================
const express = require('express');
const router = express.Router();
const db = require('../config/database');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');
const { SECRET_KEY } = require('../config/jwt');

router.post('/login', async (req, res) => {
  const { username, password } = req.body;

  if (!username || !password) {
    return res.status(400).json({ success: false, message: 'Username y contrase√±a son obligatorios' });
  }

  const query = 'CALL BuscarUsuarioPorUsername(?)';

  db.query(query, [username], async (err, results) => {
    if (err) {
      console.error('‚ùå Error al verificar usuario:', err);
      return res.status(500).json({ success: false, message: 'Error en el servidor' });
    }

    const userResults = results[0];

    if (userResults.length === 0) {
      return res.status(401).json({ success: false, message: 'Usuario o contrase√±a incorrectos' });
    }

    const user = userResults[0];
    try {
      const match = await bcrypt.compare(password, user.contrasena);
      if (!match) {
        return res.status(401).json({ success: false, message: 'Usuario o contrase√±a incorrectos' });
      }

      const token = jwt.sign(
        { id: user.id, username: user.username, isAdmin: user.administrador },
        SECRET_KEY,
        { expiresIn: '60m' }
      );

      res.json({ success: true, message: 'Login exitoso', token });

    } catch (error) {
      console.error('‚ùå Error al procesar login:', error);
      res.status(500).json({ success: false, message: 'Error en el servidor' });
    }
  });
});


router.get('/logout', (req, res) => {
    // Con JWT, el logout se maneja en el cliente eliminando el token
    res.json({ success: true, message: 'Sesi√≥n cerrada (elimine el token en el cliente)' });
});

module.exports = router;

================
File: routes/mantenimientoRoutes.js
================
const express = require('express');
const router = express.Router();
const db = require('../config/database');

// Iniciar mantenimiento
router.post('/mantenimientos/iniciar', (req, res) => {
    const { incidencia_id, init_mantenimiento } = req.body;

    if (!incidencia_id || !init_mantenimiento) {
        return res.status(400).json({ error: 'Faltan datos obligatorios para iniciar mantenimiento' });
    }

    db.query('CALL sp_iniciar_mantenimiento(?, ?)', [incidencia_id, init_mantenimiento], (err, results) => {
        if (err) {
            console.error("‚ùå Error:", err);
            return res.status(500).json({ error: err.sqlMessage || 'Error al iniciar mantenimiento' });
        }
        res.status(201).json({ message: "‚úÖ Mantenimiento iniciado" });
    });
});

// Finalizar mantenimiento

router.post('/mantenimientos/finalizar', (req, res) => {
    const { incidencia_id, fin_mantenimiento } = req.body;

    if (!incidencia_id || !fin_mantenimiento) {
        return res.status(400).json({ error: 'Faltan datos obligatorios para finalizar mantenimiento' });
    }

    db.query('CALL sp_finalizar_mantenimiento(?, ?)', [incidencia_id, fin_mantenimiento], (err, results) => {
        if (err) {
            console.error("‚ùå Error:", err);
            return res.status(500).json({ error: err.sqlMessage || 'Error al finalizar mantenimiento' });
        }
        res.status(200).json({ message: "‚úÖ Mantenimiento finalizado" });
    });
});

// Obtener historial de mantenimiento
router.get('/mantenimientos/historial', (req, res) => {
    db.query('CALL sp_historial_mantenimiento()', (err, results) => {
        if (err) {
            console.error("‚ùå Error:", err);
            return res.status(500).json({ error: 'Error al obtener el historial' });
        }
        res.status(200).json(results[0]);
    });
});

module.exports = router;

================
File: routes/usuarioRoutes.js
================
const express = require('express');
const router = express.Router();
const db = require('../config/database');
const bcrypt = require('bcrypt');

// 1. GET: Obtener todos los usuarios
router.get('/usuarios', (req, res) => {
    const query = 'SELECT id, username, correo, administrador FROM usuario';
    db.query(query, (err, results) => {
        if (err) {
            console.error('‚ùå Error al obtener usuarios:', err);
            return res.status(500).json({ error: 'Error al obtener usuarios' });
        }
        res.status(200).json(results);
    });
});

// 2. GET: Obtener usuarios no administradores
router.get('/usuarios/noadmin', (req, res) => {
    const query = 'SELECT id, username, correo, administrador FROM usuario WHERE administrador = 0';
    db.query(query, (err, results) => {
        if (err) {
            console.error('‚ùå Error al obtener usuarios no admin:', err);
            return res.status(500).json({ error: 'Error BD' });
        }
        res.status(200).json(results);
    });
});

// 3. GET: Obtener un usuario por correo
router.get('/usuarios/:correo', (req, res) => {
    const { correo } = req.params;
    db.query('CALL sp_obtener_usuario_por_correo(?)', [correo], (err, results) => {
        if (err) { return res.status(500).json({ error: 'Error BD' }); }
        if (!results[0] || results[0].length === 0) {
            return res.status(404).json({ error: 'Usuario no encontrado' });
        }
        res.status(200).json(results[0][0]);
    });
});

// 4. POST: Crear un nuevo usuario (CORREGIDO: Insert directo para evitar errores del SP)
router.post('/usuarios', async (req, res) => {
    try {
        const { username, correo, contrasena, administrador } = req.body; 

        if (!username || !correo || !contrasena) {
            return res.status(400).json({ error: 'Faltan campos obligatorios' });
        }
        
        const hashedPassword = await bcrypt.hash(contrasena, 10);
        
        // Aseguramos que sea 1 o 0
        // Acepta true, "true", 1, "1" -> 1. Todo lo dem√°s -> 0
        const esAdmin = (administrador === true || administrador === 'true' || administrador === 1 || administrador === '1') ? 1 : 0;

        // CAMBIO CLAVE: Usamos INSERT INTO directo en lugar de CALL sp_...
        // Esto garantiza que el 1 llegue a la columna 'administrador' sin intermediarios.
        const query = 'INSERT INTO usuario (username, correo, contrasena, administrador) VALUES (?, ?, ?, ?)';

        db.query(query, [username, correo, hashedPassword, esAdmin], (err, result) => {
            if (err) {
                // Manejo de error de duplicados (ej: correo ya existe)
                if (err.code === 'ER_DUP_ENTRY') {
                    return res.status(409).json({ error: 'El usuario o correo ya existe' });
                }
                console.error('‚ùå Error al registrar usuario:', err);
                return res.status(500).json({ error: 'Error al registrar usuario en BD' });
            }
            res.status(201).json({ message: 'Usuario registrado exitosamente' });
        });
    } catch (error) {
        console.error('‚ùå Error en el servidor (Hash):', error);
        res.status(500).json({ error: 'Error interno del servidor' });
    }
});

// 5. PUT: Actualizar usuario
router.put('/usuarios/:correo', (req, res) => {
    const { correo } = req.params;
    const { username, contrasena, administrador } = req.body;
    let contrasenaHashed = null; 

    const adminValue = (administrador !== undefined && administrador !== null) 
        ? (administrador === true || administrador === 'true' || administrador === 1 || administrador === '1' ? 1 : 0) 
        : null;

    const actualizar = () => {
        db.query(
            'CALL sp_actualizar_usuario_por_correo(?, ?, ?, ?)',
            [correo, username || null, contrasenaHashed, adminValue],
            (err, result) => {
                if (err) { return res.status(500).json({ error: 'Error BD' }); }
                if (result.affectedRows === 0) { return res.status(404).json({ error: 'Usuario no encontrado' }); }
                res.status(200).json({ message: 'Usuario actualizado' });
            }
        );
    };

    if (contrasena) {
        bcrypt.hash(contrasena, 10, (err, hash) => {
            if (err) return res.status(500).json({ error: 'Error hash' });
            contrasenaHashed = hash;
            actualizar();
        });
    } else {
        actualizar();
    }
});

// 6. DELETE
router.delete('/usuarios/:correo', (req, res) => {
    const { correo } = req.params;
    db.query('CALL sp_eliminar_usuario_por_correo(?)', [correo], (err, result) => {
        if (err) return res.status(500).json({ error: 'Error BD' });
        if (result.affectedRows === 0) return res.status(404).json({ error: 'Usuario no encontrado' });
        res.status(200).json({ message: 'Usuario eliminado' });
    });
});

module.exports = router;

================
File: scripts/updatePasswords.js
================
require('dotenv').config();
const mysql = require('mysql2/promise');
const bcrypt = require('bcrypt');

const dbConfig = {
    host: process.env.DB_HOST || '127.0.0.1',
    user: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || '',
    database: process.env.DB_NAME || 'gestionactivosti'
};

async function updatePasswords() {
    const connection = await mysql.createConnection(dbConfig);
    const [users] = await connection.execute('SELECT id, contrasena FROM usuario');
    
    for (const user of users) {
        const hashedPassword = await bcrypt.hash(user.contrasena, 10);
        await connection.execute('UPDATE usuario SET contrasena = ? WHERE id = ?', [hashedPassword, user.id]);
        console.log(`Contrase√±a actualizada para usuario ${user.id}`);
    }
    
    await connection.end();
    console.log('Proceso completado');
}

updatePasswords().catch(console.error);

================
File: SECURITY.md
================
# üîí Documentaci√≥n de Seguridad

## üìä Estado: 10/10

El sistema cuenta con medidas de seguridad robustas implementadas a nivel de middleware y configuraci√≥n.

## üõ°Ô∏è Medidas de Seguridad Implementadas

### 1. **Helmet.js**
- **Protecci√≥n**: Configura varios headers HTTP para prevenir ataques comunes.
- **Headers activados**:
  - `X-DNS-Prefetch-Control`
  - `X-Frame-Options` (contra clickjacking)
  - `Strict-Transport-Security` (HTTPS enforcement)
  - `X-Download-Options`
  - `X-Content-Type-Options`
  - `X-XSS-Protection` (protecci√≥n XSS en navegadores antiguos)
  - `Referrer-Policy`
- **Content Security Policy (CSP)**:
  - **Desarrollo**: Desactivado para permitir herramientas de desarrollo.
  - **Producci√≥n**: Activado con directivas restrictivas (`self`, `unsafe-inline` para scripts/estilos).
  - **Configuraci√≥n**: Se recomienda ajustar las directivas de `scriptSrc`, `styleSrc`, `imgSrc` para incluir s√≥lo dominios de confianza en producci√≥n.

### 2. **CORS (Cross-Origin Resource Sharing)**
- **Protecci√≥n**: Controla qu√© or√≠genes pueden acceder a los recursos del servidor.
- **Configuraci√≥n** (`middleware/corsConfig.js`):
  - **Desarrollo**: Permite todos los or√≠genes para facilitar el desarrollo.
  - **Producci√≥n**: Se restringe a los dominios listados en la variable de entorno `ALLOWED_ORIGINS`.
  - `credentials: true`: Permite el env√≠o de cookies (incluyendo el `authToken`).
  - `methods` y `allowedHeaders` configurados.

### 3. **Rate Limiting (express-rate-limit)**
- **Protecci√≥n**: Previene ataques de fuerza bruta y denegaci√≥n de servicio (DoS).
- **Configuraci√≥n** (`middleware/rateLimiter.js`):
  - **`generalLimiter`**: 100 solicitudes por IP cada 15 minutos (para todas las rutas).
  - **`loginLimiter`**: 5 intentos de login por IP cada 15 minutos (para `/api/login`).
  - **`createLimiter`**: 10 solicitudes de creaci√≥n por IP cada 1 minuto (para rutas POST de creaci√≥n).

### 4. **Protecci√≥n contra Poluci√≥n de Par√°metros (HPP - hpp)**
- **Protecci√≥n**: Evita que atacantes sobrescriban valores de par√°metros de la query enviando m√∫ltiples veces el mismo nombre de par√°metro (ej. `?sort=asc&sort=desc`).
- **Ubicaci√≥n**: Aplicado globalmente antes de los `body-parsers`.

### 5. **JSON Web Tokens (JWT)**
- **Protecci√≥n**: Autenticaci√≥n segura y sin estado para la API.
- **Caracter√≠sticas**:
  - **Secret Key**: Configurabilidad mediante `JWT_SECRET` en `.env` (con advertencia en desarrollo si se usa la clave por defecto).
  - **Expiraci√≥n**: Tokens con tiempo de vida limitado (`60m`).
  - **Verificaci√≥n**: Middleware `authenticateToken` verifica la validez y expiraci√≥n del token.

### 6. **Control de Acceso Basado en Roles (RBAC)**
- **Protecci√≥n**: Restringe el acceso a rutas espec√≠ficas seg√∫n el rol del usuario.
- **Middleware `requireAdmin`**: Asegura que solo los usuarios con `isAdmin: true` puedan acceder a rutas administrativas.

### 7. **Manejo Centralizado de Errores**
- **Protecci√≥n**: Oculta detalles sensibles de errores (stack traces, errores de BD) en producci√≥n.
- **Caracter√≠sticas**: Respuestas de error consistentes y seguras.

### 8. **Validaci√≥n de Variables de Entorno**
- **Protecci√≥n**: Asegura que las configuraciones de seguridad cr√≠ticas (`JWT_SECRET`, etc.) est√©n presentes al inicio de la aplicaci√≥n.
- **Advertencias**: Notifica sobre el uso de claves secretas por defecto en producci√≥n.

### 9. **Contrase√±as Hasheadas con Bcrypt**
- **Protecci√≥n**: Las contrase√±as de los usuarios se almacenan de forma segura (hash unidireccional con salt), nunca en texto plano.

## üöß Recomendaciones Adicionales para Producci√≥n

1. **HTTPS**: Implementar un certificado SSL/TLS para cifrar todas las comunicaciones (configurar Nginx/Apache).
2. **Actualizar Dependencias**: Mantener las dependencias de `package.json` actualizadas para mitigar vulnerabilidades conocidas.
3. **Auditor√≠as de Seguridad**: Realizar auditor√≠as de seguridad peri√≥dicas del c√≥digo y la infraestructura.
4. **WAF (Web Application Firewall)**: Considerar el uso de un WAF para una capa adicional de protecci√≥n.
5. **Logs de Auditor√≠a**: Mejorar el registro para incluir eventos de seguridad importantes (intentos de login fallidos, cambios de permisos, etc.).

## üìù Resumen

El proyecto ha sido reforzado con una serie de middlewares de seguridad est√°ndar de la industria. La configuraci√≥n actual es adecuada para un entorno de desarrollo seguro, y se han proporcionado las bases para una configuraci√≥n robusta en producci√≥n. Es crucial seguir las recomendaciones adicionales para un entorno de producci√≥n √≥ptimo.

================
File: server.js
================
require('dotenv').config();
const express = require('express');
const path = require('path');
const cookieParser = require('cookie-parser');
const helmet = require('helmet');
const paramProtection = require('./middleware/paramProtection');
const iaRoutes = require('./routes/iaRoutes');
// Validar variables de entorno al inicio
const validateEnv = require('./middleware/validateEnv');
validateEnv();


// Middlewares personalizados
const corsOptions = require('./middleware/corsConfig');
const cors = require('cors');
const { authenticateToken, requireAdmin } = require('./middleware/auth');
const requestLogger = require('./middleware/requestLogger');
const { generalLimiter, loginLimiter, createLimiter } = require('./middleware/rateLimiter');
const { errorHandler, notFoundHandler } = require('./middleware/errorHandler');

const app = express();
const PORT = process.env.PORT || 3000;

// Routes
const activoRoutes = require('./routes/activoRoutes');
const incidenciaRoutes = require('./routes/incidenciaRoutes');
const empleadoRoutes = require('./routes/empleadoRoutes');
const areaRoutes = require('./routes/areaRoutes');
const usuarioRoutes = require('./routes/usuarioRoutes');
const mantenimientoRoutes = require('./routes/mantenimientoRoutes');
const asignacionesRoutes = require('./routes/asignacionesRoutes');
const loginRoutes = require('./routes/loginRoutes');

// Middleware de seguridad (debe ir primero)
app.use(helmet({
    // CSP configurado para producci√≥n, desactivado en desarrollo para facilitar la integraci√≥n de herramientas como Hot Reload
    contentSecurityPolicy: process.env.NODE_ENV === 'production' ? {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net/"], // A√±adir fuentes de scripts (SweetAlert2, etc.)
            styleSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net/"], // A√±adir fuentes de estilos (Bootstrap, etc.)
            imgSrc: ["'self'", "data:", "https://*"],
            connectSrc: ["'self'", "https://cdn.jsdelivr.net", "https://cdnjs.cloudflare.com"]
        }
    } : false,
    crossOriginEmbedderPolicy: false
}));

// CORS configurado
app.use(cors(corsOptions));

// Rate limiting general
app.use(generalLimiter);

// Protecci√≥n contra poluci√≥n de par√°metros
app.use(paramProtection);

// Body parsers
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(cookieParser());

// Logging de requests
app.use(requestLogger);

// Archivos est√°ticos
app.use(express.static('public'));

// Rutas API
// Login con rate limiting estricto
app.use('/api/login', loginLimiter);
app.use('/api', loginRoutes);

// Rutas protegidas con autenticaci√≥n
app.use('/api', authenticateToken, [
    activoRoutes,
    incidenciaRoutes,
    empleadoRoutes,
    areaRoutes,
    usuarioRoutes,
    mantenimientoRoutes,
    asignacionesRoutes,
    iaRoutes
]);

// Ruta para obtener datos del usuario actual
app.get('/api/user', authenticateToken, (req, res) => {
    res.json({ user: req.user });
});

// Rutas de p√°ginas
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'login.html'));
});

app.get('/index.html', authenticateToken, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.get('/ver-activos', authenticateToken, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'ver-activos.html'));
});

app.get('/consultar-empleados', authenticateToken, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'consultar-empleados.html'));
});

app.get('/registrar-activo', authenticateToken, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'registrar-activo.html'));
});

app.get('/registrar-incidencia', authenticateToken, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'registrar-incidencia.html'));
});

app.get('/incidencias.html', authenticateToken, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'consultar-incidencias.html'));
});

app.get('/registrar-empleado', authenticateToken, requireAdmin, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'registrar-empleado.html'));
});

app.get('/registrar-usuario', authenticateToken, requireAdmin, (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'registrar-usuario.html'));
});

// Manejo de errores (debe ir al final, despu√©s de todas las rutas)

app.use(notFoundHandler);
app.use(errorHandler);

// Iniciar el servidor
app.listen(PORT, () => {
    console.log(`üöÄ Servidor corriendo en el puerto ${PORT}`);
    console.log(`üìä Entorno: ${process.env.NODE_ENV || 'development'}`);
});

================
File: utils/dbErrorHandler.js
================
/**
 * Utilidades para manejar errores de MySQL
 */

/**
 * Convierte errores de MySQL a errores de la aplicaci√≥n
 */
const handleDatabaseError = (error, defaultMessage = 'Error de base de datos') => {

    if (!error) return null;

    // Errores de clave duplicada
    if (error.code === 'ER_DUP_ENTRY') {
        const match = error.sqlMessage.match(/Duplicate entry '(.+?)' for key '(.+?)'/);
        const field = match ? match[2] : 'campo';
        return {
            statusCode: 409,
            message: `El ${field} ya existe`,
            isConflict: true
        };
    }

    // Error de foreign key constraint
    if (error.code === 'ER_NO_REFERENCED_ROW_2' || error.code === 'ER_ROW_IS_REFERENCED_2') {
        return {
            statusCode: 400,
            message: 'No se puede realizar la operaci√≥n debido a referencias en otras tablas',
            isConstraint: true
        };
    }

    // Error de campo no puede ser nulo
    if (error.code === 'ER_BAD_NULL_ERROR') {
        return {
            statusCode: 400,
            message: 'Faltan campos obligatorios',
            isValidation: true
        };
    }

    // Error de datos truncados
    if (error.code === 'ER_DATA_TOO_LONG') {
        return {
            statusCode: 400,
            message: 'Los datos exceden el tama√±o m√°ximo permitido',
            isValidation: true
        };
    }

    // Error gen√©rico de base de datos
    return {
        statusCode: 500,
        message: defaultMessage,
        isDatabase: true
    };
};

/**
 * Wrapper para queries de base de datos que maneja errores
 */
const handleQuery = (query, params = []) => {
    return new Promise((resolve, reject) => {
        const db = require('../config/database');
        db.query(query, params, (err, results) => {
            if (err) {
                const errorInfo = handleDatabaseError(err);
                const error = new Error(errorInfo.message);
                error.statusCode = errorInfo.statusCode;
                error.isDatabase = true;
                error.originalError = err;
                reject(error);
            } else {
                resolve(results);
            }
        });
    });
};

module.exports = {
    handleDatabaseError,
    handleQuery
};

================
File: utils/errors.js
================
/**
 * Clases de errores personalizadas
 */

/**
 * Error personalizado base
 */
class AppError extends Error {
    constructor(message, statusCode = 500) {
        super(message);
        this.statusCode = statusCode;
        this.status = `${statusCode}`.startsWith('4') ? 'fail' : 'error';
        this.isOperational = true;

        Error.captureStackTrace(this, this.constructor);
    }
}

/**
 * Error de validaci√≥n (400)
 */
class ValidationError extends AppError {
    constructor(message, details = null) {
        super(message, 400);
        this.name = 'ValidationError';
        this.details = details;
    }
}

/**
 * Error de autenticaci√≥n (401)
 */
class AuthenticationError extends AppError {
    constructor(message = 'No autorizado') {
        super(message, 401);
        this.name = 'AuthenticationError';
    }
}

/**
 * Error de autorizaci√≥n (403)
 */
class AuthorizationError extends AppError {
    constructor(message = 'Acceso denegado') {
        super(message, 403);
        this.name = 'AuthorizationError';
    }
}

/**
 * Error de recurso no encontrado (404)
 */
class NotFoundError extends AppError {
    constructor(resource = 'Recurso') {
        super(`${resource} no encontrado`, 404);
        this.name = 'NotFoundError';
    }
}

/**
 * Error de conflicto (409)
 */
class ConflictError extends AppError {
    constructor(message = 'Conflicto en la solicitud') {
        super(message, 409);
        this.name = 'ConflictError';
    }
}

/**
 * Error de base de datos
 */
class DatabaseError extends AppError {
    constructor(message, originalError = null) {
        super(message || 'Error de base de datos', 500);
        this.name = 'DatabaseError';
        this.originalError = originalError;
    }
}

module.exports = {
    AppError,
    ValidationError,
    AuthenticationError,
    AuthorizationError,
    NotFoundError,
    ConflictError,
    DatabaseError
};
